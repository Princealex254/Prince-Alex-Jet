<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Jet</title>
    <!-- Updated Font: Inter for general text, Orbitron for headings/numbers -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;700&family=Poppins:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for WhatsApp icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- CryptoJS for provably fair model -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* General Styling */
        :root {
            --primary-color: #1a1a1a; /* deep charcoal */
            --secondary-color: #242424;
            --accent-color: #E39A4B; /* gold */
            --danger-color: #ff4757;
            --success-color: #2ecc71;
            --text-color: #ffffff;
            --bg-color: #0c0c0c; /* black */
            --font-family-body: 'Poppins', 'Inter', sans-serif;
            --font-family-display: 'Space Grotesk', 'Orbitron', sans-serif;
            --dark-gold: #c57f33;
            --light-gold: #f5c38a;
            --graph-line-color: #E39A4B;
            --graph-fill-color-top: rgba(227, 154, 75, 0.22);
            --graph-fill-color-bottom: rgba(227, 154, 75, 0);
            --tab-bg-active: rgba(227, 154, 75, 0.1);
            --tab-bg-inactive: rgba(255, 255, 255, 0.05);
            --tab-border-active: var(--accent-color);
            --tab-border-inactive: rgba(255, 255, 255, 0.1);
            --table-header-bg: rgba(227, 154, 75, 0.1);
            --table-row-odd: rgba(255, 255, 255, 0.03);
            --table-row-even: rgba(255, 255, 255, 0.05);
            --table-row-highlight: rgba(227, 154, 75, 0.15);
            --purple-color: #8A2BE2;
            --modal-bg-gradient-start: #1a1a2e;
            --modal-bg-gradient-end: #16213e;
            --modal-border-color: var(--accent-color);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --jet-gradient: linear-gradient(135deg, #f5c38a, #E39A4B, #c57f33);
            --shadow-glow: 0 0 20px rgba(227, 154, 75, 0.4);
        }

        /* Light Theme Variables */
        body.light-theme {
            --primary-color: #bbdefb;
            --secondary-color: #f0f0f0;
            --accent-color: #ff9800;
            --danger-color: #ef5350;
            --success-color: #66bb6a;
            --text-color: #212121;
            --bg-color: #e0f2f7;
            --dark-green: #81c784;
            --light-green: #a5d6a7;
            --graph-line-color: #FF5722; /* Orange-red for light theme */
            --graph-fill-color-top: rgba(227, 154, 75, 0.4);
            --graph-fill-color-bottom: rgba(227, 154, 75, 0.05);
            --tab-bg-active: #bbdefb;
            --tab-bg-inactive: #e0e0e0;
            --tab-border-active: var(--accent-color);
            --tab-border-inactive: #e3f2fd;
            --table-header-bg: #e3f2fd;
            --table-row-odd: #e3f2fd;
            --table-row-even: #bbdefb;
            --table-row-highlight: #90caf9;
            --purple-color: #9c27b0;
            --modal-bg-gradient-start: #a5d6a7;
            --modal-bg-gradient-end: #e3f2fd;
            --modal-border-color: var(--success-color);
        }

        body {
            margin: 0;
            font-family: var(--font-family-body);
            background: 
                radial-gradient(circle at 20% 50%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(227, 154, 75, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(138, 43, 226, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-color) 0%, #111 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 30%, rgba(227, 154, 75, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 70% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 30%);
            pointer-events: none;
            z-index: -1;
        }

        body.modal-open {
            overflow: hidden; /* Disable scroll when modal is open */
        }

        /* Elements using display font */
        h1, .site-logo, #multiplier-display-overlay, #countdown-timer-overlay, #busted-text-overlay,
        .info-box p, .button, input[type="number"] {
            font-family: var(--font-family-display);
        }

        /* Top Bar Styling */
        .top-bar {
            width: 100%;
            background-color: var(--tab-bg-inactive); /* Use theme variable */
            padding: 10px 20px;
            display: flex;
            justify-content: space-between; /* Distribute items */
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
            gap: 10px;
            position: relative; /* For dropdown positioning */
            transition: background-color 0.5s ease;
        }

        .top-bar-left, .top-bar-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .site-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light-gold);
            text-shadow: 0 0 5px var(--accent-color);
            white-space: nowrap;
        }

        .top-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-size: 0.85rem;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        .top-button:hover {
            background-color: var(--primary-color); /* Adjusted for theme */
        }

        .balance-info {
            font-size: 0.9rem;
            color: var(--text-color);
            white-space: nowrap;
        }

        /* Account Dropdown Styles */
        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 20px;
            background-color: var(--tab-bg-active); /* Use theme variable */
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            min-width: 200px;
            z-index: 101;
            display: none;
            flex-direction: column;
            padding: 10px 0;
            margin-top: 5px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .account-dropdown.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
            text-align: center;
        }

        .dropdown-item {
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .dropdown-item i {
            font-size: 1.1rem;
            color: var(--secondary-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
            font-weight: 700;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }
        .dropdown-item.logout i {
            color: var(--danger-color);
        }

        /* Theme Toggle Button */
        #theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 5px;
            transition: color 0.3s ease;
        }
        #theme-toggle:hover {
            color: var(--accent-color);
        }

        /* Top Promotional Banner */
        .top-banner {
            width: 100%;
            background: linear-gradient(90deg, var(--dark-gold), var(--tab-bg-inactive)); /* Use theme variables */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--light-green);
            padding: 15px 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            text-align: left;
            gap: 15px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .promo-image-container {
            flex-shrink: 0;
        }

        .promo-image {
            width: 120px;
            height: auto;
            border-radius: 10px;
            object-fit: cover;
        }

        .promo-text-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .promo-content {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .promo-button {
            background-color: var(--light-gold);
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }

        .promo-button:hover {
            background-color: #ffda47;
            transform: translateY(-2px);
        }

        /* Main Content Area (Game + Sidebar) */
        .main-content-area {
            display: flex;
            width: 95%;
            max-width: 1600px;
            gap: 20px;
            justify-content: center;
            align-items: flex-start; /* Changed from stretch */
            flex-wrap: nowrap; 
        }

        .game-column {
            flex: 3; /* Make the game column take up more space */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .game-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 255, 136, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 16px;
            display: grid; /* Re-establish grid layout */
            grid-template-areas: "game" "message" "controls"; /* Define grid areas */
            grid-template-rows: auto min-content auto; /* Define row sizes */
            gap: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(227, 154, 75, 0.05) 0%, 
                transparent 50%, 
                rgba(138, 43, 226, 0.05) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .game-container > * {
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--light-gold);
            text-shadow: 0 0 10px var(--accent-color);
            margin: 0;
        }

        /* New Game History Bar Styling */
        #crash-history-container {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* To contain the scrolling div */
            border: 1px solid var(--glass-border);
            margin-bottom: 16px; /* Space between history and game screen */
        }

        #crash-history-display {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 8px; /* Space for scrollbar */
            /* Hide scrollbar by default, but keep functionality */
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        /* Webkit scrollbar styling */
        #crash-history-display::-webkit-scrollbar {
            height: 4px;
        }

        #crash-history-display::-webkit-scrollbar-track {
            background: transparent;
        }

        #crash-history-display::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 20px;
            border: 3px solid transparent;
        }

        #crash-history-display:hover::-webkit-scrollbar-thumb {
            background-color: var(--light-gold);
        }

        #crash-history-display {
            flex-wrap: nowrap; /* Prevent items from wrapping to the next line */
            justify-content: flex-start; /* Align items to the start (left) */
            overflow-x: auto; /* Enable horizontal scrolling only when needed */
            overflow-y: hidden; /* Disable vertical scrolling */
        }

        @media (max-width: 768px) {
            #crash-history-display {
                flex-wrap: nowrap; /* Prevent wrapping on mobile */
            }
        }
        #crash-history-display .crash-green,
        #crash-history-display .crash-red,
        #crash-history-display .crash-purple {
            padding: 4px 8px;
            border-radius: 4px; /* Rectangular chip */
            font-weight: 700;
            font-family: var(--font-family-display);
            font-size: 0.8rem;
            white-space: nowrap;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
            background-color: #27ae60; /* Green for high mult */
            color: #fff;
        }

        #crash-history-display .crash-red {
            background-color: #c0392b; /* Red for low mult */
            color: #fff;
        }

        #crash-history-display .crash-purple {
            background-color: var(--purple-color); /* Purple for mid-high */
            color: #fff;
        }

        /* Newest crash indicator */
        #crash-history-display .crash-newest {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            animation: newestPulse 2s ease-in-out;
        }

        @keyframes newestPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            }
        }


        /* Game Screen */
        .game-screen {
            grid-area: game;
            position: relative;
            height: 500px;
            background: var(--bg-color); /* Base dark background */
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(0, 255, 136, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .game-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-conic-gradient(
                from 45deg at 50% 0%, 
                rgba(227, 154, 75, 0.1) 0deg 0.5deg, 
                transparent 1deg 20deg
            );
            z-index: 0;
            pointer-events: none; /* Ensure it doesn't block clicks */
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: transparent;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
            z-index: 20; /* Above other overlays */
            border-radius: 20px; /* Match parent container */
        }

        #multiplier-display-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 90px; /* Large bold font */
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 0.5),
                0 0 40px var(--accent-color);
            z-index: 10;
            display: none;
            font-family: var(--font-family-display);
            animation: multiplierPulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }
        
        @keyframes multiplierPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
            }
        }

        #countdown-timer-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            font-weight: 700;
            color: var(--light-gold);
            text-shadow: 
                0 0 20px var(--accent-color),
                0 0 40px var(--accent-color);
            z-index: 11;
            display: none;
            font-family: var(--font-family-display);
            animation: countdownPulse 1s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.7));
        }
        
        @keyframes countdownPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        #busted-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 700;
            color: var(--danger-color);
            text-shadow: 
                0 0 20px rgba(255, 0, 0, 0.8),
                0 0 40px var(--danger-color),
                0 0 60px var(--danger-color);
            z-index: 12;
            display: none;
            white-space: nowrap;
            font-family: var(--font-family-display);
            animation: bustedShake 0.5s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.7));
        }
        
        @keyframes bustedShake {
            0%, 100% { 
                transform: translate(-50%, -50%) rotate(0deg);
            }
            25% { 
                transform: translate(-50%, -50%) rotate(-2deg);
            }
            75% { 
                transform: translate(-50%, -50%) rotate(2deg);
            }
        }
        
        @keyframes boom {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Controls */
        .controls {
            grid-area: controls;
            display: flex;
            justify-content: center; /* Center the single betting module */
            gap: 20px;
            align-items: start;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(227, 154, 75, 0.03) 0%, 
                transparent 50%, 
                rgba(138, 43, 226, 0.03) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .controls > * {
            position: relative;
            z-index: 1;
        }

        /* Compact Modern Footer */
        .compact-footer {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            margin-top: 30px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .compact-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(227, 154, 75, 0.03) 0%, 
                transparent 50%, 
                rgba(138, 43, 226, 0.03) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .footer-main {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .footer-brand h3 {
            color: var(--light-gold);
            font-size: 1.3rem;
            margin: 0 0 5px 0;
            font-family: var(--font-family-display);
            font-weight: 700;
        }

        .footer-brand p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin: 0;
            font-weight: 400;
        }

        .footer-links {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 5px 0;
        }

        .footer-links a:hover {
            color: var(--light-gold);
            transform: translateY(-1px);
        }

        .footer-contact {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .footer-contact a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 5px 0;
        }

        .footer-contact a:hover {
            color: var(--light-gold);
            transform: translateY(-1px);
        }

        .footer-bottom {
            max-width: 1200px;
            margin: 15px auto 0;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .footer-bottom p {
            color: rgba(255, 255, 255, 0.6);
            margin: 0 0 5px 0;
            font-size: 0.8rem;
        }

        .disclaimer {
            color: var(--warning-color) !important;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .control-panel {
            background-color: rgba(13, 71, 161, 0.3); /* Keep specific for now */
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: background-color 0.5s ease;
        }
        
        .betting-module {
            flex: 1;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid var(--glass-border);
        }

        .bet-mode-tabs {
            display: flex;
            background: var(--primary-color);
            border-radius: 8px;
            padding: 4px;
        }

        .bet-mode-tab {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .bet-mode-tab.active {
            background: var(--accent-color);
            color: #000;
        }

        .amount-input-group {
            display: flex;
            align-items: center;
            background: var(--primary-color);
            border-radius: 8px;
        }

        .amount-adjust-btn {
            background: transparent;
            border: none;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0 15px;
            cursor: pointer;
        }

        .amount-input-group input {
            text-align: center;
            border: none;
            background: transparent;
            font-size: 1.4rem;
            padding: 8px 0;
        }

        .main-action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
        }

        label {
            font-size: 1rem;
            color: var(--light-gold);
            font-family: var(--font-family-body);
        }

        input[type="number"], input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            color: var(--text-color);
            font-family: var(--font-family-display);
            font-size: 1.2rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        input[type="number"].input-error,
        input[type="text"].input-error,
        input[type="password"].input-error {
            border-color: var(--danger-color);
        }

        .button {
            padding: 16px 24px;
            font-size: 1.5rem;
            font-family: var(--font-family-display);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            background: var(--accent-color);
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .button:hover::before {
            left: 100%;
        }

        #bet-button {
            background-color: var(--accent-color);
            color: #000;
        }

        #bet-button:hover {
            background-color: var(--light-gold);
            box-shadow: 0 6px 20px var(--shadow-glow);
        }
        
        #cashout-button {
            background-color: var(--success-color);
            color: var(--text-color);
        }
        
        #cashout-button:hover {
            background-color: #27ae60;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        #cashout-button:disabled,
        #bet-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Quick Bet Buttons */
        .bet-quick-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-bet-button {
            padding: 8px 12px;
            font-size: 1rem;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            flex-grow: 1;
            max-width: 80px;
            font-family: var(--font-family-body);
        }

        .quick-bet-button:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .quick-bet-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Auto Cashout / Auto Bet Toggles */
        .auto-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .auto-options label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: var(--text-color);
            font-family: var(--font-family-body);
        }

        .auto-options .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .auto-options .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .auto-options .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .auto-options .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .auto-options input:checked + .slider {
            background-color: var(--success-color);
        }

        .auto-options input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }

        .auto-options input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        #message-display {
            text-align: center;
            grid-area: message; /* Assign to grid area */
            font-size: 1.2rem;
            min-height: 25px;
            padding-top: 10px;
            font-family: var(--font-family-body);
        }

        /* Player History Container (now part of tabs) */
        #player-history-container {
            display: none;
            background-color: rgba(13, 71, 161, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
            width: 100%;
            box-sizing: border-box;
            margin-top: 0;
        }

        #player-history-container h3 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 1.2rem;
            text-align: center;
            font-family: var(--font-family-body);
        }

        #player-history-display {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            align-items: center;
            gap: 10px;
            font-family: var(--font-family-body);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item span {
            flex-shrink: 0;
        }

        .history-item .ticket-id {
            font-weight: 700;
            color: var(--secondary-color);
            min-width: 80px;
            text-align: left;
        }

        .history-item .bet-amount {
            color: var(--text-color);
            min-width: 60px;
            text-align: right;
        }

        .history-item .multiplier-info {
            flex-grow: 1;
            text-align: center;
        }

        .history-item .status {
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        .history-item .winnings {
            font-weight: 700;
            min-width: 60px;
            text-align: center;
        }

        .status-win {
            color: var(--success-color);
        }

        .status-loss {
            color: var(--danger-color);
        }

        .winnings-win {
            color: var(--success-color);
        }

        .winnings-loss {
            color: var(--danger-color);
        }

        /* Enhanced Cashout Button */
        .cashout-button {
            position: relative;
            min-height: 80px;
            display: none; /* Hidden by default, shown when bet is placed */
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--success-color), var(--dark-green));
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .cashout-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 30px rgba(0, 255, 136, 0.4),
                0 0 0 2px rgba(0, 255, 136, 0.3);
        }

        .cashout-button:disabled {
            background: linear-gradient(135deg, #666, #444);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .cashout-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }

        .cashout-label {
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cashout-amount {
            font-size: 1.8rem;
            font-weight: 900;
            font-family: var(--font-family-display);
            color: #fff;
        }

        @keyframes multiplierPulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }
            50% { 
                transform: scale(1.05);
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            }
        }

        /* Cashout button when enabled */
        .cashout-button:not(:disabled) {
            background: linear-gradient(135deg, #00ff88, #00d4aa, #00a8ff);
            background-size: 200% 200%;
            animation: cashoutGradient 2s ease infinite;
        }

        @keyframes cashoutGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        /* Right Sidebar (Chat/History) */
        .right-sidebar {
            flex: 1;
            min-width: 300px;
            max-width: 320px;
            background: var(--primary-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.1);
            border: 2px solid var(--secondary-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 600px;
            box-sizing: border-box;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light-gold);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
            font-family: var(--font-family-body);
        }

        /* New: Game Data Sections (Tabs) */
        .game-data-sections {
            flex: 1; /* Make the data sections column take up less space */
            max-width: 320px; /* Set a max-width for the sidebar */
            background: var(--primary-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.1);
            border: 1px solid var(--secondary-color);
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .online-users-info {
            text-align: center;
            font-size: 1rem;
            color: var(--light-gold);
            margin-bottom: 10px;
        }

        .tab-buttons {
            display: flex;
            width: 100%;
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-button {
            flex: 1;
            padding: 12px 0;
            background-color: var(--tab-bg-inactive);
            color: var(--text-color);
            border: none;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            z-index: 1;
            margin-bottom: -2px; /* Overlap border */
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            background-color: var(--tab-bg-active);
        }

        .tab-button.active {
            background-color: var(--tab-bg-active);
            color: var(--light-gold);
            border-bottom: 2px solid var(--tab-border-active);
            z-index: 2;
        }

        .tab-content {
            padding-top: 15px;
            min-height: 250px; /* Ensure content area has some height */
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Players Table Styling */
        .players-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        .players-table th, .players-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .players-table th {
            background-color: var(--table-header-bg);
            color: var(--light-gold);
            font-weight: 700;
            text-transform: uppercase;
        }

        .players-table tr:nth-child(odd) {
            background-color: var(--table-row-odd);
        }

        .players-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .players-table tr.highlighted-player {
            background-color: var(--table-row-highlight);
            color: var(--text-color);
            font-weight: bold;
        }

        .players-table .player-avatar {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 0.8em;
            text-align: center;
            margin-right: 5px;
            vertical-align: middle;
        }

        .players-table .amount-cell, .players-table .cashout-cell, .players-table .won-cell {
            text-align: right;
            white-space: nowrap;
        }

        .players-table .cashout-cell.cashed-out {
            color: var(--success-color);
            font-weight: bold;
        }

        .players-table .cashout-cell.busted {
            color: var(--danger-color);
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        .leaderboard-table th, .leaderboard-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            background-color: var(--table-header-bg);
            color: var(--light-gold);
            font-weight: 700;
            text-transform: uppercase;
        }

        .leaderboard-table tr:nth-child(odd) {
            background-color: var(--table-row-odd);
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .leaderboard-table .rank-cell {
            font-weight: bold;
            color: var(--light-gold);
            text-align: center;
        }

        .leaderboard-table .multiplier-cell, .leaderboard-table .winnings-cell {
            text-align: right;
            font-weight: bold;
        }

        /* History Tab specific styles (re-using crash-history-container styles) */
        #history-tab-content {
            padding: 10px;
            background-color: rgba(13, 71, 161, 0.3);
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
            max-height: 250px;
            overflow-y: auto;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        #history-tab-content h3 {
            margin: 0 0 10px 0;
            color: var(--light-gold);
            font-size: 1.2rem;
            text-align: center;
            font-family: var(--font-family-body);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 50, 0, 0.3));
            backdrop-filter: blur(15px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: all 0.3s ease;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: scale(1);
            }
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            margin: auto;
            padding: 0;
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 255, 136, 0.1),
                inset 0 1px 0 rgba(227, 154, 75, 0.2);
            position: relative;
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(227, 154, 75, 0.05) 0%, 
                transparent 50%, 
                rgba(138, 43, 226, 0.05) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .modal-content > * {
            position: relative;
            z-index: 1;
        }

        .modal.show .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--light-gold), var(--accent-color));
            padding: 25px 30px 20px;
            text-align: center;
            position: relative;
            color: #000;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        /* Message displays */
        .modal-message-display {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-message-display.is-error {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.15), rgba(200, 0, 0, 0.1));
            color: #ff4444;
            border: 2px solid rgba(255, 68, 68, 0.3);
            display: block;
        }
        .modal-message-display.is-success {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.15), rgba(0, 200, 0, 0.1));
            color: #00ff00;
            border: 2px solid rgba(0, 255, 0, 0.3);
            display: block;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .modal-tab-button {
            flex: 1;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border: none;
            color: var(--text-color);
            font-family: var(--font-family-body);
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .modal-tab-button.active {
            background-color: rgba(0,0,0,0.4);
            font-weight: bold;
            color: var(--light-gold);
        }

        .modal-tab-content {
            padding-top: 15px;
        }

        .modal-tab-pane {
            display: none;
        }

        .modal-tab-pane.active {
            display: block;
        }

        .modal-balance-info {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 15px;
        }

        .balance-box {
            background-color: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-box span {
            display: block;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        .balance-box p {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0 0;
            color: var(--text-color);
        }

        .modal-input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-input-group input[type="number"], 
        .modal-input-group input[type="text"], 
        .modal-input-group input[type="password"] {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid transparent;
            border-radius: 12px;
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .modal-input-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: linear-gradient(145deg, #2f2f2f, #242424);
            box-shadow: 
                0 0 0 3px rgba(0, 255, 0, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        .modal-input-group input.input-error {
            border-color: #ff4444;
            background: linear-gradient(145deg, #3f2a2a, #2f1f1f);
            box-shadow: 
                0 0 0 3px rgba(255, 68, 68, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .modal-input-group input::placeholder {
            color: #888;
            font-style: italic;
        }

        .modal-button {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--light-gold), var(--accent-color));
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-glow);
        }

        .modal-button:hover {
            background: linear-gradient(135deg, var(--accent-color), var(--dark-gold));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.4);
        }

        .modal-button:active {
            transform: translateY(0);
        }

        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-row {
            display: flex;
            align-items: center;
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border: 2px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .input-row:focus-within {
            border-color: var(--accent-color);
            background: linear-gradient(145deg, #2f2f2f, #242424);
            box-shadow: 
                0 0 0 3px rgba(0, 255, 0, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        .input-prefix {
            padding: 16px 12px;
            background: linear-gradient(145deg, #333, #222);
            color: var(--light-gold);
            font-weight: 600;
            font-size: 16px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 60px;
            text-align: center;
        }

        .input-row input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 16px 20px;
            color: #fff;
            font-size: 16px;
            box-shadow: none;
        }

        .input-row input:focus {
            outline: none;
            border: none;
            background: transparent;
            box-shadow: none;
            transform: none;
        }

        .input-addon {
            padding: 16px 20px;
            background: linear-gradient(145deg, #333, #222);
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-addon:hover {
            color: var(--light-gold);
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
        }

        .input-help {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
            font-style: italic;
        }

        .modal-actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-inline input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .modal-link {
            color: var(--light-gold);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }

        .modal-link:hover {
            color: var(--accent-color);
            text-decoration: none;
        }

        .modal-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 0;
            background: var(--light-gold);
            transition: all 0.3s ease;
        }

        .modal-link:hover::after {
            width: 100%;
        }

        .modal-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(227, 154, 75, 0.2);
            color: #888;
            font-size: 14px;
        }

        .modal-footer a {
            color: var(--light-gold);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-footer a:hover {
            color: var(--accent-color);
        }

        .modal-instructions {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.3), rgba(0, 50, 0, 0.1));
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 0, 0.2);
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-instructions p {
            margin: 0 0 8px 0;
        }

        .modal-instructions strong {
            color: var(--light-gold);
        }

        .modal-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 16px;
            }
            
            .site-logo {
                width: 100%;
                text-align: center;
                font-size: 1.5rem;
            }
            
            .top-bar-left, .top-bar-center {
                width: 100%;
                justify-content: center;
            }
            
            .main-content-area {
                flex-direction: column; /* Show game screen first on mobile */
                align-items: stretch;
                gap: 16px;
            }
            
            .game-container, .right-sidebar, .game-data-sections, .top-banner {
                min-width: unset;
                width: 100%;
                margin: 8px 0;
                padding: 16px;
            }

            .game-container {
                order: 1; /* Show game first */
            }
            .game-data-sections {
                order: 2; /* Show data sections after game */
            }

            .game-panels-grid {
                grid-template-columns: 1fr;
            }
            
            .promo-image-container {
                display: none;
            }
            
            .promo-text-content {
                align-items: center;
                text-align: center;
            }
            
            .controls {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }
            
            .chat-messages {
                font-size: 0.8rem;
            }

            .game-screen {
                height: 300px;
                border-radius: 16px;
            }

            .button {
                padding: 12px 20px;
                font-size: 1.2rem;
            }

            #multiplier-display-overlay {
                font-size: 2.5rem;
            }

            #countdown-timer-overlay {
                font-size: 3.5rem;
            }

            #busted-text-overlay {
                font-size: 1.5rem;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 0.9rem;
            }

            .control-panel {
                padding: 12px;
            }

            .input-row {
                flex-direction: column;
                gap: 8px;
            }

            .input-prefix {
                width: 100%;
                text-align: center;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 12px;
                margin: 4px 0;
            }

            .game-screen {
                height: 35vh; /* Adjust for very small screens */
            }

            .button {
                padding: 10px 16px;
                font-size: 1rem;
            }

            #multiplier-display-overlay {
                font-size: 2rem;
            }

            #countdown-timer-overlay {
                font-size: 2.5rem;
            }

            .tab-button {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .controls {
                padding: 12px;
                gap: 12px;
            }

            .compact-footer {
                padding: 15px 10px;
            }

            .footer-main {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .footer-links {
                justify-content: center;
                gap: 20px;
            }

            .footer-contact {
                justify-content: center;
                gap: 15px;
            }

            .footer-brand h3 {
                font-size: 1.2rem;
            }

            .footer-brand p {
                font-size: 0.8rem;
            }

            .cashout-button {
                min-height: 60px;
            }

            .cashout-multiplier {
                font-size: 1.4rem;
            }

            .cashout-amount {
                font-size: 1rem;
            }
        }

        /* Tooltip container */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position the tooltip above the text */
            left: 50%;
            margin-left: -100px; /* Use half of the width to center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-family: var(--font-family-body);
            font-size: 0.8rem;
        }

        /* Tooltip arrow */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Show the tooltip text when you hover over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* General button styling for inputs */
        .input-with-button {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .input-with-button input {
            flex-grow: 1;
            margin-bottom: 0; /* Override default input margin */
        }

        .input-with-button .clear-button {
            background-color: var(--danger-color);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            height: fit-content;
        }

        .input-with-button .clear-button:hover {
            background-color: #ef5350;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .auth-buttons .button {
            flex: 1;
            font-size: 1.1rem;
            padding: 10px;
        }
        #signupModal .modal-input-group,
        #loginModal .modal-input-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <span class="site-logo">Aviator VIP</span>
        </div>
        <div class="top-bar-center">
            <button class="top-button" id="auth-button">Login / Sign Up</button>
            <span class="balance-info" id="top-bar-balance" style="display:none;">1000.00 KES</span>
            <!-- New: Account Dropdown -->
            <div class="account-dropdown" id="account-dropdown">
                <div class="dropdown-header" id="dropdown-user-info"></div>
                <a href="#" class="dropdown-item" id="dropdown-deposit-withdraw" title="Manage your deposits and withdrawals">
                    <i class="fas fa-wallet"></i> Deposit / Withdraw
                </a>
                <a href="#" class="dropdown-item" id="dropdown-change-password" title="Change your account password">
                    <i class="fas fa-key"></i> Change Password
                </a>
                <a href="#" class="dropdown-item" id="dropdown-how-to-play" title="Learn how to play the game">
                    <i class="fas fa-question-circle"></i> How To Play
                </a>
                <a href="#" class="dropdown-item logout" id="dropdown-logout" title="Log out of your account">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
            <button id="theme-toggle" title="Toggle Dark/Light Theme">
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </div>

    <div class="main-content-area">
        <!-- Left Column for Bet History -->
        <div class="game-data-sections">
            <div class="online-users-info">
                Online Users: <span id="online-users-count">90</span> | Playing: <span id="playing-users-count">31</span>
            </div>
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="players">Players</button>
                <button class="tab-button" data-tab="my-bets">My Bets</button>
                <button class="tab-button" data-tab="leaderboard">Leaderboard</button>
            </div>
            <div class="tab-content">
                <!-- Players Tab Content -->
                <div id="players-tab-pane" class="tab-pane active">
                    <table class="players-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th class="amount-cell">Amount</th>
                                <th class="cashout-cell">Cashout</th>
                                <th class="won-cell">Won (KES)</th>
                            </tr>
                        </thead>
                        <tbody id="players-table-body">
                            <!-- Player rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- My Bets Tab Content -->
                <div id="my-bets-tab-pane" class="tab-pane">
                    <div id="player-history-container-tab">
                        <h3>Your Bet History</h3>
                        <div id="player-history-display-tab">
                            <div class="history-item header-row" style="font-weight: bold; border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <span class="ticket-id">Ticket ID</span>
                                <span class="bet-amount">Bet Amount</span>
                                <span class="multiplier-info">Multiplier</span>
                                <span class="winnings">Winnings</span>
                                <span class="status">Status</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Tab Content -->
                <div id="leaderboard-tab-pane" class="tab-pane">
                    <h3>Top Crashers (Highest Multiplier)</h3>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="rank-cell">Rank</th>
                                <th>Player</th>
                                <th class="multiplier-cell">Multiplier</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-multiplier-body">
                            <!-- Top Multiplier leaders will be dynamically inserted here -->
                        </tbody>
                    </table>

                    <h3 style="margin-top: 20px;">Top Earners (Total Winnings)</h3>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="rank-cell">Rank</th>
                                <th>Player</th>
                                <th class="winnings-cell">Winnings (KES)</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-winnings-body">
                            <!-- Top Winnings leaders will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="game-column"> <!-- Renamed for clarity -->
            <!-- Game History Bar -->
            <div id="crash-history-container">
                <div id="crash-history-display"></div>
            </div>
            <div class="game-container">
                <div class="game-screen" id="game-screen">
                    <canvas id="game-canvas"></canvas>
                    <canvas id="confetti-canvas"></canvas> <!-- Confetti Canvas -->
                    <div id="multiplier-display-overlay">1.00x</div>
                    <div id="countdown-timer-overlay">10</div>
                    <div id="busted-text-overlay"></div>
                    <div id="game-status-overlay"></div> <!-- New overlay for game status messages -->
                </div>

                <div id="message-display">Watch the game! Login to place bets.</div>

                <div class="controls">
                    <div class="betting-module" style="max-width: 350px;">
                        <div class="bet-mode-tabs">
                            <button class="bet-mode-tab active">Bet</button>
                            <button class="bet-mode-tab">Auto</button>
                        </div>
                        <div class="amount-input-group">
                            <button class="amount-adjust-btn">-</button>
                            <input type="number" id="bet-amount" value="100" min="1" disabled>
                            <button class="amount-adjust-btn">+</button>
                        </div>
                        <div class="bet-quick-buttons">
                            <button class="button quick-bet-button" data-bet="100" disabled>100</button>
                            <button class="button quick-bet-button" data-bet="500" disabled>500</button>
                            <button class="button quick-bet-button" data-bet="1000" disabled>1000</button>
                            <button class="button quick-bet-button" data-bet="10000" disabled>10000</button>
                        </div>
                        <!-- Auto Bet Controls (hidden by default) -->
                        <div id="auto-bet-controls" style="display: none; flex-direction: column; gap: 12px;">
                            <div class="modal-input-group">
                                <label for="auto-cashout-amount">Auto Cashout at</label>
                                <input type="number" id="auto-cashout-amount" value="2.0" min="1.01" step="0.1" placeholder="e.g., 2.0">
                            </div>
                            <div class="auto-options">
                                <label for="auto-bet-toggle">Enable Auto Bet</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-bet-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <button class="button main-action-button" id="bet-button" disabled>
                            <span>BET</span>
                            <span id="bet-button-amount">100.00 KSH</span>
                        </button>
                        <button class="button cashout-button" id="cashout-button" style="display: none;">
                            <span class="cashout-label">CASHOUT</span>
                            <span class="cashout-amount" id="cashout-amount">100.00</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit/Withdraw Modal -->
    <div id="depositWithdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="depositWithdrawModal">&times;</span>
            <div class="modal-header">Wallet | 254717384875</div>

            <div class="modal-balance-info">
                <div class="balance-box">
                    <span>Balance</span>
                    <p id="modal-balance">0.00</p>
                </div>
                <div class="balance-box">
                    <span>Withdrawable</span>
                    <p id="modal-withdrawable">0.00</p>
                </div>
                <div class="balance-box">
                    <span>Bonus</span>
                    <p id="modal-bonus">0.00</p>
                </div>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab-button active" data-modal-tab="deposit">Deposit</button>
                <button class="modal-tab-button" data-modal-tab="withdraw">Withdraw</button>
                <button class="modal-tab-button" data-modal-tab="verify-deposit">Verify Deposit</button>
            </div>

            <div class="modal-tab-content">
                <!-- Deposit Tab Pane -->
                <div id="deposit-tab-pane" class="modal-tab-pane active">
                    <div class="modal-input-group">
                        <label for="deposit-amount">Amount</label>
                        <input type="number" id="deposit-amount" value="100" min="10">
                    </div>
                    <button class="modal-button" id="top-up-now-button">TOP UP NOW</button>
                    <div class="modal-instructions">
                        <p><strong>Instructions:</strong></p>
                        <p>Manual Deposit: Paybill: <strong>710739</strong>, A/c: <strong>0717384875</strong></p>
                        <p>Minimum amount: 10/-</p>
                        <p>Maximum amount: 150,000/-</p>
                        <p>Daily Transaction Limit: 300,000/-</p>
                    </div>
                </div>

                <!-- Withdraw Tab Pane -->
                <div id="withdraw-tab-pane" class="modal-tab-pane">
                    <div class="modal-input-group">
                        <label for="withdraw-amount">Amount</label>
                        <input type="number" id="withdraw-amount" value="100" min="100">
                    </div>
                    <p style="font-size:0.85rem; color: rgba(255,255,255,0.7); text-align: center;">Transfer Fee: 5 | To Disburse: <span id="to-disburse">95.00</span></p>
                    <button class="modal-button" id="withdraw-now-button">WITHDRAW NOW</button>
                    <div class="modal-instructions">
                        <p><strong>Instructions:</strong></p>
                        <p>Minimum Withdrawal amount: 100/-</p>
                        <p>Maximum Withdrawal amount: 150,000/-</p>
                        <p>Daily Transaction Limit: 300,000/-</p>
                        <p><strong>Withholding Tax (WHT):</strong> As provided for by the Income Tax Act, Cap 472, all gaming companies are required to withhold winnings at a rate of 20%. This is the Withholding Tax. In compliance with the law, we will deduct and remit to KRA 20% of all winnings.</p>
                    </div>
                </div>

                <!-- Verify Deposit Tab Pane -->
                <div id="verify-deposit-tab-pane" class="modal-tab-pane">
                    <div class="modal-input-group">
                        <label for="mpesa-code">M-PESA CODE</label>
                        <input type="text" id="mpesa-code" placeholder="-- RD56FR9UGO --">
                    </div>
                    <button class="modal-button" id="verify-mpesa-button">VERIFY M-PESA</button>
                    <div class="modal-instructions">
                        <p>Copy or type the M-PESA code e.g RD56FR9UGO you received on SMS from M-PESA then click Verify M-PESA.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="loginModal">&times;</span>
            <div class="modal-header">Welcome Back</div>
            <div class="modal-body">
                <div class="modal-message-display" id="login-message-display"></div>
            <div class="modal-input-group">
                    <label for="login-mobile">Mobile Number</label>
                    <div class="input-row">
                        <span class="input-prefix">+254</span>
                        <input type="text" id="login-mobile" inputmode="numeric" pattern="\\d{9,}" placeholder="722000000" aria-describedby="login-mobile-help">
                    </div>
                    <small id="login-mobile-help" class="input-help">Enter 9 digits without the leading 0</small>
            </div>
            <div class="modal-input-group">
                <label for="login-password">Password</label>
                    <div class="input-row">
                        <input type="password" id="login-password" placeholder="Enter your password">
                        <button type="button" class="input-addon" data-toggle-password="login-password">Show</button>
                    </div>
                    <small class="input-help">Minimum 6 characters</small>
                </div>
                <div class="modal-actions-row">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="login-remember"> 
                        Remember me
                    </label>
                    <a href="#" class="modal-link" id="show-password-reset-link">Forgot Password?</a>
            </div>
            <button class="modal-button" id="login-button">Login</button>
                <div style="text-align: center; margin-top: 20px;">
            <a href="#" class="modal-link" id="show-signup-link">Don't have an account? Sign Up</a>
                </div>
            <div class="modal-footer">
                    Need help? Call: <a href="tel:0717384875">0717384875</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="signupModal">&times;</span>
            <div class="modal-header">Create Account</div>
            <div class="modal-body">
            <div class="modal-message-display" id="signup-message-display"></div>
            <div class="modal-input-group">
                    <label for="signup-mobile">Mobile Number</label>
                    <div class="input-row">
                        <span class="input-prefix">+254</span>
                        <input type="text" id="signup-mobile" inputmode="numeric" pattern="\\d{9,}" placeholder="722000000" aria-describedby="signup-mobile-help">
                    </div>
                    <small id="signup-mobile-help" class="input-help">Enter 9 digits without the leading 0</small>
            </div>
            <div class="modal-input-group">
                    <label for="signup-email">Email Address <span style="color: #888; font-weight: normal;">(Optional)</span></label>
                    <input type="email" id="signup-email" placeholder="you@example.com" aria-describedby="signup-email-help">
                    <small id="signup-email-help" class="input-help">You can log in using either this email or your phone</small>
                </div>
                <div class="modal-input-group">
                    <label for="signup-nickname">Display Name</label>
                    <input type="text" id="signup-nickname" placeholder="Hot-Crash" maxlength="20" aria-describedby="signup-nickname-help">
                    <small id="signup-nickname-help" class="input-help">Visible to other players (3-20 characters)</small>
            </div>
            <div class="modal-input-group">
                <label for="signup-password">Password</label>
                    <div class="input-row">
                        <input type="password" id="signup-password" placeholder="Create a strong password">
                        <button type="button" class="input-addon" data-toggle-password="signup-password">Show</button>
            </div>
                    <small class="input-help">Minimum 6 characters</small>
                </div>
                <div class="modal-input-group">
                    <label for="signup-password-confirm">Confirm Password</label>
                    <div class="input-row">
                        <input type="password" id="signup-password-confirm" placeholder="Confirm your password">
                        <button type="button" class="input-addon" data-toggle-password="signup-password-confirm">Show</button>
                    </div>
                </div>
                <div class="modal-input-group">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="signup-terms"> 
                        I agree to the <a href="#" style="color: #00ff00;">Terms & Conditions</a> and <a href="#" style="color: #00ff00;">Privacy Policy</a>
                    </label>
                </div>
                <button class="modal-button" id="create-account-button">Create Account</button>
                <div style="text-align: center; margin-top: 20px;">
            <a href="#" class="modal-link" id="show-login-link">Already have an account? Login</a>
                </div>
            <div class="modal-footer">
                    Need help? Call: <a href="tel:0717384875">0717384875</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="passwordResetModal">&times;</span>
            <div class="modal-header">Reset Password</div>
            <div class="modal-body">
            <div class="modal-message-display" id="password-reset-message-display"></div>
            <div class="modal-input-group">
                    <label for="reset-mobile">Mobile Number</label>
                    <div class="input-row">
                        <span class="input-prefix">+254</span>
                        <input type="text" id="reset-mobile" inputmode="numeric" pattern="\\d{9,}" placeholder="722000000" aria-describedby="reset-mobile-help">
            </div>
                    <small id="reset-mobile-help" class="input-help">Enter 9 digits without the leading 0</small>
                </div>
                <button class="modal-button" id="reset-password-button">Send Reset Link</button>
                <div style="text-align: center; margin-top: 20px;">
            <a href="#" class="modal-link" id="back-to-login-link">Back to Login</a>
                </div>
            <div class="modal-footer">
                    Need help? Call: <a href="tel:0717384875">0717384875</a>
                </div>
            </div>
        </div>
    </div>

    <!-- New: Change Password Modal (for logged-in users) -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="changePasswordModal">&times;</span>
            <div class="modal-header">Change Password</div>
            <div class="modal-body">
            <div class="modal-message-display" id="change-password-message-display"></div>
            <div class="modal-input-group">
                <label for="current-password">Current Password</label>
                    <div class="input-row">
                        <input type="password" id="current-password" placeholder="Enter current password">
                        <button type="button" class="input-addon" data-toggle-password="current-password">Show</button>
                    </div>
            </div>
            <div class="modal-input-group">
                <label for="new-password">New Password</label>
                    <div class="input-row">
                        <input type="password" id="new-password" placeholder="Enter new password">
                        <button type="button" class="input-addon" data-toggle-password="new-password">Show</button>
                    </div>
                    <small class="input-help">Minimum 6 characters</small>
            </div>
            <div class="modal-input-group">
                <label for="confirm-new-password">Confirm New Password</label>
                    <div class="input-row">
                        <input type="password" id="confirm-new-password" placeholder="Confirm new password">
                        <button type="button" class="input-addon" data-toggle-password="confirm-new-password">Show</button>
            </div>
                </div>
                <button class="modal-button" id="update-password-button">Update Password</button>
            <div class="modal-footer">
                    Need help? Call: <a href="tel:0717384875">0717384875</a>
                </div>
            </div>
        </div>
    </div>

    <!-- New: How To Play Modal -->
    <div id="howToPlayModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="howToPlayModal">&times;</span>
            <div class="modal-header">How To Play Prince Alex Jet</div>
            <div class="modal-instructions" style="text-align: left;">
                <p>Welcome to Prince Alex Jet, the thrilling crash game where you predict how high the jet will fly before it crashes!</p>
                <p><strong>How to Play:</strong></p>
                <ol>
                    <li><strong>Place Your Bet:</strong> Before each round starts (during the 10-second countdown), enter your desired bet amount in the "Bet Amount" field or use the quick bet buttons.</li>
                    <li><strong>Set Auto Cashout (Optional):</strong> You can set an "Auto Cashout" multiplier. If the jet reaches this multiplier, your bet will automatically cash out.</li>
                    <li><strong>Auto Bet (Optional):</strong> Enable "Auto Bet" to automatically place your bet in subsequent rounds.</li>
                    <li><strong>Watch the Jet Fly:</strong> Once the round begins, the jet takes off, and the multiplier starts increasing from 1.00x.</li>
                    <li><strong>Cash Out:</strong> Click the "Cash Out" button at any time before the jet crashes to secure your winnings. Your winnings are calculated as: <strong>Bet Amount x Multiplier at Cashout</strong>.</li>
                    <li><strong>The Crash:</strong> If the jet crashes before you cash out, you lose your bet for that round.</li>
                    <li><strong>Winning & Losing:</strong>
                        <ul>
                            <li><strong>Win:</strong> You cash out successfully before the crash.</li>
                            <li><strong>Loss:</strong> The jet crashes before you cash out.</li>
                        </ul>
                    </li>
                    <li><strong>History:</strong> Check the "Crash History" for past multipliers and "My Bets" for your personal game history.</li>
                    <li><strong>Chat:</strong> Interact with other players in the live chat.</li>
                </ol>
                <p>Good luck and have fun flying with Prince Alex Jet!</p>
            </div>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>



    <!-- Floating WhatsApp Button -->
    <a href="https://wa.me/254717384875" target="_blank" class="whatsapp-button" title="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script>
        const { createClient } = supabase
        // IMPORTANT: Replace 'YOUR_SUPABASE_URL' and 'YOUR_SUPABASE_ANON_KEY' with your actual Supabase project details.
        // You can find these in your Supabase project settings under "API".
        // If you continue to get "invalid API" errors, double-check your Supabase project's
        // Row Level Security (RLS) policies and ensure they allow sign-ups and data inserts.
        const supabaseClient = createClient(
          'https://yigtwtapnqbpmnoeitpa.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpZ3R3dGFwbnFicG1ub2VpdHBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA4MTEsImV4cCI6MjA2ODY3NjgxMX0.rKF2MwO94wPeT2V0rDsypNcwjOk2wN9rMwmiYo79T2g'
        );
    </script>
	<!-- Firebase + Firestore (ES Module) -->
	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, updatePassword, signOut, updateProfile, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
		import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, getDocs, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

		// Your Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyC8-TWRr_vOMTv72scXxu-9l5uVHRVputo",
			authDomain: "group-saving-chama.firebaseapp.com",
			projectId: "group-saving-chama",
			storageBucket: "group-saving-chama.firebasestorage.app",
			messagingSenderId: "570981365925",
			appId: "1:570981365925:web:42422e51e4e02c6ab4f54c"
		};

		const fbApp = initializeApp(firebaseConfig);
		const db = getFirestore(fbApp);
		const auth = getAuth(fbApp);

		// Expose Firebase helpers to window for non-module scripts
		window.fire = { db, auth, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, getDocs, serverTimestamp, onSnapshot };
		window.fireAuth = { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, updatePassword, signOut, updateProfile, setPersistence, browserLocalPersistence };
	</script>
    <script defer>
        // --- Graphing constants ---
        const PADDING_X = 50;
        const PADDING_Y = 50;
        const MAX_GAME_TICKS_X_SCALE = 200; // Max game ticks to show on X-axis (20 seconds at 100ms/tick)
        const Y_AXIS_BREAKPOINTS = [1.0, 2.0, 5.0, 10.0, 20.0, 50.0, 100.0, 200.0, 500.0, 1000.0, 2000.0, 5000.0, 10000.0];
        let dynamicMaxMultiplierY = 10.0; // Initial max Y-axis value for graph display

        // --- Starfield constants ---
        const STARS_COUNT = 100;
        const stars = [];

        // --- DOM Elements ---
        const gameCanvas = document.getElementById('game-canvas');
        const ctx = gameCanvas.getContext('2d');
        const confettiCanvas = document.getElementById('confetti-canvas'); // Confetti canvas
        const confettiCtx = confettiCanvas.getContext('2d'); // Confetti context
        const multiplierDisplayOverlay = document.getElementById('multiplier-display-overlay');
        const countdownTimerOverlay = document.getElementById('countdown-timer-overlay');
        const bustedTextOverlay = document.getElementById('busted-text-overlay');
        const gameStatusOverlay = document.getElementById('game-status-overlay'); // New
        
        const betButton = document.getElementById('bet-button');
        const cashoutButton = document.getElementById('cashout-button');
        const cashoutMultiplier = document.getElementById('cashout-multiplier');
        const cashoutAmount = document.getElementById('cashout-amount');
        const betAmountInput = document.getElementById('bet-amount');
        const messageDisplay = document.getElementById('message-display'); // Main game message display
        
        // Betting Module 1 Elements
        const bettingModule1 = document.querySelector('.betting-module');
        const quickBetButtons1 = bettingModule1.querySelectorAll('.quick-bet-button');
        const amountAdjustButtons1 = bettingModule1.querySelectorAll('.amount-adjust-btn');
        const betModeTabs = bettingModule1.querySelectorAll('.bet-mode-tab');
        const autoBetControls = document.getElementById('auto-bet-controls');
        const autoCashoutInput = document.getElementById('auto-cashout-amount');
        const autoBetToggle = document.getElementById('auto-bet-toggle');
        
        // Top Bar Elements
        const authButton = document.getElementById('auth-button'); 
        const topBarBalance = document.getElementById('top-bar-balance');
        const themeToggle = document.getElementById('theme-toggle'); // Theme toggle button
        
        // New Account Dropdown Elements
        const accountDropdown = document.getElementById('account-dropdown');
        const dropdownUserInfo = document.getElementById('dropdown-user-info');
        const dropdownDepositWithdraw = document.getElementById('dropdown-deposit-withdraw');
        const dropdownChangePassword = document.getElementById('dropdown-change-password');
        const dropdownHowToPlay = document.getElementById('dropdown-how-to-play');
        const dropdownLogout = document.getElementById('dropdown-logout');

        // New Tab Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const onlineUsersCount = document.getElementById('online-users-count');
        const playingUsersCount = document.getElementById('playing-users-count');
        const playersTableBody = document.getElementById('players-table-body');
        const playerHistoryDisplayTab = document.getElementById('player-history-display-tab'); 
        const crashHistoryDisplay = document.getElementById('crash-history-display'); 
        const leaderboardMultiplierBody = document.getElementById('leaderboard-multiplier-body'); // Leaderboard elements
        const leaderboardWinningsBody = document.getElementById('leaderboard-winnings-body');

        // Modals
        const depositWithdrawModal = document.getElementById('depositWithdrawModal');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const passwordResetModal = document.getElementById('passwordResetModal'); 
        const changePasswordModal = document.getElementById('changePasswordModal');
        const howToPlayModal = document.getElementById('howToPlayModal');
        const allCloseModalButtons = document.querySelectorAll('.close-button'); 
        const loadingOverlay = document.getElementById('loading-overlay'); // Loading spinner overlay

        // Deposit/Withdraw Modal Elements
        const modalTabButtons = depositWithdrawModal.querySelectorAll('.modal-tab-button');
        const modalTabPanes = depositWithdrawModal.querySelectorAll('.modal-tab-pane');
        const depositAmountInput = document.getElementById('deposit-amount');
        const topUpNowButton = document.getElementById('top-up-now-button');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const toDisburseSpan = document.getElementById('to-disburse');
        const withdrawNowButton = document.getElementById('withdraw-now-button');
        const mpesaCodeInput = document.getElementById('mpesa-code');
        const verifyMpesaButton = document.getElementById('verify-mpesa-button');

        // Login Modal Elements
        const loginMobileInput = document.getElementById('login-mobile');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const showSignupLink = document.getElementById('show-signup-link');
        const showPasswordResetLink = document.getElementById('show-password-reset-link'); 
        const loginMessageDisplay = document.getElementById('login-message-display'); 

        // Sign Up Modal Elements
        const signupMobileInput = document.getElementById('signup-mobile');
        const signupNicknameInput = document.getElementById('signup-nickname');
        const signupPasswordInput = document.getElementById('signup-password');
        const createAccountButton = document.getElementById('create-account-button');
        const showLoginLink = document.getElementById('show-login-link');
        const signupMessageDisplay = document.getElementById('signup-message-display'); 

        // Password Reset Modal Elements
        const resetMobileInput = document.getElementById('reset-mobile'); 
        const resetPasswordButton = document.getElementById('reset-password-button'); 
        const backToLoginLink = document.getElementById('back-to-login-link'); 
        const passwordResetMessageDisplay = document.getElementById('password-reset-message-display'); 

        // Change Password Modal Elements
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');
        const updatePasswordButton = document.getElementById('update-password-button');
        const changePasswordMessageDisplay = document.getElementById('change-password-message-display');


        // --- Game State ---
        let balance = 0;
        let betAmount = 10; 
        let multiplier = 1.00;
        let crashMultiplier = 1.00;
        let isGameRunning = false; 
        let hasCashedOut = false; 
        let gameLogicInterval = null; // Renamed to avoid confusion with animation loop
        let isAutoBetActive = false; // New state for auto bet
        let isAutoBetEnabled = false;
        let currentBetPlaced = 0; 
        let currentBetId = null;
        let roundCountdownInterval = null;
        let betPlacedForNextRound = false;

        let preRoundTimer = 0; 
        const MAX_HISTORY_ITEMS = 10; // Max items to display in crash history

        let curvePoints = []; 
        let gameTicks = 0; 

        // Authentication State
        let isLoggedIn = false;
        let currentUserId = null;
        let currentUserNickname = null;

        // Provably Fair Seeds and Nonce
        let serverSeed = generateRandomString(32);
        const clientSeed = "player-alex";
        let nonce = 0;

        // Simulated Player Names
        const allPlayerNames = [
            "JulianaH123", "Josemwai", "Josephwainaina", "FunnyDiudi", "Cheche", "BlackHawk", "EatPeople", "Amanda",
            "BraveHeart", "LuckyCharm", "QuickCash", "GameMaster", "CryptoKing", "JetSetter", "HighRoller", "BetBoss",
            "WinStreak", "FlyHigh", "CashFlow", "AcePilot", "SkyWalker", "GoldenWings", "TopGun", "FastCash",
            "MoneyMaker", "RiskTaker", "FortuneHunter"
        ];
        
        // Simulated Player Data for "Players" tab
        const simulatedPlayers = []; 
        const NUM_SIMULATED_PLAYERS = 15; 

        let baseOnlineUsers = 90;
        let onlineUsersFluctuationInterval = null;

        // Airplane SVG path
        // Modern jet design with multiple paths for different parts
        const jetBodyPath = new Path2D("M25 0 L5 8 L5 10 L8 10 L8 15 L10 15 L10 10 L15 10 L15 8 L25 0 Z");
        const jetWingPath = new Path2D("M15 8 L12 12 L14 12 L15 10 Z");
        const jetTailPath = new Path2D("M5 8 L2 10 L4 10 L5 8 Z");
        const jetCockpitPath = new Path2D("M20 2 L18 4 L20 4 Z");
        
        // Jet trail particles for enhanced effect
        let jetTrailParticles = [];
        
        // Function to draw jet trail particles
        function drawJetTrail(ctx, currentPoint, previousPoint) {
            // Add new particles
            if (Math.random() < 0.7) {
                jetTrailParticles.push({
                    x: currentPoint.x + (Math.random() - 0.5) * 10,
                    y: currentPoint.y + (Math.random() - 0.5) * 10,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    life: 1.0,
                    size: Math.random() * 3 + 1
                });
            }
            
            // Update and draw particles
            for (let i = jetTrailParticles.length - 1; i >= 0; i--) {
                const particle = jetTrailParticles[i];
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life -= 0.02;
                particle.size *= 0.98;
                
                if (particle.life <= 0 || particle.size < 0.1) {
                    jetTrailParticles.splice(i, 1);
                    continue;
                }
                
                ctx.save();
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = `hsl(${120 + (1 - particle.life) * 120}, 100%, 50%)`;
                ctx.beginPath();
                ctx.arc(particle.x - currentPoint.x, particle.y - currentPoint.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        } 

        // Sound Effects
        let gameStartSynth, cashoutSynth, crashSynth;
        let isSoundInitialized = false;

        function initializeAudio() {
            if (isSoundInitialized) return;
            Tone.start();
            gameStartSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.2, release: 0.5 } }).toDestination();
            cashoutSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
            crashSynth = new Tone.NoiseSynth({ envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.3 } }).toDestination();
            isSoundInitialized = true;
            console.log("Audio context initialized.");
        }

        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function getCrashMultiplier() {
            // Check if admin control is enabled
            if (adminSettings.multiplierMode === 'manual' && adminSettings.nextCrashMultiplier) {
                console.log('Using admin manual multiplier:', adminSettings.nextCrashMultiplier);
                const adminMultiplier = adminSettings.nextCrashMultiplier;
                adminSettings.nextCrashMultiplier = null; // Reset after use
                return adminMultiplier;
            }
            
            // Use fair random distribution
            return generateFairRandomMultiplier();
        }

        function generateFairRandomMultiplier() {
            const random = Math.random() * 100; // 0-100
            
            if (random <= 50) {
                // Range 1.01-3.0 (50% probability)
                return Math.random() * (3.0 - 1.01) + 1.01;
            } else if (random <= 70) {
                // Range 3.0-10.0 (20% probability)
                return Math.random() * (10.0 - 3.0) + 3.0;
            } else if (random <= 90) {
                // Range 10.0-20.0 (20% probability)
                return Math.random() * (20.0 - 10.0) + 10.0;
            } else {
                // Range 20.0-1000.0 (10% probability)
                return Math.random() * (1000.0 - 20.0) + 20.0;
            }
        }

        async function loadUserData() {
			const user = fire.auth.currentUser;
			if (!user) return console.error('Not logged in');
            isLoggedIn = true;
			currentUserId = user.uid;

			// Load Profile from Firestore
			let profile = null;
			try {
				const profRef = fire.doc(fire.db, 'profiles', user.uid);
				const profSnap = await fire.getDoc(profRef);
				if (profSnap.exists()) {
					profile = profSnap.data();
				} else {
					await fire.setDoc(profRef, { nickname: 'Player', phone: '', created_at: fire.serverTimestamp() });
					profile = { nickname: 'Player', phone: '' };
				}
			} catch (e) { console.error('Profile load error (Firestore):', e); }
            currentUserNickname = profile?.nickname || 'Player';

			// Load Wallet from Firestore
			let wallet = null;
			try {
				const walletRef = fire.doc(fire.db, 'wallets', user.uid);
				const walletSnap = await fire.getDoc(walletRef);
				if (walletSnap.exists()) {
					wallet = walletSnap.data();
				} else {
					wallet = { user_id: user.uid, balance: 1000, bonus: 100, withdrawable: 900 };
					await fire.setDoc(walletRef, { ...wallet, created_at: fire.serverTimestamp(), updated_at: fire.serverTimestamp() });
				}
			} catch (e) { console.error('Wallet load error (Firestore):', e); }
            
            balance = wallet?.balance || 0;

            // Update UI
            if (dropdownUserInfo) dropdownUserInfo.innerHTML = `${profile?.nickname || 'Player'}<br>${profile?.phone || ''}`;
            
            // Define modal elements here to ensure they exist when needed
            const modalBalance = document.getElementById('modal-balance');
            const modalWithdrawable = document.getElementById('modal-withdrawable');
            const modalBonus = document.getElementById('modal-bonus');
            if (modalBalance) modalBalance.textContent = (wallet?.balance || 0).toFixed(2);
            if (modalWithdrawable) modalWithdrawable.textContent = (wallet?.withdrawable || 0).toFixed(2);
            if (modalBonus) modalBonus.textContent = (wallet?.bonus || 0).toFixed(2);

            topBarBalance.style.display = 'inline';
            topBarBalance.textContent = `${(wallet?.balance || 0).toFixed(2)} KES`;
            updateAuthUI();
        }

        async function updateWalletAmount(amountChange, bonusChange = 0) {
			const user = fire.auth.currentUser; if (!user) return;
			try {
				const walletRef = fire.doc(fire.db, 'wallets', user.uid);
				const snap = await fire.getDoc(walletRef);
				const cur = snap.exists() ? snap.data() : { balance: 0, bonus: 0, withdrawable: 0 };
				const newBalance = (cur.balance || 0) + amountChange;
				const newBonus = (cur.bonus || 0) + bonusChange;
            const newWithdrawable = newBalance - newBonus;
				await fire.setDoc(walletRef, { user_id: user.uid, balance: newBalance, bonus: newBonus, withdrawable: newWithdrawable, updated_at: fire.serverTimestamp() }, { merge: true });
            balance = newBalance;
			} catch (e) { console.error('Wallet update error (Firestore):', e); }
        }

        async function placeBet(betAmount, autoCashoutAt) {
            const user = fire.auth.currentUser;
            if (!user) {
                showMessage("Please log in to place a bet.", "var(--danger-color)");
                return;
            }

			try {
				const ref = await fire.addDoc(fire.collection(fire.db, 'bets'), {
					user_id: user.uid,
                bet_amount: betAmount,
                result_status: 'pending',
					cashout_at: autoCashoutAt || null,
					created_at: fire.serverTimestamp()
				});
				currentBetId = ref.id;
                await updateWalletAmount(-betAmount);
				console.log('Bet placed!');
                await loadUserData();
			} catch (e) {
				console.error('Error placing bet (Firestore):', e);
				showMessage('Error placing bet. Please try again.', 'var(--danger-color)');
            }
        }
        
        async function resolveBet(betId, resultStatus, multiplier) {
			try {
				const betRef = fire.doc(fire.db, 'bets', betId);
				const betSnap = await fire.getDoc(betRef);
				if (!betSnap.exists()) return;
				const bet = betSnap.data();
            const payout = resultStatus === 'won' ? bet.bet_amount * multiplier : 0;
				await fire.updateDoc(betRef, { result_status: resultStatus, multiplier, payout, settled_at: fire.serverTimestamp() });
				if (payout > 0) { await updateWalletAmount(payout); }
            await loadUserData();
			} catch (e) { console.error('Resolve bet error (Firestore):', e); }
        }

        async function loadMyBetHistory() {
            const user = fire.auth.currentUser; 
            if (!user) {
                console.log('No user logged in for bet history');
                return;
            }
            
            console.log('Loading bet history for user:', user.uid);
            
            try {
                // First try a simple query without orderBy to avoid index issues
                let q = fire.query(
                    fire.collection(fire.db, 'bets'),
                    fire.where('user_id', '==', user.uid),
                    fire.limit(10)
                );
                
                const snap = await fire.getDocs(q);
                const bets = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                console.log('Found bets:', bets.length, bets);

            const playerHistoryContainer = document.getElementById('player-history-display-tab');
                if (!playerHistoryContainer) {
                    console.error('Player history container not found');
                    return;
                }
                
                // Clear existing content except header
            while (playerHistoryContainer.children.length > 1) {
                playerHistoryContainer.removeChild(playerHistoryContainer.lastChild);
            }

                if (bets.length === 0) {
                    const noBetsRow = document.createElement('div');
                    noBetsRow.classList.add('history-item');
                    noBetsRow.innerHTML = '<div style="text-align: center; color: var(--accent-color);">No bets placed yet</div>';
                    playerHistoryContainer.appendChild(noBetsRow);
                    return;
                }
                
                // Sort bets by created_at in JavaScript since Firestore orderBy might fail
                bets.sort((a, b) => {
                    const aTime = a.created_at?.seconds || 0;
                    const bTime = b.created_at?.seconds || 0;
                    return bTime - aTime; // Descending order (newest first)
                });
                
                bets.forEach((bet) => {
                const row = document.createElement('div');
                row.classList.add('history-item');
                
                // Calculate winnings
                let winnings = '0.00';
                if (bet.result_status === 'won' && bet.multiplier) {
                    winnings = (Number(bet.bet_amount) * Number(bet.multiplier)).toFixed(2);
                }
                
                row.innerHTML = `
                <span class="ticket-id">${bet.id.slice(0, 6)}</span>
                    <span class="bet-amount">${Number(bet.bet_amount).toFixed(2)}</span>
                    <span class="multiplier-info">${bet.multiplier ? Number(bet.multiplier).toFixed(2) + 'x' : '-'}</span>
                    <span class="winnings ${bet.result_status === 'won' ? 'winnings-win' : 'winnings-loss'}">${winnings}</span>
                <span class="status ${bet.result_status === 'won' ? 'status-win' : 'status-loss'}">${bet.result_status}</span>
                `;
                playerHistoryContainer.appendChild(row);
            });
            } catch (e) { 
                console.error('Load bet history error (Firestore):', e);
                console.error('Error details:', e.code, e.message);
                
                const playerHistoryContainer = document.getElementById('player-history-display-tab');
                if (playerHistoryContainer) {
                    let errorMessage = 'Error loading bet history';
                    if (e.code === 'failed-precondition') {
                        errorMessage = 'Database index needed. Please contact support.';
                    } else if (e.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please log in again.';
                    }
                    playerHistoryContainer.innerHTML = `<div class="history-item" style="text-align: center; color: var(--danger-color);">${errorMessage}</div>`;
                }
            }
        }

        function updateAuthUI() {
            if (isLoggedIn) {
                authButton.textContent = 'Account';
                authButton.onclick = () => accountDropdown.classList.toggle('show');
                topBarBalance.style.display = 'inline-block'; 
                topBarBalance.textContent = `${balance.toFixed(2)} KES`;
                showMessage('Place your bet to start the round!', 'var(--text-color)');
            } else {
                authButton.textContent = 'Login / Sign Up';
                authButton.onclick = () => showModal(loginModal);
                topBarBalance.style.display = 'none';
                accountDropdown.classList.remove('show');
                showMessage('Watch the game! Login to place bets.', 'var(--text-color)');
            }
            
            // Update bet UI separately
            updateBetUI();
        }

        function multToY(mult) {
            const graphHeight = gameCanvas.height - 2 * PADDING_Y;
            const scaledMult = Math.max(1, mult);
            // Ensure the denominator is not zero or negative for multipliers less than 1
            const effectiveMaxMultiplierY = dynamicMaxMultiplierY > 1 ? dynamicMaxMultiplierY : 1.01;
            
            // Use logarithmic scaling for very high multipliers to keep them visible
            if (scaledMult > 100) {
                const logMult = Math.log10(scaledMult);
                const logMax = Math.log10(effectiveMaxMultiplierY);
                return gameCanvas.height - PADDING_Y - (logMult / logMax) * graphHeight;
            } else {
                return gameCanvas.height - PADDING_Y - ((scaledMult - 1) / (effectiveMaxMultiplierY - 1)) * graphHeight;
            }
        }

        function ticksToX(ticks) {
            const graphWidth = gameCanvas.width - 2 * PADDING_X;
            return PADDING_X + (ticks / MAX_GAME_TICKS_X_SCALE) * graphWidth;
        }

        function initStars() {
            stars.length = 0;
            for (let i = 0; i < STARS_COUNT; i++) {
                stars.push({
                    x: Math.random() * gameCanvas.width,
                    y: Math.random() * gameCanvas.height,
                    radius: Math.random() * 1.5 + 0.5,
                    alpha: Math.random() * 0.5 + 0.5
                });
            }
        }

        function drawGraph() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
            });

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.font = '14px var(--font-family-body)';
            ctx.fillStyle = 'var(--text-color)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Draw X-axis (time)
            ctx.beginPath();
            ctx.moveTo(PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.lineTo(gameCanvas.width - PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.stroke();

            // Draw Y-axis (multiplier)
            ctx.beginPath();
            ctx.moveTo(PADDING_X, PADDING_Y);
            ctx.lineTo(PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.stroke();

            // Draw X-axis labels and grid lines
            for (let i = 0; i <= 8; i += 2) {
                const x = ticksToX(i * (MAX_GAME_TICKS_X_SCALE / 8));
                ctx.fillText(i + 's', x, gameCanvas.height - PADDING_Y / 2); // Label in seconds
                ctx.beginPath();
                ctx.moveTo(x, gameCanvas.height - PADDING_Y);
                ctx.lineTo(x, PADDING_Y);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.stroke();
            }

            // Draw Y-axis labels and grid lines
            let labelStep = 1;
            if (dynamicMaxMultiplierY >= 100) labelStep = 100;
            else if (dynamicMaxMultiplierY >= 50) labelStep = 10;
            else if (dynamicMaxMultiplierY >= 20) labelStep = 5;
            else if (dynamicMaxMultiplierY >= 5) labelStep = 1;
            else labelStep = 0.5;

            for (let i = 1; i <= dynamicMaxMultiplierY; i += labelStep) {
                const mult = parseFloat(i.toFixed(1));
                const y = multToY(mult);
                if (y >= PADDING_Y && y <= gameCanvas.height - PADDING_Y) {
                    ctx.fillText(`${mult.toFixed(1)}x`, PADDING_X / 2, y);
                    ctx.beginPath();
                    ctx.moveTo(PADDING_X, y);
                    ctx.lineTo(gameCanvas.width - PADDING_X, y);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.stroke();
                }
            }

            // Draw graph fill (area under the curve)
            if (curvePoints.length > 1) {
                ctx.beginPath();
                ctx.moveTo(PADDING_X, gameCanvas.height - PADDING_Y); // Start at bottom-left of graph area
                curvePoints.forEach(point => ctx.lineTo(point.x, point.y));
                const lastPoint = curvePoints[curvePoints.length - 1];
                ctx.lineTo(lastPoint.x, gameCanvas.height - PADDING_Y); // Go down to X-axis
                ctx.closePath();
                const gradient = ctx.createLinearGradient(0, PADDING_Y, 0, gameCanvas.height - PADDING_Y);
                gradient.addColorStop(0, varToRgba('--graph-fill-color-top')); // e.g., rgba(227, 154, 75, 0.22)
                gradient.addColorStop(1, varToRgba('--graph-fill-color-bottom')); // e.g., rgba(227, 154, 75, 0)
                ctx.fillStyle = gradient; // Use the created gradient for the fill
                ctx.fill();
            }

            // Draw modern jet line with gradient and glow effect
            if (curvePoints.length > 1) {
                // Draw line with gradient
                ctx.beginPath();
                ctx.strokeStyle = varToRgba('--accent-color'); // Use the main accent color for a bold line
                ctx.lineWidth = 5; // Make the line thicker
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.moveTo(curvePoints[0].x, curvePoints[0].y);
                for (let i = 1; i < curvePoints.length; i++) {
                    ctx.lineTo(curvePoints[i].x, curvePoints[i].y);
                }
                
                // Add glow effect
                ctx.shadowColor = varToRgba('--accent-color');
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.shadowBlur = 0;
                
            }

            // Draw modern jet with enhanced visual effects
            if (isGameRunning && curvePoints.length > 1) {
                const lastPoint = curvePoints[curvePoints.length - 1];
                const prevPoint = curvePoints[curvePoints.length - 2] || curvePoints[0];
                const angle = Math.atan2(lastPoint.y - prevPoint.y, lastPoint.x - prevPoint.x);
                
                ctx.save();
                ctx.translate(lastPoint.x, lastPoint.y);
                ctx.rotate(angle);
                
                // Draw jet trail particles
                drawJetTrail(ctx, lastPoint, prevPoint);
                
                // Draw jet with gradient and glow
                const jetGradient = ctx.createLinearGradient(-15, 0, 15, 0); // Gold gradient
                jetGradient.addColorStop(0, varToRgba('--light-gold'));
                jetGradient.addColorStop(1, varToRgba('--dark-gold'));
                
                // Jet body with gradient
                ctx.fillStyle = jetGradient;
                ctx.scale(1.2, 1.2);
                ctx.fill(jetBodyPath);
                
                // Jet wings
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fill(jetWingPath);
                
                // Jet tail
                ctx.fillStyle = 'rgba(200, 200, 200, 0.8)';
                ctx.fill(jetTailPath);
                
                // Jet cockpit
                ctx.fillStyle = 'rgba(0, 150, 255, 0.9)';
                ctx.fill(jetCockpitPath);
                
                // Add glow effect to jet
                ctx.shadowColor = varToRgba('--light-gold');
                ctx.shadowBlur = 15;
                ctx.fill(jetBodyPath);
                ctx.shadowBlur = 0;
                
                ctx.restore();
            }
            ctx.font = '12px var(--font-family-body)';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Connection: ON', PADDING_X, gameCanvas.height - 10);
        }

        function varToRgba(cssVar) {
            const style = getComputedStyle(document.documentElement);
            return style.getPropertyValue(cssVar).trim();
        }

        function initializeUIForPreRound() {
            if (topBarBalance) topBarBalance.textContent = `${balance.toFixed(2)} KES`;
            if (betAmountInput) betAmountInput.value = betAmount;
            if (cashoutButton) cashoutButton.disabled = true;
            if (cashoutMultiplier) cashoutMultiplier.textContent = '1.00x';
            if (cashoutAmount) cashoutAmount.textContent = '0.00';
            
            if (isLoggedIn) {
                if (betButton) {
                    betButton.disabled = false;
                    const span = betButton.querySelector('span:first-child');
                    if (span) span.textContent = isAutoBetActive ? 'START AUTO' : 'BET';
                    if (betButton) betButton.style.backgroundColor = 'var(--accent-color)';
                }
                if (betAmountInput) betAmountInput.disabled = false; 
                if (autoCashoutInput) autoCashoutInput.disabled = false;
                if (bettingModule1) bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = false);

                // Handle auto-bet for the first module
                if (isAutoBetEnabled && betButton) {
                    betButton.disabled = true;
                    const span = betButton.querySelector('span:first-child');
                    if (span) span.textContent = 'AUTO BET';
                    if (betAmountInput) betAmountInput.disabled = true;
                    if (bettingModule1) bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = true);
                } 
                showMessage('Place your bet to start the round!', 'var(--text-color)');
            } else {
                if (autoCashoutInput) autoCashoutInput.disabled = true;
                if (betButton) { betButton.disabled = true; const span = betButton.querySelector('span:first-child'); if (span) span.textContent = 'LOGIN TO BET'; }
                if (betAmountInput) betAmountInput.disabled = true; 
                if (bettingModule1) bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = true);
                showMessage('Watch the game! Login to place bets.', 'var(--text-color)');
            }

            resetAnimation();
            currentBetPlaced = 0;
            currentBetId = null;
            betPlacedForNextRound = false;
            countdownTimerOverlay.style.display = 'block';
            multiplierDisplayOverlay.style.display = 'none';
            bustedTextOverlay.style.display = 'none';

            simulatedPlayers.length = 0;
            const usedNames = new Set();
            while (simulatedPlayers.length < NUM_SIMULATED_PLAYERS) {
                const randomName = allPlayerNames[Math.floor(Math.random() * allPlayerNames.length)];
                if (!usedNames.has(randomName)) {
                    usedNames.add(randomName);
                    const randomBet = Math.floor(Math.random() * (3000 - 50 + 1)) + 50; 
                    simulatedPlayers.push({
                        id: crypto.randomUUID(),
                        name: randomName,
                        bet: randomBet,
                        cashout: null,
                        won: null,
                        status: 'playing',
                        cashoutTarget: null
                    });
                }
            }
            updatePlayersTable();
            updateOnlineAndPlayingCounts();
        }

        function startPreRoundCountdown() {
            initializeUIForPreRound();
            // If a bet was placed during the previous round, it's for this new round.
            if (betPlacedForNextRound) {
                betButton.disabled = true;
                const span = betButton.querySelector('span:first-child');
                if (span) span.textContent = 'BET PLACED';
                betButton.style.backgroundColor = 'var(--success-color)';
            }

            isGameRunning = false;
            preRoundTimer = adminSettings.countdownTime || 6;
            countdownTimerOverlay.textContent = preRoundTimer;
            showMessage(`Next round starts in ${preRoundTimer} seconds. Place your bets!`);

            if (roundCountdownInterval) clearInterval(roundCountdownInterval);
            roundCountdownInterval = setInterval(() => {
                preRoundTimer--;
                countdownTimerOverlay.textContent = preRoundTimer;
                if (preRoundTimer > 0) {
                    showMessage(`Next round starts in ${preRoundTimer} seconds. Place your bets!`);
                } else {
                    lockBetsAndStartRound(); // This will also clear the interval
                }
            }, 1000);
        }

        function lockBetsAndStartRound() {
            if (roundCountdownInterval) clearInterval(roundCountdownInterval);

            countdownTimerOverlay.style.display = 'none';
            multiplierDisplayOverlay.style.display = 'block';
            if (isSoundInitialized) gameStartSynth.triggerAttackRelease("C4", "8n");

            betButton.disabled = true;
            betAmountInput.disabled = true;
            const betButtonSpan = betButton.querySelector('span:first-child');
            if (betButtonSpan) betButtonSpan.textContent = 'BETS LOCKED';

            // Handle auto-bet placement
            if (isAutoBetEnabled && isLoggedIn && balance >= parseFloat(betAmountInput.value)) {
                betPlacedForNextRound = true;
                currentBetPlaced = parseFloat(betAmountInput.value);
                placeBet(currentBetPlaced, parseFloat(autoCashoutInput.value));
                showMessage(`Auto-bet placed: ${currentBetPlaced.toFixed(2)} KES`, "var(--success-color)");
            } else if (isAutoBetEnabled) {
                isAutoBetEnabled = false; // Stop auto-bet if balance is insufficient
                updateBetUI();
            }
            // If a bet was placed, switch to the cashout button
            if (betPlacedForNextRound) {
                betButton.style.display = 'none';
                cashoutButton.style.display = 'flex';
                // currentBetId is already set when the bet was placed
                currentBetPlaced = parseFloat(betAmountInput.value);
                hasCashedOut = false;
                cashoutButton.disabled = false;
            }
 
            crashMultiplier = getCrashMultiplier();
            console.log("Calculated Crash Multiplier:", crashMultiplier);

            // Initialize flight path from bottom-left corner
            curvePoints = [];
            gameTicks = 0;
            multiplier = 1.00;
            
            // Start the flight path from bottom-left corner (1.00x multiplier)
            const startX = PADDING_X;
            const startY = gameCanvas.height - PADDING_Y; // Force bottom of canvas
            curvePoints.push({ x: startX, y: startY });
            
            console.log("Flight path initialized from bottom-left corner:", { 
                x: startX, 
                y: startY, 
                canvasHeight: gameCanvas.height,
                paddingY: PADDING_Y
            });

            isGameRunning = true;
                
                // Initialize cashout button display
                if (cashoutMultiplier && cashoutAmount) {
                    cashoutAmount.textContent = currentBetPlaced.toFixed(2);
                }
            
            // Update game state
            updateGameState('flying', { roundStartTime: Date.now() });
            updateGameStatus('Running', 'flying');
            showMessage(`Round started! Jet is flying...`, 'var(--secondary-color)');
            gameLogicInterval = setInterval(gameLoop, 100); // Original working timing
            if (gameLogicInterval) clearInterval(gameLogicInterval); // Clear previous interval
            gameLogicInterval = setInterval(gameLoop, 100);
        }

        function gameLoop() {
            if (!isGameRunning) return;

            // Simple and effective multiplier growth - like original Aviator
            multiplier += 0.01 + (multiplier * 0.01);
            multiplierDisplayOverlay.textContent = `${multiplier.toFixed(2)}x`;

            // Update the cashout button if a bet is active
            if (betPlacedForNextRound && !hasCashedOut) {
                const potentialWin = currentBetPlaced * multiplier;

                // Update cashout button with live multiplier and potential winnings
                if (cashoutAmount) cashoutAmount.textContent = potentialWin.toFixed(2);
            }

            // Auto-cashout logic
            const autoCashoutValue = parseFloat(autoCashoutInput.value);
            if (betPlacedForNextRound && !hasCashedOut && autoCashoutValue && multiplier >= autoCashoutValue) {
                cashOut(); // Trigger auto-cashout
            }

            simulatedPlayers.forEach(player => {
                if (player.status === 'playing') {
                    // More sophisticated cashout logic based on multiplier ranges
                    let cashoutChance = 0;
                    
                    if (multiplier >= 1.5 && multiplier < 2.0) {
                        cashoutChance = 0.15; // 15% chance to cash out at 1.5x-2x
                    } else if (multiplier >= 2.0 && multiplier < 3.0) {
                        cashoutChance = 0.25; // 25% chance to cash out at 2x-3x
                    } else if (multiplier >= 3.0 && multiplier < 5.0) {
                        cashoutChance = 0.20; // 20% chance to cash out at 3x-5x
                    } else if (multiplier >= 5.0 && multiplier < 10.0) {
                        cashoutChance = 0.15; // 15% chance to cash out at 5x-10x
                    } else if (multiplier >= 10.0) {
                        cashoutChance = 0.30; // 30% chance to cash out at 10x+
                    }
                    
                    // Additional random factor for more realistic behavior
                    cashoutChance += Math.random() * 0.05;
                    
                    if (Math.random() < cashoutChance) {
                        player.cashout = multiplier;
                        player.won = player.bet * player.cashout;
                        player.status = 'cashed out';
                    } else {
                        player.status = 'busted'; // Default to busted if not cashed out
                    }
                }
            });
            updatePlayersTable();

            // More aggressive scaling for high multipliers
            if (multiplier > dynamicMaxMultiplierY * 0.7) { 
                let nextMax = Y_AXIS_BREAKPOINTS.find(bp => bp > dynamicMaxMultiplierY);
                if (nextMax) {
                    dynamicMaxMultiplierY = nextMax;
                } else {
                    // For very high multipliers, use exponential scaling
                    dynamicMaxMultiplierY = Math.max(dynamicMaxMultiplierY * 2, multiplier * 1.5);
                }
            }

            gameTicks++;
            // Only add point if it's within the visible X range
            const currentX = ticksToX(gameTicks);
            if (currentX <= gameCanvas.width - PADDING_X) {
                curvePoints.push({ x: currentX, y: multToY(multiplier) });
            } else {
                // If we go beyond the X-axis, shift the graph
                const shiftAmount = currentX - (gameCanvas.width - PADDING_X);
                curvePoints = curvePoints.map(p => ({ x: p.x - shiftAmount, y: p.y }));
                // Also update the starting point to maintain relative position
                curvePoints[0].x = PADDING_X; // Reset the origin if it shifts too far
            }

            if (multiplier >= crashMultiplier) {
                crash();
            }
        }

        // Main animation loop for drawing
        function animate() {
            drawGraph();
            requestAnimationFrame(animate);
        }

        async function cashOut() {
            if (!isGameRunning || hasCashedOut || !betPlacedForNextRound) return;

            hasCashedOut = true;
            cashoutButton.disabled = true;
            cashoutButton.querySelector('.cashout-label').textContent = 'CASHED OUT';

            const winAmount = currentBetPlaced * multiplier;
            showMessage(`Cashed out at ${multiplier.toFixed(2)}x! You won ${winAmount.toFixed(2)}`, 'var(--success-color)');
            showMessage(`Cashed out at ${multiplier.toFixed(2)}x! You won ${winAmount.toFixed(2)} KES`, 'var(--success-color)');
            if (isSoundInitialized) cashoutSynth.triggerAttackRelease("E5", "8n");

            if (multiplier >= 10) {
                startConfetti();
            }
            
            // Add winnings to balance
            await updateWalletAmount(winAmount);
            await loadUserData(); // Refresh UI with new balance
            // Resolve the bet in Firestore
            await resolveBet(currentBetId, 'won', multiplier);
        }

        // Prevent multiple crash calls
        let isCrashing = false;

        // Immediately add crash to history display
        function addCrashToHistoryImmediately(crashMultiplier) {
            try {
                console.log(`Adding crash ${crashMultiplier.toFixed(2)}x to history immediately`);
                
                if (!crashHistoryDisplay) {
                    console.error('Crash history display element not found');
                    return;
                }
                
                // Remove newest indicator from all existing items
                Array.from(crashHistoryDisplay.children).forEach(child => {
                    child.classList.remove('crash-newest');
                });
                
                const span = document.createElement('span');
                span.textContent = `${crashMultiplier.toFixed(2)}x`;
                if (crashMultiplier < 2) span.className = 'crash-red crash-newest';
                else if (crashMultiplier < 10) span.className = 'crash-green crash-newest';
                else span.className = 'crash-purple crash-newest';
                
                // Add to the beginning of the history (newest first)
                if (crashHistoryDisplay.firstChild) {
                    crashHistoryDisplay.insertBefore(span, crashHistoryDisplay.firstChild);
                } else {
                    crashHistoryDisplay.appendChild(span);
                }
                
                // Remove excess items from the end to maintain MAX_HISTORY_ITEMS
                while (crashHistoryDisplay.children.length > MAX_HISTORY_ITEMS) {
                    crashHistoryDisplay.removeChild(crashHistoryDisplay.lastChild);
                }
                
                console.log(`History now has ${crashHistoryDisplay.children.length} items`);
            } catch (e) {
                console.error('Error adding crash to history immediately:', e);
            }
        }

        async function crash() {
            // Prevent multiple crash calls
            if (isCrashing || !isGameRunning) {
                console.log('Crash already in progress or game not running, skipping...');
                return;
            }
            
            isCrashing = true;
            console.log(`Crash triggered at ${multiplier.toFixed(2)}x`);
            
            // Clear game logic interval immediately
            if (gameLogicInterval) {
                clearInterval(gameLogicInterval);
                gameLogicInterval = null;
            }
            isGameRunning = false;
            updateGameStatus('Crashed', 'crashed');
            
            // Update game state
            updateGameState('crashed', { roundNumber: gameState.roundNumber + 1 });
            
            bustedTextOverlay.textContent = `Busted @ ${multiplier.toFixed(2)}x`;
            bustedTextOverlay.style.display = 'block';
            if (isSoundInitialized) crashSynth.triggerAttackRelease("8n");
            
            // Check if the user had an active bet and did not cash out
            if (betPlacedForNextRound && !hasCashedOut) {
                // Resolve the bet as 'lost' in Firestore
                await resolveBet(currentBetId, 'lost', multiplier);
                showMessage(`Crashed at ${multiplier.toFixed(2)}x! You lost your bet.`, 'var(--danger-color)');
            } else if (betPlacedForNextRound && hasCashedOut) {
                // User already cashed out, just show the final crash point
                 showMessage(`The jet flew to ${multiplier.toFixed(2)}x.`, 'var(--secondary-color)');
            } else {
                // User was not playing
                showMessage(`The jet flew to ${multiplier.toFixed(2)}x.`, 'var(--secondary-color)');
            }

            // Always save crash data locally first as primary backup
            const crashData = { 
                crash_multiplier: multiplier, 
                created_at: new Date(),
                round_number: gameState.roundNumber,
                timestamp: Date.now()
            };
            
            // Save to localStorage immediately as primary backup
            try {
                const localCrashes = JSON.parse(localStorage.getItem('localCrashes') || '[]');
                localCrashes.push(crashData);
                localStorage.setItem('localCrashes', JSON.stringify(localCrashes));
                console.log('Crash data saved locally as primary backup');
            } catch (localError) {
                console.error('Failed to save locally:', localError);
            }
            
            // Try to save to Firestore as secondary
            try {
                console.log('Saving crash data to Firestore:', crashData);
                const firestoreData = {
                    ...crashData,
                    created_at: fire.serverTimestamp()
                };
                await fire.addDoc(fire.collection(fire.db, 'game_rounds'), firestoreData);
                console.log('Crash data saved to Firestore successfully');
            } catch (e) { 
                console.error('Error saving crash multiplier to Firestore:', e);
                // Local backup already saved above
            }
            
            // Immediately add crash to local display before Firestore fetch
            addCrashToHistoryImmediately(multiplier);
            
            // Update crash history display from Firestore with better error handling
            try {
                await updateCrashHistoryDisplay();
            } catch (e) {
                console.error('Error updating crash history display:', e);
            }
            
            // Force immediate UI update after multiple delays to ensure it shows
            setTimeout(() => {
                try {
                    updateCrashHistoryDisplay();
                } catch (e) {
                    console.error('Error in delayed crash history update:', e);
                }
            }, 500);
            
            setTimeout(() => {
                try {
                    updateCrashHistoryDisplay();
                } catch (e) {
                    console.error('Error in second delayed crash history update:', e);
                }
            }, 1500);
            
            setTimeout(() => {
                try {
                    updateCrashHistoryDisplay();
                } catch (e) {
                    console.error('Error in third delayed crash history update:', e);
                }
            }, 3000);

            cashoutButton.disabled = true; 

            simulatedPlayers.forEach(player => {
                if (player.status === 'playing') {
                    player.status = 'busted';
                }
            });
            updatePlayersTable();

            const delay = 3000 + Math.random() * 2000; 
            showMessage(`Next round in ${Math.round(delay/1000)} seconds...`, 'white');
            setTimeout(() => {
                isCrashing = false; // Reset crash flag
                startPreRoundCountdown();
            }, delay);
        }

        function resetAnimation() {
            multiplier = 1.00;
            gameTicks = 0;
            
            // Reset flight path to start from bottom-left corner
            curvePoints = [];
            const startX = PADDING_X;
            const startY = gameCanvas.height - PADDING_Y; // Force bottom of canvas
            curvePoints.push({ x: startX, y: startY });
            
            dynamicMaxMultiplierY = 10.0; 
            drawGraph(); 
            multiplierDisplayOverlay.textContent = '1.00x';
            bustedTextOverlay.style.display = 'none'; 

            // Reset button states for the new round
            if (betButton) betButton.style.display = 'flex';
            if (cashoutButton) cashoutButton.style.display = 'none';
            if (cashoutButton) cashoutButton.disabled = false;
            if (cashoutButton?.querySelector('.cashout-label')) cashoutButton.querySelector('.cashout-label').textContent = 'CASHOUT';
            if (betButton?.querySelector('span:first-child')) betButton.querySelector('span:first-child').textContent = 'BET';
        }

        function showMessage(text, color = 'white', targetElement = messageDisplay) {
            // Use the new overlay for game state messages, and the old one for bet-specific feedback
            if (gameStatusOverlay && ['Next round', 'Round started', 'The jet flew', 'Place your bet', 'Watch the game'].some(phrase => text.includes(phrase))) {
                // Extract the core message without the countdown part
                let coreMessage = text;
                if (text.includes("Next round starts in")) {
                    coreMessage = "Place your bet!";
                }

                gameStatusOverlay.textContent = coreMessage;
                gameStatusOverlay.style.color = color;
                gameStatusOverlay.style.display = 'block';
                gameStatusOverlay.style.opacity = 1;
            } else {
                targetElement.innerHTML = text;
                targetElement.style.color = color;
            }
        }

		// Fetch crash history from Firestore
        async function updateCrashHistoryDisplay() {
			try {
				console.log('Updating crash history display...');
                // Hide the game status overlay when updating history (pre-round)
                if (gameStatusOverlay) gameStatusOverlay.style.opacity = 0;
				
				let allRounds = [];
				
				// Get data from Firestore
				try {
					const q = fire.query(
						fire.collection(fire.db, 'game_rounds'),
						fire.limit(100) // Increased limit to get more data
					);
					const snap = await fire.getDocs(q);
					allRounds = snap.docs.map(doc => ({
						id: doc.id,
						...doc.data(),
						source: 'firestore'
					}));
					console.log(`Fetched ${allRounds.length} crash rounds from Firestore`);
				} catch (firestoreError) {
					console.error('Firestore fetch failed:', firestoreError);
				}
				
				// Get local fallback data
				try {
					const localCrashes = JSON.parse(localStorage.getItem('localCrashes') || '[]');
					const localRounds = localCrashes.map((crash, index) => ({
						id: `local_${index}`,
						...crash,
						source: 'local'
					}));
					allRounds = [...allRounds, ...localRounds];
					console.log(`Added ${localRounds.length} local crash rounds`);
				} catch (localError) {
					console.error('Local data fetch failed:', localError);
				}
				
				// Sort by created_at in JavaScript with better fallback
				allRounds.sort((a, b) => {
					// Try server timestamp first
					const aTime = a.created_at?.seconds || a.created_at?.toDate?.()?.getTime() || a.timestamp || 0;
					const bTime = b.created_at?.seconds || b.created_at?.toDate?.()?.getTime() || b.timestamp || 0;
					return bTime - aTime; // Descending order (newest first)
				});
				
				const recentRounds = allRounds.slice(0, MAX_HISTORY_ITEMS);
				console.log(`Displaying ${recentRounds.length} recent rounds`);
				
				// Clear and rebuild the display
				crashHistoryDisplay.innerHTML = ''; 
				recentRounds.forEach((d, index) => {
					if (!d.crash_multiplier) {
						console.warn(`Round ${index} missing crash_multiplier:`, d);
						return;
					}
					
					const span = document.createElement('span');
					span.textContent = `${Number(d.crash_multiplier).toFixed(2)}x`;
					if (d.crash_multiplier < 2) span.className = 'crash-red';
					else if (d.crash_multiplier < 10) span.className = 'crash-green';
					else span.className = 'crash-purple';
					
					// Add indicator for local data
					if (d.source === 'local') {
						span.title = 'Local data (Firestore unavailable)';
						span.style.opacity = '0.8';
					}
					
					// Add to the beginning to maintain newest-first order
					if (crashHistoryDisplay.firstChild) {
						crashHistoryDisplay.insertBefore(span, crashHistoryDisplay.firstChild);
					} else {
						crashHistoryDisplay.appendChild(span);
					}
				});
				
				console.log('Crash history display updated successfully');
			} catch (e) { 
				console.error('Error fetching crash history:', e);
				crashHistoryDisplay.innerHTML = '<span style="color: #888;">Error loading history</span>';
			}
        }

        // Force refresh crash history (can be called externally)
        function refreshCrashHistory() {
            console.log('Force refreshing crash history...');
            updateCrashHistoryDisplay();
        }

        // Expose refresh function globally
        window.refreshCrashHistory = refreshCrashHistory;

        function updatePlayersTable() {
            playersTableBody.innerHTML = ''; 
            simulatedPlayers.forEach(player => {
                const row = document.createElement('tr');
                if (isLoggedIn && player.id === currentUserId) {
                    row.classList.add('highlighted-player');
                }
                row.innerHTML = `
                    <td><span class="player-avatar">${player.name.substring(0, 2).toUpperCase()}</span> ${player.name}</td>
                    <td class="amount-cell">${player.bet.toFixed(2)}</td>
                    <td class="cashout-cell ${player.status === 'cashed out' ? 'cashed-out' : player.status === 'busted' ? 'busted' : ''}">${player.cashout ? player.cashout.toFixed(2) + 'x' : '-'}</td>
                    <td class="won-cell">${player.won ? player.won.toFixed(2) : '-'}</td>
                `;
                playersTableBody.appendChild(row);
            });
        }

		async function updateLeaderboardDisplay() {
			try {
				console.log('Loading leaderboard data...');
				
				// Get game rounds without orderBy to avoid index issues
				const roundsQuery = fire.query(
					fire.collection(fire.db, 'game_rounds'),
					fire.limit(50) // Get more data to sort in JavaScript
				);
				const roundsSnap = await fire.getDocs(roundsQuery);
				const allRounds = roundsSnap.docs.map(doc => ({
					id: doc.id,
					...doc.data()
				}));
				
				// Sort by crash_multiplier in JavaScript
				const topMultipliers = allRounds
					.sort((a, b) => (b.crash_multiplier || 0) - (a.crash_multiplier || 0))
					.slice(0, 10)
					.map((item, index) => ({
						rank: index + 1,
						multiplier: item.crash_multiplier || 0,
						created_at: item.created_at
					}));

				console.log('Top multipliers:', topMultipliers);

				// Get won bets without orderBy to avoid index issues
				const betsQuery = fire.query(
					fire.collection(fire.db, 'bets'),
					fire.where('result_status', '==', 'won'),
					fire.limit(50) // Get more data to sort in JavaScript
				);
				const betsSnap = await fire.getDocs(betsQuery);
				const allBets = betsSnap.docs.map(doc => ({
					id: doc.id,
					...doc.data()
				}));
				
				// Sort by payout in JavaScript
				const sortedBets = allBets
					.sort((a, b) => (b.payout || 0) - (a.payout || 0))
					.slice(0, 10);
				
				const topWinnings = [];
				
				for (const bet of sortedBets) {
					try {
						const profileSnap = await fire.getDoc(fire.doc(fire.db, 'profiles', bet.user_id));
						const profile = profileSnap.exists() ? profileSnap.data() : { nickname: 'Anonymous' };
						topWinnings.push({
							rank: topWinnings.length + 1,
							nickname: profile.nickname || 'Anonymous',
							winnings: bet.payout || 0,
							multiplier: bet.multiplier || 0,
							created_at: bet.created_at
						});
					} catch (profileError) {
						console.warn('Error fetching profile for user:', bet.user_id, profileError);
						topWinnings.push({
							rank: topWinnings.length + 1,
							nickname: 'Anonymous',
							winnings: bet.payout || 0,
							multiplier: bet.multiplier || 0,
							created_at: bet.created_at
						});
					}
				}

				console.log('Top winnings:', topWinnings);

				// Update multiplier leaderboard
				leaderboardMultiplierBody.innerHTML = '';
				if (topMultipliers.length === 0) {
					leaderboardMultiplierBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #888;">No data available</td></tr>';
				} else {
					topMultipliers.forEach(item => {
						const row = document.createElement('tr');
						row.innerHTML = `
							<td class="rank-cell">#${item.rank}</td>
							<td class="multiplier-cell">${Number(item.multiplier).toFixed(2)}x</td>
							<td>${item.created_at ? new Date(item.created_at.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
						`;
						leaderboardMultiplierBody.appendChild(row);
					});
				}

				// Update winnings leaderboard
				leaderboardWinningsBody.innerHTML = '';
				if (topWinnings.length === 0) {
					leaderboardWinningsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">No data available</td></tr>';
				} else {
					topWinnings.forEach(item => {
						const row = document.createElement('tr');
						row.innerHTML = `
							<td class="rank-cell">#${item.rank}</td>
							<td>${item.nickname}</td>
							<td class="winnings-cell">${Number(item.winnings).toFixed(2)} KES</td>
							<td class="multiplier-cell">${Number(item.multiplier).toFixed(2)}x</td>
						`;
						leaderboardWinningsBody.appendChild(row);
					});
				}
			} catch (e) {
				console.error('Error loading leaderboard:', e);
				console.error('Error details:', e.code, e.message);
				
				let errorMessage = 'Error loading data';
				if (e.code === 'failed-precondition') {
					errorMessage = 'Database index needed. Please contact support.';
				} else if (e.code === 'permission-denied') {
					errorMessage = 'Permission denied. Please log in again.';
				}
				
				leaderboardMultiplierBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #ff4444;">${errorMessage}</td></tr>`;
				leaderboardWinningsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #ff4444;">${errorMessage}</td></tr>`;
			}
        }

        function showModal(modalElement) {
            modalElement.style.display = 'flex';
            setTimeout(() => modalElement.classList.add('show'), 10);
            document.body.classList.add('modal-open');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('show');
            setTimeout(() => {
                modalElement.style.display = 'none';
                document.body.classList.remove('modal-open');
            }, 300);
        }

        function showSpinner() { loadingOverlay.style.display = 'flex'; }
        function hideSpinner() { loadingOverlay.style.display = 'none'; }

        // --- Event Listeners ---
        betButton.addEventListener('click', async () => {
            const betAmount = parseFloat(betAmountInput.value);
            if (betButton.disabled) return;

            // Validation
            if (isNaN(betAmount) || betAmount <= 0) {
                showMessage("Invalid bet amount. Please enter a positive number.", "var(--danger-color)");
                betAmountInput.classList.add('input-error');
                return;
            }
            if (betAmount > 3000) {
                showMessage("Maximum bet amount is 3000 KES.", "var(--danger-color)");
                betAmountInput.classList.add('input-error');
                return;
            }
            if (betAmount > balance) {
                showMessage(`Insufficient balance. Available: ${balance.toFixed(2)} KES`, "var(--danger-color)");
                betAmountInput.classList.add('input-error');
                return;
            }
            if (!isLoggedIn) {
                showMessage("Please log in to place a bet.", "var(--danger-color)");
                return;
            }

            // Clear any error states
            betAmountInput.classList.remove('input-error');

                // Place the bet
                showSpinner();
                try {
                    // 1. Deduct money from wallet on the client side for responsiveness
                    await updateWalletAmount(-betAmount);
                    await loadUserData(); // Refresh balance in UI

                    // 2. Place the bet in Firestore and get the bet ID
                    currentBetId = await placeBet(betAmount, null); // autoCashout removed

                    // 3. Update UI to show the bet is placed for the next round
                    betPlacedForNextRound = true;
                    showMessage(`Bet for next round placed: ${betAmount.toFixed(2)} KES`, "var(--success-color)");
                    betButton.disabled = true;
                    betButton.querySelector('span:first-child').textContent = 'BET PLACED';
                    betButton.style.backgroundColor = 'var(--success-color)';
                    betAmountInput.disabled = true;
                    bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = true);

                } catch (e) {
                    showMessage("Failed to place bet. Please try again.", "var(--danger-color)");
                    console.error('Bet placement error:', e);
                } finally {
                    hideSpinner();
                }
        });

        // Add event listeners for quick bet buttons
        quickBetButtons1.forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) return;
                const betValue = parseFloat(button.getAttribute('data-bet'));
                betAmountInput.value = betValue;
                // Manually trigger the input event to update the main bet button text
                betAmountInput.dispatchEvent(new Event('input'));
            });
        });

        // Add event listeners for amount adjustment buttons
        amountAdjustButtons1.forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) return;
                let currentValue = parseFloat(betAmountInput.value) || 0;
                const adjustment = button.textContent === '+' ? 100 : -100;
                let newValue = currentValue + adjustment;
                if (newValue < 1) {
                    newValue = 1; // Minimum bet is 1
                }
                betAmountInput.value = newValue;
                // Manually trigger the input event to update the main bet button text
                betAmountInput.dispatchEvent(new Event('input'));
            });
        });

        // Event listener for Auto Bet toggle
        autoBetToggle.addEventListener('change', () => {
            isAutoBetEnabled = autoBetToggle.checked;
            updateBetUI();
        });

        // Event listeners for Bet/Auto tabs
        betModeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                betModeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                isAutoBetActive = tab.textContent === 'Auto';

                if (isAutoBetActive) {
                    autoBetControls.style.display = 'flex';
                    betButton.querySelector('span:first-child').textContent = isAutoBetEnabled ? 'STOP AUTO' : 'START AUTO';
                } else {
                    autoBetControls.style.display = 'none';
                    isAutoBetEnabled = false; // Always disable when switching away from auto tab
                    autoBetToggle.checked = false;
                    betButton.querySelector('span:first-child').textContent = 'BET';
                }
                updateBetUI();
            });
        });

        loginButton.addEventListener('click', async () => {
            const phoneOrEmail = loginMobileInput.value.trim();
            const password = loginPasswordInput.value.trim();
            showSpinner();

            // Set session persistence to 'local' to keep the user logged in.
            // This ensures the session lasts beyond a single tab or browser close.
            // The session token lasts for 1 hour and is auto-refreshed by the SDK.
            await fireAuth.setPersistence(fire.auth, fireAuth.browserLocalPersistence);

            try {
                // Reset message styles
                loginMessageDisplay.classList.remove('is-error','is-success');
                let emailToUse = '';
                if (/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(phoneOrEmail)) {
                    // Direct email login
                    emailToUse = phoneOrEmail;
            } else {
                    // Treat as phone; normalize to E.164 and look up mapping
                    const digits = phoneOrEmail.replace(/\D/g, '').replace(/^0/, '');
                    const e164Phone = '+254' + digits;
                    const mappingSnap = await fire.getDoc(fire.doc(fire.db, 'phone_emails', e164Phone));
                    if (mappingSnap.exists()) {
                        emailToUse = mappingSnap.data().email;
                    } else {
                        // Fallback to legacy derived email if mapping missing
                        emailToUse = digits + '@princealexjet.com';
                    }
                }

                await fireAuth.signInWithEmailAndPassword(fire.auth, emailToUse, password);
                await loadUserData();
                updateAuthUI();
                
                // Load bet history if My Bets tab is active
                const myBetsTab = document.querySelector('[data-tab="my-bets"]');
                if (myBetsTab && myBetsTab.classList.contains('active')) {
                    await loadMyBetHistory();
                }
                
                loginMessageDisplay.textContent = 'Login successful!';
                loginMessageDisplay.classList.add('is-success');
                loginMobileInput.classList.remove('input-error');
                loginPasswordInput.classList.remove('input-error');
                hideModal(loginModal);
            } catch (e) {
                loginMessageDisplay.textContent = e.message || 'Login failed. Please check your details and try again.';
                loginMessageDisplay.classList.add('is-error');
                loginMobileInput.classList.add('input-error');
                loginPasswordInput.classList.add('input-error');
            } finally { hideSpinner(); }
        });

        // Toggle password visibility buttons
        document.querySelectorAll('[data-toggle-password]').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = document.getElementById(btn.getAttribute('data-toggle-password'));
                if (!input) return;
                const isPassword = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPassword ? 'text' : 'password');
                btn.textContent = isPassword ? 'Hide' : 'Show';
            });
        });


        // Bet amount input validation
        betAmountInput.addEventListener('input', () => {
            const amount = parseFloat(betAmountInput.value);
            const betButtonAmount = document.getElementById('bet-button-amount');
            if (betButtonAmount) {
                betButtonAmount.textContent = `${(amount || 0).toFixed(2)} KSH`;
            }

            if (amount && amount > balance) {
                betAmountInput.classList.add('input-error');
                showMessage(`Insufficient balance. Available: ${balance.toFixed(2)} KES`, 'var(--danger-color)');
            } else {
                betAmountInput.classList.remove('input-error');
            }
        });

        // Function to update bet UI based on login state and balance
        function updateBetUI() {
            if (isLoggedIn) {
                const betButtonSpan = betButton.querySelector('span:first-child');
                if (isAutoBetActive) {
                    betButton.disabled = false;
                    betButtonSpan.textContent = isAutoBetEnabled ? 'STOP AUTO' : 'START AUTO';
                    betButton.style.backgroundColor = isAutoBetEnabled ? 'var(--danger-color)' : 'var(--success-color)';
                    betAmountInput.disabled = isAutoBetEnabled;
                    autoCashoutInput.disabled = isAutoBetEnabled;
                } else {
                    betButton.disabled = isGameRunning || betPlacedForNextRound; // Can only bet when game is not running and no bet is placed
                    betButtonSpan.textContent = 'BET';
                    betButton.style.backgroundColor = 'var(--accent-color)';
                    betAmountInput.disabled = isGameRunning || betPlacedForNextRound;
                }

                if (bettingModule1) bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = false);
            } else {
                if (betButton) {
                    betButton.disabled = true;
                    const span = betButton.querySelector('span:first-child');
                    if (span) span.textContent = 'LOGIN TO BET';
                    if (betButton) betButton.style.backgroundColor = '#555';
                }
                if (betAmountInput) betAmountInput.disabled = true; 
                if (autoCashoutInput) autoCashoutInput.disabled = true;
                if (bettingModule1) bettingModule1.querySelectorAll('.quick-bet-button, .amount-adjust-btn').forEach(btn => btn.disabled = true);
            }
        }

        // Cashout button event listener
        cashoutButton.addEventListener('click', async () => {
            if (!isGameRunning || hasCashedOut || !betPlacedForNextRound) {
                showMessage("No active bet to cash out.", "var(--danger-color)");
                return;
            }

            try {
                await cashOut();
            } catch (e) {
                console.error('Cashout error:', e);
                showMessage("Failed to cash out. Please try again.", "var(--danger-color)");
            }
        });

        createAccountButton.addEventListener('click', async () => {
            // Handle Auto Bet button logic
            if (isAutoBetActive) {
                isAutoBetEnabled = !isAutoBetEnabled;
                autoBetToggle.checked = isAutoBetEnabled;
                if (isAutoBetEnabled) {
                    showMessage('Auto-bet enabled for the next round.', 'var(--success-color)');
                } else {
                    showMessage('Auto-bet disabled.', 'var(--danger-color)');
                }
                updateBetUI();
                return; // Stop further execution for auto-bet toggle
            }



            const phone = signupMobileInput.value.trim();
            const emailInput = (document.getElementById('signup-email') || { value: '' }).value.trim();
            const password = signupPasswordInput.value.trim();
            const nickname = signupNicknameInput.value.trim();

            // Basic validation
            if (phone.length < 8 || !/^\d+$/.test(phone)) {
                signupMessageDisplay.textContent = "Please enter a valid mobile number (digits only, at least 8 digits).";
                signupMobileInput.classList.add('input-error');
                return;
            }
            if (password.length < 6) {
                signupMessageDisplay.textContent = "Password must be at least 6 characters long.";
                signupPasswordInput.classList.add('input-error');
                return;
            }
            if (nickname.length < 3) {
                signupMessageDisplay.textContent = "Nickname must be at least 3 characters long.";
                signupNicknameInput.classList.add('input-error');
                return;
            }

            signupMobileInput.classList.remove('input-error');
            signupPasswordInput.classList.remove('input-error');
            signupNicknameInput.classList.remove('input-error');

            showSpinner();
            try {
                signupMessageDisplay.classList.remove('is-error','is-success');
                // Normalize phone to E.164 for storage
                const normalizedPhone = phone.replace(/\D/g, '').replace(/^0/, '');
                const e164Phone = '+254' + normalizedPhone;
                const emailToUse = emailInput || (normalizedPhone + '@princealexjet.com');

                const cred = await fireAuth.createUserWithEmailAndPassword(fire.auth, emailToUse, password);
                try { await fireAuth.updateProfile(cred.user, { displayName: nickname }); } catch {}
                // Save profile with both phone and email
                await fire.setDoc(fire.doc(fire.db, 'profiles', cred.user.uid), { id: cred.user.uid, phone: e164Phone, email: emailToUse, nickname, created_at: fire.serverTimestamp() }, { merge: true });
                // Create phone->email mapping for login via phone later
                await fire.setDoc(fire.doc(fire.db, 'phone_emails', e164Phone), { email: emailToUse, uid: cred.user.uid, created_at: fire.serverTimestamp() });
                await fire.setDoc(fire.doc(fire.db, 'wallets', cred.user.uid), { user_id: cred.user.uid, balance: 0, bonus: 0, withdrawable: 0, created_at: fire.serverTimestamp(), updated_at: fire.serverTimestamp() }, { merge: true });
                signupMessageDisplay.textContent = 'Account created successfully! Please log in.';
                signupMessageDisplay.classList.add('is-success');
                hideModal(signupModal);
                showModal(loginModal);
            } catch (e) {
                signupMessageDisplay.textContent = e.message || 'Sign up failed. Please try again.';
                signupMessageDisplay.classList.add('is-error');
                if ((e.message || '').toLowerCase().includes('already in use')) {
                    signupMobileInput.classList.add('input-error');
            }
            } finally { hideSpinner(); }
        });

        topUpNowButton.addEventListener('click', async () => {
            const amount = parseFloat(depositAmountInput.value);
            if (isNaN(amount) || amount < 10) {
                showMessage("Minimum deposit is 10 KES.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
                depositAmountInput.classList.add('input-error');
                return;
            }
            depositAmountInput.classList.remove('input-error');
            showSpinner();
            await updateWalletAmount(amount);
            await loadUserData();
            hideSpinner();
            showMessage(`Successfully deposited ${amount.toFixed(2)} KES.`, "var(--success-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
        });

        withdrawNowButton.addEventListener('click', async () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const fee = 5;
            const total = amount + fee;
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { data: wallet } = await supabaseClient.from('wallets').select('*').eq('user_id', user.id).single();

            if (isNaN(amount) || amount < 100) {
                showMessage("Minimum withdrawal is 100 KES.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
                withdrawAmountInput.classList.add('input-error');
                return;
            }
            withdrawAmountInput.classList.remove('input-error');

            if ((wallet?.withdrawable || 0) >= total) {
                showSpinner();
                await updateWalletAmount(-total);
                await supabaseClient.from('transactions').insert({ user_id: user.id, type: 'withdraw', amount: amount, status: 'pending' });
                await loadUserData();
                hideSpinner();
                showMessage("Withdrawal requested! Please allow time for processing.", "var(--success-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
            } else {
                showMessage("Insufficient withdrawable balance.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
            }
        });
        
        // Update toDisburseSpan on withdraw amount input change
        withdrawAmountInput.addEventListener('input', () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const fee = 5;
            if (!isNaN(amount) && amount >= 0) {
                toDisburseSpan.textContent = (amount - fee).toFixed(2);
            } else {
                toDisburseSpan.textContent = '0.00';
            }
        });

        // Tab switching functionality
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');
                
                // Remove active class from all buttons and panes
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                button.classList.add('active');
                const targetPane = document.getElementById(`${targetTab}-tab-pane`);
                if (targetPane) {
                    targetPane.classList.add('active');
                }
                
                // Load data based on tab
                if (targetTab === 'my-bets') {
                    // Data is now loaded by the real-time listener, no action needed on click
                } else if (targetTab === 'leaderboard') {
                    updateLeaderboardDisplay();
                }
            });
        });
        dropdownLogout.addEventListener('click', async () => { 
            showSpinner();
            try { await fireAuth.signOut(fire.auth); } catch {}
            hideSpinner();
        });

        allCloseModalButtons.forEach(button => button.addEventListener('click', (e) => hideModal(document.getElementById(e.target.dataset.modalClose))));
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(loginModal); showModal(signupModal); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(signupModal); showModal(loginModal); });
        dropdownDepositWithdraw.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(depositWithdrawModal); });
        dropdownHowToPlay.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(howToPlayModal); });
        dropdownChangePassword.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(changePasswordModal); });
        showPasswordResetLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(loginModal); showModal(passwordResetModal); });
        backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(passwordResetModal); showModal(loginModal); });

        // Password Reset Logic
        resetPasswordButton.addEventListener('click', async () => {
            const mobile = resetMobileInput.value.trim();
            if (!mobile) {
                passwordResetMessageDisplay.textContent = "Please enter your mobile number.";
                resetMobileInput.classList.add('input-error');
                return;
            }
            resetMobileInput.classList.remove('input-error');
            showSpinner();
            try {
                passwordResetMessageDisplay.classList.remove('is-error','is-success');
                await fireAuth.sendPasswordResetEmail(fire.auth, mobile + '@princealexjet.com');
                passwordResetMessageDisplay.textContent = "Password reset link sent to your email.";
                passwordResetMessageDisplay.classList.add('is-success');
            } catch (e) {
                passwordResetMessageDisplay.textContent = e.message || 'Failed to send reset email.';
                passwordResetMessageDisplay.classList.add('is-error');
            } finally { hideSpinner(); }
        });

        // Change Password Logic
        updatePasswordButton.addEventListener('click', async () => {
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (newPassword.length < 6) {
                changePasswordMessageDisplay.textContent = "New password must be at least 6 characters long.";
                newPasswordInput.classList.add('input-error');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                changePasswordMessageDisplay.textContent = "New passwords do not match.";
                newPasswordInput.classList.add('input-error');
                confirmNewPasswordInput.classList.add('input-error');
                return;
            }
            
            newPasswordInput.classList.remove('input-error');
            confirmNewPasswordInput.classList.remove('input-error');

            showSpinner();
            try {
                changePasswordMessageDisplay.classList.remove('is-error','is-success');
                const user = fire.auth.currentUser;
                if (!user) throw new Error('Not logged in');
                await fireAuth.updatePassword(user, newPassword);
                changePasswordMessageDisplay.textContent = "Password updated successfully!";
                changePasswordMessageDisplay.classList.add('is-success');
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                setTimeout(() => hideModal(changePasswordModal), 2000);
            } catch (e) {
                changePasswordMessageDisplay.textContent = e.message || 'Failed to update password.';
                changePasswordMessageDisplay.classList.add('is-error');
            } finally { hideSpinner(); }
        });


        // Game state persistence
        let gameState = {
            isRunning: false,
            currentPhase: 'waiting', // 'waiting', 'countdown', 'flying', 'crashed'
            roundStartTime: null,
            lastUpdateTime: null,
            currentMultiplier: 1.0,
            roundNumber: 1
        };

        // Load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('princeAlexJetGameState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed };
                    console.log('Loaded game state:', gameState);
                } catch (e) {
                    console.log('Failed to parse saved game state, using defaults');
                }
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            gameState.lastUpdateTime = Date.now();
            localStorage.setItem('princeAlexJetGameState', JSON.stringify(gameState));
        }

        // Check if we should continue an existing game
        function shouldContinueGame() {
            if (!gameState.isRunning) return false;
            
            const now = Date.now();
            const timeSinceLastUpdate = now - (gameState.lastUpdateTime || 0);
            
            // If it's been more than 30 seconds since last update, restart
            if (timeSinceLastUpdate > 30000) {
                console.log('Game state too old, restarting...');
                return false;
            }
            
            return true;
        }

        // Update game state
        function updateGameState(phase, additionalData = {}) {
            gameState.currentPhase = phase;
            gameState.isRunning = phase !== 'waiting';
            Object.assign(gameState, additionalData);
            saveGameState();
        }

        // Calculate multiplier based on time elapsed
        function calculateMultiplier(timeElapsed) {
            let calculatedMultiplier = 1.0;
            const ticks = Math.floor(timeElapsed / 100); // 100ms per tick
            
            for (let i = 0; i < ticks; i++) {
                calculatedMultiplier += 0.01 + (calculatedMultiplier * 0.01);
            }
            
            return calculatedMultiplier;
        }

        // --- Admin Control Integration ---
        let adminControlListener = null;
        let multiplierControlListener = null;
        let adminSettings = {
            minMultiplier: 1.01,
            maxMultiplier: 1000,
            countdownTime: 6,
            nextCrashMultiplier: null,
            multiplierMode: 'fair' // Fair random distribution
        };

        let probabilitySettings = {
            ranges: [
                { min: 1.01, max: 2.00, probability: 50 },
                { min: 2.01, max: 6.00, probability: 30 },
                { min: 6.01, max: 20.00, probability: 10 },
                { min: 20.01, max: 1000.00, probability: 10 }
            ]
        };

        // Cache for probability settings to avoid repeated Firestore reads
        let probabilitySettingsCache = {
            lastUpdated: 0,
            data: null,
            cacheTimeout: 5000 // 5 seconds cache
        };

        function initializeAdminControls() {
            console.log('Initializing admin controls...');
            console.log('Firebase available:', !!fire);
            console.log('Firestore available:', !!fire.db);
            
            // Listen for game control commands
            adminControlListener = fire.onSnapshot(
                fire.doc(fire.db, 'admin_controls', 'game_control'),
                (doc) => {
                    console.log('Admin control document changed:', doc.exists());
                    if (doc.exists()) {
                        const data = doc.data();
                        console.log('Admin control data received:', data);
                        handleAdminGameControl(data);
                    } else {
                        console.log('Admin control document does not exist yet');
                    }
                },
                (error) => {
                    console.error('Error listening to admin controls:', error);
                }
            );
            console.log('Admin control listener set up');
            
            // Test the connection by trying to read the document
            fire.getDoc(fire.doc(fire.db, 'admin_controls', 'game_control'))
                .then((doc) => {
                    console.log('Test read of admin_controls/game_control:', doc.exists());
                    if (doc.exists()) {
                        console.log('Current admin control data:', doc.data());
                    }
                })
                .catch((error) => {
                    console.error('Error testing admin control connection:', error);
                });

            // Listen for multiplier control commands
            multiplierControlListener = fire.onSnapshot(
                fire.doc(fire.db, 'admin_controls', 'multiplier_control'),
                (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        handleAdminMultiplierControl(data);
                    }
                },
                (error) => {
                    console.error('Error listening to multiplier controls:', error);
                }
            );

            // Listen for probability settings changes (with debouncing)
            let probabilityUpdateTimeout = null;
            fire.onSnapshot(
                fire.doc(fire.db, 'admin_settings', 'probability_settings'),
                (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        console.log('Probability settings updated via Firestore:', data);
                        
                        // Debounce updates to prevent rapid changes
                        if (probabilityUpdateTimeout) {
                            clearTimeout(probabilityUpdateTimeout);
                        }
                        
                        probabilityUpdateTimeout = setTimeout(() => {
                            if (data.ranges && data.ranges.length === 4) {
                                probabilitySettings.ranges = data.ranges;
                                console.log('Updated probability ranges via Firestore:', probabilitySettings.ranges);
                            }
                            if (data.multiplierMode) {
                                adminSettings.multiplierMode = data.multiplierMode;
                                console.log('Updated multiplier mode via Firestore:', data.multiplierMode);
                            }
                        }, 100); // 100ms debounce
                    }
                },
                (error) => {
                    console.error('Error listening to probability settings:', error);
                }
            );

            // Load admin settings
            loadAdminSettings();
            loadProbabilitySettings();
        }

        async function handleAdminGameControl(data) {
            console.log('Received admin game control:', data);
            console.log('Current game state - isGameRunning:', isGameRunning, 'gameLogicInterval:', gameLogicInterval);
            
            switch (data.action) {
                case 'start':
                    console.log('Processing start command...');
                    if (!isGameRunning) {
                        console.log('Starting new game...');
                        startPreRoundCountdown();
                        updateGameStatus('Running', 'countdown');
                    } else {
                        console.log('Game already running, ignoring start command');
                    }
                    break;
                case 'pause':
                    console.log('Processing pause command...');
                    if (isGameRunning) {
                        console.log('Pausing game...');
                        clearInterval(gameLogicInterval);
                        gameLogicInterval = null;
                        isGameRunning = false;
                        updateGameStatus('Paused', 'paused');
                        showGameStatusMessage('Game Paused', 'warning');
                    } else {
                        console.log('Game not running, ignoring pause command');
                    }
                    break;
                case 'resume':
                    console.log('Processing resume command...');
                    if (!isGameRunning) {
                        console.log('Resuming game...');
                        // Resume from current multiplier if we have one
                        if (multiplier > 1.00) {
                            isGameRunning = true;
                            gameLogicInterval = setInterval(gameLoop, 100);
                            updateGameStatus('Running', 'flying');
                            showGameStatusMessage('Game Resumed', 'success');
                        } else {
                            // Start a new round if no current multiplier
                            startPreRoundCountdown();
                            updateGameStatus('Running', 'countdown');
                            showGameStatusMessage('Game Resumed - New Round Starting', 'success');
                        }
                    } else {
                        console.log('Game already running, ignoring resume command');
                    }
                    break;
                case 'stop':
                    console.log('Processing stop command...');
                    console.log('Stopping game...');
                    clearInterval(gameLogicInterval);
                    gameLogicInterval = null;
                    isGameRunning = false;
                    initializeUIForPreRound();
                    updateGameStatus('Stopped', 'stopped');
                    showGameStatusMessage('Game Stopped', 'danger');
                    break;
                case 'force_crash':
                    console.log('Processing force crash command...');
                    if (isGameRunning) {
                        console.log('Force crashing game...');
                        crash();
                    } else {
                        console.log('Game not running, ignoring force crash command');
                    }
                    break;
                case 'crash_now':
                    console.log('Processing crash now command...');
                    if (isGameRunning) {
                        console.log('Crashing game now...');
                        crash();
                    } else {
                        console.log('Game not running, ignoring crash now command');
                    }
                    break;
                default:
                    console.log('Unknown admin command:', data.action);
            }
        }

        async function handleAdminMultiplierControl(data) {
            console.log('Received admin multiplier control:', data);
            
            if (data.nextCrashMultiplier) {
                adminSettings.nextCrashMultiplier = data.nextCrashMultiplier;
                adminSettings.multiplierMode = data.mode || 'manual';
            }
        }

        async function loadAdminSettings() {
            try {
                const settingsRef = fire.doc(fire.db, 'admin_settings', 'game_settings');
                const settingsSnap = await fire.getDoc(settingsRef);
                
                if (settingsSnap.exists()) {
                    const settings = settingsSnap.data();
                    adminSettings.minMultiplier = settings.minMultiplier || 1.01;
                    adminSettings.maxMultiplier = settings.maxMultiplier || 1000;
                    adminSettings.countdownTime = settings.countdownTime || 6;
                }
            } catch (error) {
                console.error('Error loading admin settings:', error);
            }
        }

        function updateGameStatus(state, phase) {
            // Update game status in Firestore for admin monitoring
            const statusRef = fire.doc(fire.db, 'admin_controls', 'game_status');
            fire.setDoc(statusRef, {
                state: state,
                phase: phase,
                currentMultiplier: multiplier,
                playersOnline: simulatedPlayers.length,
                activeBets: currentBetId ? 1 : 0,
                timestamp: fire.serverTimestamp()
            }).catch(error => {
                console.error('Error updating game status:', error);
            });
        }

        function getAdminCrashMultiplier() {
            // Check if admin has set a specific multiplier
            if (adminSettings.nextCrashMultiplier && adminSettings.multiplierMode === 'manual') {
                const adminMultiplier = adminSettings.nextCrashMultiplier;
                adminSettings.nextCrashMultiplier = null; // Reset after use
                return adminMultiplier;
            }
            
            // Use probability-based generation if mode is probability
            if (adminSettings.multiplierMode === 'probability') {
                return generateProbabilityBasedMultiplier();
            }
            
            // Use original random generation
            const min = adminSettings.minMultiplier;
            const max = adminSettings.maxMultiplier;
            return Math.random() * (max - min) + min;
        }

        function generateProbabilityBasedMultiplier() {
            const random = Math.random() * 100;
            let cumulative = 0;

            console.log('Generating probability-based multiplier with settings:', probabilitySettings.ranges);

            for (const range of probabilitySettings.ranges) {
                cumulative += range.probability;
                if (random <= cumulative) {
                    const multiplier = Math.random() * (range.max - range.min) + range.min;
                    console.log(`Generated multiplier ${multiplier.toFixed(2)}x from range ${range.min}-${range.max} (${range.probability}%)`);
                    return multiplier;
                }
            }

            // Fallback to first range if something goes wrong
            const firstRange = probabilitySettings.ranges[0];
            const fallbackMultiplier = Math.random() * (firstRange.max - firstRange.min) + firstRange.min;
            console.log(`Fallback multiplier ${fallbackMultiplier.toFixed(2)}x from first range`);
            return fallbackMultiplier;
        }

        async function loadProbabilitySettings() {
            try {
                console.log('Loading probability settings...');
                
                // Check cache first
                const now = Date.now();
                if (probabilitySettingsCache.data && 
                    (now - probabilitySettingsCache.lastUpdated) < probabilitySettingsCache.cacheTimeout) {
                    console.log('Using cached probability settings');
                    const cachedData = probabilitySettingsCache.data;
                    if (cachedData.ranges && cachedData.ranges.length === 4) {
                        probabilitySettings.ranges = cachedData.ranges;
                    }
                    if (cachedData.multiplierMode) {
                        adminSettings.multiplierMode = cachedData.multiplierMode;
                    }
                    return;
                }
                
                const probabilityRef = fire.doc(fire.db, 'admin_settings', 'probability_settings');
                const probabilitySnap = await fire.getDoc(probabilityRef);
                
                if (probabilitySnap.exists()) {
                    const settings = probabilitySnap.data();
                    
                    // Update cache
                    probabilitySettingsCache.data = settings;
                    probabilitySettingsCache.lastUpdated = now;
                    
                    if (settings.ranges && settings.ranges.length === 4) {
                        probabilitySettings.ranges = settings.ranges;
                        console.log('Loaded probability settings:', probabilitySettings.ranges);
                    }
                    
                    // Update admin settings if available
                    if (settings.multiplierMode) {
                        adminSettings.multiplierMode = settings.multiplierMode;
                        console.log('Updated multiplier mode to:', settings.multiplierMode);
                    }
                } else {
                    console.log('No probability settings found, using defaults');
                }
            } catch (error) {
                console.error('Error loading probability settings:', error);
            }
        }

        // Direct admin command handler (fallback method)
        window.handleDirectAdminCommand = function(action) {
            console.log('Direct admin command received:', action);
            handleAdminGameControl({ action: action });
        };

        // Direct probability settings update handler
        window.handleDirectProbabilityUpdate = function(data) {
            console.log('Direct probability update received:', data);
            
            if (data.ranges && data.ranges.length === 4) {
                probabilitySettings.ranges = data.ranges;
                console.log('Updated probability ranges via direct communication:', probabilitySettings.ranges);
                
                // Update cache
                probabilitySettingsCache.data = data;
                probabilitySettingsCache.lastUpdated = Date.now();
            }
            
            if (data.multiplierMode) {
                adminSettings.multiplierMode = data.multiplierMode;
                console.log('Updated multiplier mode via direct communication:', data.multiplierMode);
            }
            
            // Show notification to user
            showGameStatusMessage('Probability settings updated!', 'success');
            
            // Test the new settings immediately
            console.log('Testing new probability settings:');
            for (let i = 0; i < 5; i++) {
                const testMultiplier = generateProbabilityBasedMultiplier();
                console.log(`Test ${i + 1}: ${testMultiplier.toFixed(2)}x`);
            }
        };

        // Direct multiplier settings update handler
        window.handleDirectMultiplierUpdate = function(data) {
            console.log('Direct multiplier update received:', data);
            
            if (data.minMultiplier !== undefined) {
                adminSettings.minMultiplier = data.minMultiplier;
                console.log('Updated min multiplier:', data.minMultiplier);
            }
            
            if (data.maxMultiplier !== undefined) {
                adminSettings.maxMultiplier = data.maxMultiplier;
                console.log('Updated max multiplier:', data.maxMultiplier);
            }
            
            if (data.nextCrashMultiplier !== undefined) {
                adminSettings.nextCrashMultiplier = data.nextCrashMultiplier;
                console.log('Updated next crash multiplier:', data.nextCrashMultiplier);
            }
            
            if (data.multiplierMode) {
                adminSettings.multiplierMode = data.multiplierMode;
                console.log('Updated multiplier mode:', data.multiplierMode);
            }
            
            // Show notification to user
            showGameStatusMessage('Multiplier settings updated!', 'success');
        };

        // Test function for admin controls (can be called from browser console)
        window.testAdminStart = function() {
            console.log('Testing admin start command...');
            handleAdminGameControl({ action: 'start' });
        };

        window.testAdminPause = function() {
            console.log('Testing admin pause command...');
            handleAdminGameControl({ action: 'pause' });
        };

        window.testAdminResume = function() {
            console.log('Testing admin resume command...');
            handleAdminGameControl({ action: 'resume' });
        };

        window.testAdminStop = function() {
            console.log('Testing admin stop command...');
            handleAdminGameControl({ action: 'stop' });
        };

        // Test functions for probability system
        window.testProbabilitySystem = function() {
            console.log('Testing probability system...');
            console.log('Current probability settings:', probabilitySettings);
            console.log('Current multiplier mode:', adminSettings.multiplierMode);
            
            // Generate 10 test multipliers
            console.log('Generating 10 test multipliers:');
            for (let i = 0; i < 10; i++) {
                const multiplier = generateProbabilityBasedMultiplier();
                console.log(`Test ${i + 1}: ${multiplier.toFixed(2)}x`);
            }
        };

        window.setProbabilityMode = function() {
            adminSettings.multiplierMode = 'probability';
            console.log('Set multiplier mode to probability');
        };

        window.setRandomMode = function() {
            adminSettings.multiplierMode = 'random';
            console.log('Set multiplier mode to random');
        };

        window.setManualMode = function() {
            adminSettings.multiplierMode = 'manual';
            console.log('Set multiplier mode to manual');
        };

        // Performance test function
        window.testProbabilityPerformance = function() {
            console.log('Testing probability system performance...');
            const startTime = performance.now();
            
            // Test 1000 probability-based multiplier generations
            for (let i = 0; i < 1000; i++) {
                generateProbabilityBasedMultiplier();
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            console.log(`Generated 1000 probability-based multipliers in ${duration.toFixed(2)}ms`);
            console.log(`Average time per generation: ${(duration / 1000).toFixed(4)}ms`);
            
            // Test current settings
            console.log('Current probability settings:', probabilitySettings);
            console.log('Current multiplier mode:', adminSettings.multiplierMode);
        };

        // Comprehensive probability system test
        window.testProbabilitySystemComprehensive = function() {
            console.log('=== COMPREHENSIVE PROBABILITY SYSTEM TEST ===');
            console.log('Current multiplier mode:', adminSettings.multiplierMode);
            console.log('Current probability settings:', probabilitySettings);
            
            // Test different modes
            const originalMode = adminSettings.multiplierMode;
            
            // Test probability mode
            console.log('\n--- Testing Probability Mode ---');
            adminSettings.multiplierMode = 'probability';
            for (let i = 0; i < 10; i++) {
                const multiplier = getCrashMultiplier();
                console.log(`Probability test ${i + 1}: ${multiplier.toFixed(2)}x`);
            }
            
            // Test random mode
            console.log('\n--- Testing Random Mode ---');
            adminSettings.multiplierMode = 'random';
            for (let i = 0; i < 10; i++) {
                const multiplier = getCrashMultiplier();
                console.log(`Random test ${i + 1}: ${multiplier.toFixed(2)}x`);
            }
            
            // Test manual mode
            console.log('\n--- Testing Manual Mode ---');
            adminSettings.multiplierMode = 'manual';
            adminSettings.nextCrashMultiplier = 5.50;
            for (let i = 0; i < 3; i++) {
                const multiplier = getCrashMultiplier();
                console.log(`Manual test ${i + 1}: ${multiplier.toFixed(2)}x`);
            }
            
            // Restore original mode
            adminSettings.multiplierMode = originalMode;
            console.log('\n=== TEST COMPLETE ===');
        };

        // Test authentic Aviator flight mechanics
        window.testAviatorFlightMechanics = function() {
            console.log('=== TESTING AUTHENTIC AVIATOR FLIGHT MECHANICS ===');
            
            // Simulate flight for 10 seconds
            const startTime = Date.now();
            const testMultipliers = [];
            let testTicks = 0;
            
            console.log('Simulating 10 seconds of flight...');
            
            const testInterval = setInterval(() => {
                testTicks++;
                const timeElapsed = testTicks * 50; // 50ms per tick
                const baseMultiplier = 1.0;
                const growthRate = 0.02;
                
                // Use the same calculation as the game
                let testMultiplier = baseMultiplier + (Math.pow(1 + growthRate, timeElapsed / 1000) - 1) * 0.5;
                const randomVariation = (Math.random() - 0.5) * 0.001;
                testMultiplier += randomVariation;
                testMultiplier = Math.max(1.00, testMultiplier);
                
                testMultipliers.push({
                    time: timeElapsed,
                    multiplier: testMultiplier,
                    tick: testTicks
                });
                
                console.log(`Tick ${testTicks}: ${testMultiplier.toFixed(2)}x (${timeElapsed}ms)`);
                
                if (timeElapsed >= 10000) { // 10 seconds
                    clearInterval(testInterval);
                    console.log('\n=== FLIGHT MECHANICS TEST COMPLETE ===');
                    console.log('Final multiplier:', testMultipliers[testMultipliers.length - 1].multiplier.toFixed(2));
                    console.log('Total ticks:', testTicks);
                    console.log('Average multiplier growth rate:', 
                        (testMultipliers[testMultipliers.length - 1].multiplier - 1) / 10);
                }
            }, 50);
        };

        // Test fair random multiplier distribution
        window.testFairDistribution = function() {
            console.log('=== TESTING FAIR MULTIPLIER DISTRIBUTION ===');
            console.log('Testing 1000 random multipliers...');
            
            const results = {
                range1: 0, // 1.01-3.0 (should be ~50%)
                range2: 0, // 3.0-10.0 (should be ~20%)
                range3: 0, // 10.0-20.0 (should be ~20%)
                range4: 0  // 20.0-1000.0 (should be ~10%)
            };
            
            const multipliers = [];
            
            for (let i = 0; i < 1000; i++) {
                const multiplier = generateFairRandomMultiplier();
                multipliers.push(multiplier);
                
                if (multiplier >= 1.01 && multiplier < 3.0) {
                    results.range1++;
                } else if (multiplier >= 3.0 && multiplier < 10.0) {
                    results.range2++;
                } else if (multiplier >= 10.0 && multiplier < 20.0) {
                    results.range3++;
                } else if (multiplier >= 20.0 && multiplier <= 1000.0) {
                    results.range4++;
                }
            }
            
            console.log('Distribution Results:');
            console.log(`Range 1.01-3.0: ${results.range1} (${(results.range1/10).toFixed(1)}%) - Expected: 50%`);
            console.log(`Range 3.0-10.0: ${results.range2} (${(results.range2/10).toFixed(1)}%) - Expected: 20%`);
            console.log(`Range 10.0-20.0: ${results.range3} (${(results.range3/10).toFixed(1)}%) - Expected: 20%`);
            console.log(`Range 20.0-1000.0: ${results.range4} (${(results.range4/10).toFixed(1)}%) - Expected: 10%`);
            
            console.log('\nSample multipliers:');
            for (let i = 0; i < 20; i++) {
                console.log(`${i + 1}: ${multipliers[i].toFixed(2)}x`);
            }
            
            console.log('=== FAIR DISTRIBUTION TEST COMPLETE ===');
        };

        // Visual debug function to test flight path
        window.debugFlightPath = function() {
            console.log('=== DEBUGGING FLIGHT PATH VISUALLY ===');
            
            // Clear current curve points
            curvePoints = [];
            
            // Test with a simple diagonal line from bottom-left to top-right
            const startX = PADDING_X;
            const startY = gameCanvas.height - PADDING_Y; // Bottom of canvas
            const endX = gameCanvas.width - PADDING_X;
            const endY = PADDING_Y; // Top of canvas
            
            console.log('Creating test diagonal line:');
            console.log('Start:', { x: startX, y: startY });
            console.log('End:', { x: endX, y: endY });
            
            // Create 20 points along the diagonal
            for (let i = 0; i <= 20; i++) {
                const t = i / 20;
                const x = startX + (endX - startX) * t;
                const y = startY + (endY - startY) * t;
                curvePoints.push({ x, y });
                console.log(`Point ${i}: x=${x.toFixed(1)}, y=${y.toFixed(1)}`);
            }
            
            // Force redraw
            drawGraph();
            console.log('Test diagonal line drawn. Check the canvas!');
        };

        // Function to show game status messages
        function showGameStatusMessage(message, type = 'info') {
            console.log('Showing game status message:', message, type);
            
            // Update the main message display
            if (messageDisplay) {
                messageDisplay.textContent = message;
                
                // Add appropriate styling based on type
                messageDisplay.style.color = type === 'success' ? 'var(--success-color)' : 
                                           type === 'warning' ? 'var(--warning-color)' : 
                                           type === 'danger' ? 'var(--danger-color)' : 
                                           'var(--text-color)';
                
                // Add a subtle animation
                messageDisplay.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    messageDisplay.style.transform = 'scale(1)';
                }, 200);
            }
            
            // Also show a temporary notification
            showNotification(message, type);
        }

        // Function to show temporary notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-color)' : 
                            type === 'warning' ? 'var(--warning-color)' : 
                            type === 'danger' ? 'var(--danger-color)' : 
                            'var(--secondary-color)'};
                color: ${type === 'success' || type === 'warning' || type === 'danger' ? 'white' : 'var(--text-color)'};
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // --- Initial Load ---
        window.onload = () => {
            gameCanvas.width = gameCanvas.clientWidth;
            gameCanvas.height = gameCanvas.clientHeight;
            confettiCanvas.width = confettiCanvas.clientWidth;
            confettiCanvas.height = confettiCanvas.clientHeight;
            
            initStars(); 
            updateAuthUI();
            startOnlineUsersFluctuation();
            // Load crash history for all users (logged in or not)
            updateCrashHistoryDisplay();
            
            // Initialize admin control listeners
            initializeAdminControls();
            
            // Load and check game state
            loadGameState();
            
            if (shouldContinueGame()) {
                console.log('Continuing existing game...');
                // Continue the game from where it left off
                if (gameState.currentPhase === 'countdown') {
                    const timeElapsed = Date.now() - gameState.roundStartTime;
                    const remainingTime = Math.max(0, 6000 - timeElapsed);
                    if (remainingTime > 0) {
                        preRoundTimer = Math.ceil(remainingTime / 1000);
                        countdownTimerOverlay.textContent = preRoundTimer;
                        setTimeout(() => lockBetsAndStartRound(), remainingTime);
                    } else {
                        lockBetsAndStartRound();
                    }
                } else if (gameState.currentPhase === 'flying') {
                    const timeElapsed = Date.now() - gameState.roundStartTime;
                    const currentMultiplier = calculateMultiplier(timeElapsed);
                    lockBetsAndStartRound();
                    // Continue from current multiplier
                    multiplier = currentMultiplier;
                } else {
                    startPreRoundCountdown();
                }
            } else {
                console.log('Starting new game...');
                startPreRoundCountdown(); // Start the game for all users
            }
            
            document.body.addEventListener('click', initializeAudio, { once: true });

            // Start the continuous animation loop
            animate();
        };

        window.addEventListener('resize', () => {
            gameCanvas.width = gameCanvas.clientWidth;
            gameCanvas.height = gameCanvas.clientHeight;
            confettiCanvas.width = confettiCanvas.clientWidth;
            confettiCanvas.height = confettiCanvas.clientHeight;
            initStars();
            // No need to call drawGraph directly here, animate() will handle it
        });

        // Firebase Auth state
        try {
            fireAuth.onAuthStateChanged(fire.auth, async (user) => {
                if (user) {
                    isLoggedIn = true;
                    currentUserId = user.uid;
                    await loadUserData();
                    updateAuthUI();
                } else {
                    isLoggedIn = false;
                    currentUserId = null;
                    updateAuthUI();
                }
            });
        } catch {}

        // Online Users Fluctuation
        function startOnlineUsersFluctuation() {
            onlineUsersFluctuationInterval = setInterval(() => {
                const fluctuation = Math.floor(Math.random() * 11) - 5; // -5 to +5
                let newOnlineUsers = baseOnlineUsers + fluctuation;
                if (newOnlineUsers < 50) newOnlineUsers = 50; // Minimum online users
                onlineUsersCount.textContent = newOnlineUsers;

                // Simulate playing users as a percentage of online users
                const playingPercentage = Math.random() * (0.4 - 0.2) + 0.2; // 20% to 40%
                playingUsersCount.textContent = Math.floor(newOnlineUsers * playingPercentage);
            }, 5000); // Update every 5 seconds
        }

        function updateOnlineAndPlayingCounts() {
            // Initial update
            onlineUsersCount.textContent = baseOnlineUsers;
            playingUsersCount.textContent = Math.floor(baseOnlineUsers * (Math.random() * (0.4 - 0.2) + 0.2));
        }

        // Confetti effect (simple example)
        let confetti = [];
        const MAX_CONFETTI = 100;

        function randomColor() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function createConfettiPiece(x, y) {
            return {
                x: x,
                y: y,
                size: Math.random() * 8 + 5,
                color: randomColor(),
                velX: (Math.random() - 0.5) * 10,
                velY: (Math.random() - 1) * 10,
                alpha: 1,
                gravity: 0.5,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5
            };
        }

        function updateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            for (let i = confetti.length - 1; i >= 0; i--) {
                let p = confetti[i];
                p.velY += p.gravity;
                p.x += p.velX;
                p.y += p.velY;
                p.alpha -= 0.01;
                p.rotation += p.rotationSpeed;

                if (p.alpha <= 0 || p.y > confettiCanvas.height) {
                    confetti.splice(i, 1);
                }

                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.rotation * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.globalAlpha = p.alpha;
                confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                confettiCtx.restore();
            }
            if (confetti.length > 0) {
                requestAnimationFrame(updateConfetti);
            }
        }

        function startConfetti() {
            confetti = []; // Clear existing confetti
            const centerX = confettiCanvas.width / 2;
            const centerY = confettiCanvas.height / 2;
            for (let i = 0; i < MAX_CONFETTI; i++) {
                confetti.push(createConfettiPiece(centerX, centerY));
            }
            updateConfetti(); // Start the confetti animation loop
        }

    </script>

</body>
</html>
