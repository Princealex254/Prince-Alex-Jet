<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Jet</title>
    <!-- Updated Font: Inter for general text, Orbitron for headings/numbers -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for WhatsApp icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- CryptoJS for provably fair model -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* General Styling */
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --accent-color: #ffc107;
            --danger-color: #d32f2f;
            --success-color: #388e3c;
            --text-color: #ffffff;
            --bg-color: #0a192f;
            --font-family-body: 'Inter', sans-serif; /* New: For general text */
            --font-family-display: 'Orbitron', sans-serif; /* For headings, multipliers, countdown */
            --dark-green: #2e7d32;
            --light-green: #4caf50;
            --graph-line-color: #FF0000; /* Red for the graph line */
            --graph-fill-color-top: rgba(255, 0, 0, 0.4); /* Top of gradient */
            --graph-fill-color-bottom: rgba(255, 0, 0, 0.05); /* Bottom of gradient, more transparent */
            --tab-bg-active: #2a3a57;
            --tab-bg-inactive: #1a2a47;
            --tab-border-active: var(--accent-color);
            --tab-border-inactive: #1a2a47;
            --table-header-bg: #1a2a47;
            --table-row-odd: #1a2a47;
            --table-row-even: #0d253f;
            --table-row-highlight: #3a668a;
            --purple-color: #8A2BE2; /* A nice purple */
            --modal-bg-gradient-start: #2e7d32;
            --modal-bg-gradient-end: #1a2a47;
            --modal-border-color: var(--light-green);
        }

        /* Light Theme Variables */
        body.light-theme {
            --primary-color: #bbdefb;
            --secondary-color: #64b5f6;
            --accent-color: #ff9800;
            --danger-color: #ef5350;
            --success-color: #66bb6a;
            --text-color: #212121;
            --bg-color: #e0f2f7;
            --dark-green: #81c784;
            --light-green: #a5d6a7;
            --graph-line-color: #FF5722; /* Orange-red for light theme */
            --graph-fill-color-top: rgba(255, 87, 34, 0.4);
            --graph-fill-color-bottom: rgba(255, 87, 34, 0.05);
            --tab-bg-active: #bbdefb;
            --tab-bg-inactive: #e3f2fd;
            --tab-border-active: var(--accent-color);
            --tab-border-inactive: #e3f2fd;
            --table-header-bg: #e3f2fd;
            --table-row-odd: #e3f2fd;
            --table-row-even: #bbdefb;
            --table-row-highlight: #90caf9;
            --purple-color: #9c27b0;
            --modal-bg-gradient-start: #a5d6a7;
            --modal-bg-gradient-end: #e3f2fd;
            --modal-border-color: var(--success-color);
        }

        body {
            margin: 0;
            font-family: var(--font-family-body); /* Using Inter for body */
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        body.modal-open {
            overflow: hidden; /* Disable scroll when modal is open */
        }

        /* Elements using display font */
        h1, .site-logo, #multiplier-display-overlay, #countdown-timer-overlay, #busted-text-overlay,
        .info-box p, .button, input[type="number"] {
            font-family: var(--font-family-display);
        }

        /* Top Bar Styling */
        .top-bar {
            width: 100%;
            background-color: var(--tab-bg-inactive); /* Use theme variable */
            padding: 10px 20px;
            display: flex;
            justify-content: space-between; /* Distribute items */
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
            gap: 10px;
            position: relative; /* For dropdown positioning */
            transition: background-color 0.5s ease;
        }

        .top-bar-left, .top-bar-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .site-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
            white-space: nowrap;
        }

        .top-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-size: 0.85rem;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        .top-button:hover {
            background-color: var(--primary-color); /* Adjusted for theme */
        }

        .balance-info {
            font-size: 0.9rem;
            color: var(--text-color);
            white-space: nowrap;
        }

        /* Account Dropdown Styles */
        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 20px;
            background-color: var(--tab-bg-active); /* Use theme variable */
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            min-width: 200px;
            z-index: 101;
            display: none;
            flex-direction: column;
            padding: 10px 0;
            margin-top: 5px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .account-dropdown.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
            text-align: center;
        }

        .dropdown-item {
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .dropdown-item i {
            font-size: 1.1rem;
            color: var(--secondary-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
            font-weight: 700;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }
        .dropdown-item.logout i {
            color: var(--danger-color);
        }

        /* Theme Toggle Button */
        #theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 5px;
            transition: color 0.3s ease;
        }
        #theme-toggle:hover {
            color: var(--accent-color);
        }

        /* Top Promotional Banner */
        .top-banner {
            width: 95%;
            background: linear-gradient(90deg, var(--dark-green), var(--tab-bg-inactive)); /* Use theme variables */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--light-green);
            padding: 15px 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            text-align: left;
            gap: 15px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .promo-image-container {
            flex-shrink: 0;
        }

        .promo-image {
            width: 120px;
            height: auto;
            border-radius: 10px;
            object-fit: cover;
        }

        .promo-text-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .promo-content {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .promo-button {
            background-color: var(--accent-color);
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }

        .promo-button:hover {
            background-color: #ffda47;
            transform: translateY(-2px);
        }

        /* Main Content Area (Game + Sidebar) */
        .main-content-area {
            display: flex;
            width: 95%;
            max-width: 1200px;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .game-container {
            flex: 2;
            min-width: 450px;
            background: linear-gradient(145deg, var(--table-row-even), var(--bg-color)); /* Use theme variables */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.1);
            border: 2px solid var(--secondary-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
            margin: 0;
        }

        /* Crash History Container */
        #crash-history-container {
            display: block;
            background-color: rgba(13, 71, 161, 0.3); /* Keep this specific for now */
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        #crash-history-container h3 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 1.2rem;
            text-align: center;
            font-family: var(--font-family-body);
        }

        #crash-history-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 8px;
            max-height: 80px;
            overflow-y: auto;
            padding: 5px 0;
        }

        #crash-history-display .crash-green,
        #crash-history-display .crash-red,
        #crash-history-display .crash-purple {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            font-family: var(--font-family-display);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        #crash-history-display .crash-green {
            background-color: var(--success-color);
            color: var(--text-color);
        }

        #crash-history-display .crash-red {
            background-color: var(--danger-color);
            color: var(--text-color);
        }

        #crash-history-display .crash-purple {
            background-color: var(--purple-color);
            color: var(--text-color);
        }


        /* Game Screen */
        .game-screen {
            position: relative;
            height: 400px;
            background: linear-gradient(to top, var(--bg-color), var(--primary-color), var(--table-row-highlight)); /* Use theme variables */
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: transparent;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
            z-index: 20; /* Above other overlays */
        }

        #multiplier-display-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            z-index: 10;
            display: none;
        }

        #countdown-timer-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 20px var(--accent-color);
            z-index: 11;
            display: none;
        }

        #busted-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 700;
            color: var(--danger-color);
            text-shadow: 0 0 10px rgba(211, 47, 47, 0.7);
            z-index: 12;
            display: none;
            white-space: nowrap;
        }
        
        @keyframes boom {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: start;
        }

        .control-panel {
            background-color: rgba(13, 71, 161, 0.3); /* Keep specific for now */
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: background-color 0.5s ease;
        }
        
        label {
            font-size: 1rem;
            color: var(--accent-color);
            font-family: var(--font-family-body);
        }

        input[type="number"], input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            color: var(--text-color);
            font-family: var(--font-family-display);
            font-size: 1.2rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        input[type="number"].input-error,
        input[type="text"].input-error,
        input[type="password"].input-error {
            border-color: var(--danger-color);
        }

        .button {
            padding: 15px 20px;
            font-size: 1.5rem;
            font-family: var(--font-family-display);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #bet-button {
            background-color: var(--success-color);
            color: var(--text-color);
        }

        #bet-button:hover {
            background-color: var(--light-green);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        #cashout-button {
            background-color: var(--accent-color);
            color: #000;
        }
        
        #cashout-button:hover {
            background-color: #ffeb3b;
            box-shadow: 0 6px 20px rgba(255, 235, 59, 0.4);
        }

        #cashout-button:disabled,
        #bet-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Quick Bet Buttons */
        .bet-quick-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-bet-button {
            padding: 8px 12px;
            font-size: 1rem;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            flex-grow: 1;
            max-width: 80px;
            font-family: var(--font-family-body);
        }

        .quick-bet-button:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .quick-bet-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Auto Cashout / Auto Bet Toggles */
        .auto-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .auto-options label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: var(--text-color);
            font-family: var(--font-family-body);
        }

        .auto-options .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .auto-options .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .auto-options .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .auto-options .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .auto-options input:checked + .slider {
            background-color: var(--success-color);
        }

        .auto-options input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }

        .auto-options input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        #message-display {
            text-align: center;
            font-size: 1.2rem;
            min-height: 25px;
            padding-top: 10px;
            font-family: var(--font-family-body);
        }

        /* Player History Container (now part of tabs) */
        #player-history-container {
            display: none;
            background-color: rgba(13, 71, 161, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
            width: 100%;
            box-sizing: border-box;
            margin-top: 0;
        }

        #player-history-container h3 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 1.2rem;
            text-align: center;
            font-family: var(--font-family-body);
        }

        #player-history-display {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            align-items: center;
            gap: 10px;
            font-family: var(--font-family-body);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item span {
            flex-shrink: 0;
        }

        .history-item .ticket-id {
            font-weight: 700;
            color: var(--secondary-color);
            min-width: 80px;
            text-align: left;
        }

        .history-item .bet-amount {
            color: var(--text-color);
            min-width: 60px;
            text-align: right;
        }

        .history-item .multiplier-info {
            flex-grow: 1;
            text-align: center;
        }

        .history-item .status {
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        .status-win {
            color: var(--success-color);
        }

        .status-loss {
            color: var(--danger-color);
        }


        /* Right Sidebar (Chat/History) */
        .right-sidebar {
            flex: 1;
            min-width: 280px;
            max-width: 350px;
            background: linear-gradient(145deg, var(--table-row-even), var(--bg-color)); /* Use theme variables */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.1);
            border: 2px solid var(--secondary-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 600px;
            box-sizing: border-box;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
            font-family: var(--font-family-body);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            font-size: 0.9rem;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
            font-family: var(--font-family-body);
        }

        .chat-message {
            margin-bottom: 5px;
        }

        .chat-message span {
            color: rgba(255, 255, 255, 0.5);
            margin-right: 5px;
        }

        .chat-input {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 8px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            color: var(--text-color);
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        .chat-input button {
            background-color: var(--success-color);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        /* New: Game Data Sections (Tabs) */
        .game-data-sections {
            width: 100%;
            background: linear-gradient(145deg, var(--table-row-even), var(--bg-color)); /* Use theme variables */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.1);
            border: 2px solid var(--secondary-color);
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .online-users-info {
            text-align: center;
            font-size: 1rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .tab-buttons {
            display: flex;
            width: 100%;
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-button {
            flex: 1;
            padding: 12px 0;
            background-color: var(--tab-bg-inactive);
            color: var(--text-color);
            border: none;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            z-index: 1;
            margin-bottom: -2px; /* Overlap border */
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            background-color: var(--tab-bg-active);
        }

        .tab-button.active {
            background-color: var(--tab-bg-active);
            color: var(--accent-color);
            border-bottom: 22px solid var(--tab-border-active);
            z-index: 2;
        }

        .tab-content {
            padding-top: 15px;
            min-height: 250px; /* Ensure content area has some height */
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Players Table Styling */
        .players-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        .players-table th, .players-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .players-table th {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            font-weight: 700;
            text-transform: uppercase;
        }

        .players-table tr:nth-child(odd) {
            background-color: var(--table-row-odd);
        }

        .players-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .players-table tr.highlighted-player {
            background-color: var(--table-row-highlight);
            color: var(--text-color);
            font-weight: bold;
        }

        .players-table .player-avatar {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 0.8em;
            text-align: center;
            margin-right: 5px;
            vertical-align: middle;
        }

        .players-table .amount-cell, .players-table .cashout-cell, .players-table .won-cell {
            text-align: right;
            white-space: nowrap;
        }

        .players-table .cashout-cell.cashed-out {
            color: var(--success-color);
            font-weight: bold;
        }

        .players-table .cashout-cell.busted {
            color: var(--danger-color);
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family-body);
            font-size: 0.9rem;
        }

        .leaderboard-table th, .leaderboard-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            font-weight: 700;
            text-transform: uppercase;
        }

        .leaderboard-table tr:nth-child(odd) {
            background-color: var(--table-row-odd);
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .leaderboard-table .rank-cell {
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
        }

        .leaderboard-table .multiplier-cell, .leaderboard-table .winnings-cell {
            text-align: right;
            font-weight: bold;
        }

        /* History Tab specific styles (re-using crash-history-container styles) */
        #history-tab-content {
            padding: 10px;
            background-color: rgba(13, 71, 161, 0.3);
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
            max-height: 250px;
            overflow-y: auto;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        #history-tab-content h3 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 1.2rem;
            text-align: center;
            font-family: var(--font-family-body);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(145deg, var(--modal-bg-gradient-start), var(--modal-bg-gradient-end));
            margin: auto;
            padding: 20px;
            border: 2px solid var(--modal-border-color);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .close-button {
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .modal-header {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-color);
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .modal-tab-button {
            flex: 1;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border: none;
            color: var(--text-color);
            font-family: var(--font-family-body);
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .modal-tab-button.active {
            background-color: rgba(0,0,0,0.4);
            font-weight: bold;
            color: var(--accent-color);
        }

        .modal-tab-content {
            padding-top: 15px;
        }

        .modal-tab-pane {
            display: none;
        }

        .modal-tab-pane.active {
            display: block;
        }

        .modal-balance-info {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 15px;
        }

        .balance-box {
            background-color: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-box span {
            display: block;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        .balance-box p {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0 0;
            color: var(--text-color);
        }

        .modal-input-group {
            margin-bottom: 15px;
            position: relative; /* For tooltip positioning */
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--accent-color);
            font-family: var(--font-family-body);
        }

        .modal-input-group input[type="number"], .modal-input-group input[type="text"], .modal-input-group input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            color: var(--text-color);
            font-family: var(--font-family-body);
            font-size: 1rem;
            box-sizing: border-box;
        }

        .modal-button {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .modal-button:hover {
            background-color: var(--light-green);
        }

        .modal-instructions {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
        }

        .modal-instructions p {
            margin: 0 0 8px 0;
        }

        .modal-instructions strong {
            color: var(--accent-color);
        }

        .modal-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .site-logo {
                width: 100%;
                text-align: center;
            }
            .top-bar-left, .top-bar-center {
                width: 100%;
                justify-content: center;
            }
            .main-content-area {
                flex-direction: column;
                align-items: center;
            }
            .game-container, .right-sidebar, .game-data-sections, .top-banner {
                min-width: unset;
                width: 95%;
            }
            .promo-image-container {
                display: none; /* Hide image on small screens */
            }
            .promo-text-content {
                align-items: center;
                text-align: center;
            }
            .controls {
                grid-template-columns: 1fr;
            }
            .chat-messages {
                font-size: 0.8rem;
            }

            /* Adjust font size for overlays on smaller screens */
            #multiplier-display-overlay {
                font-size: 2.5rem; /* Further reduced font size for mobile */
            }

            #countdown-timer-overlay {
                font-size: 3.5rem; /* Further reduced font size for mobile */
            }

            #busted-text-overlay {
                font-size: 1.5rem; /* Further reduced font size for mobile */
            }
        }

        /* Tooltip container */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position the tooltip above the text */
            left: 50%;
            margin-left: -100px; /* Use half of the width to center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-family: var(--font-family-body);
            font-size: 0.8rem;
        }

        /* Tooltip arrow */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Show the tooltip text when you hover over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* General button styling for inputs */
        .input-with-button {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .input-with-button input {
            flex-grow: 1;
            margin-bottom: 0; /* Override default input margin */
        }

        .input-with-button .clear-button {
            background-color: var(--danger-color);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            height: fit-content;
        }

        .input-with-button .clear-button:hover {
            background-color: #ef5350;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .auth-buttons .button {
            flex: 1;
            font-size: 1.1rem;
            padding: 10px;
        }
        #signupModal .modal-input-group,
        #loginModal .modal-input-group {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <span class="site-logo">Prince Alex Jet</span>
        </div>
        <div class="top-bar-center">
            <button class="top-button" id="auth-button">Login / Sign Up</button>
            <span class="balance-info" id="top-bar-balance" style="display:none;">1000.00 KES</span>
            <!-- New: Account Dropdown -->
            <div class="account-dropdown" id="account-dropdown">
                <div class="dropdown-header" id="dropdown-user-info"></div>
                <a href="#" class="dropdown-item" id="dropdown-deposit-withdraw" title="Manage your deposits and withdrawals">
                    <i class="fas fa-wallet"></i> Deposit / Withdraw
                </a>
                <a href="#" class="dropdown-item" id="dropdown-change-password" title="Change your account password">
                    <i class="fas fa-key"></i> Change Password
                </a>
                <a href="#" class="dropdown-item" id="dropdown-how-to-play" title="Learn how to play the game">
                    <i class="fas fa-question-circle"></i> How To Play
                </a>
                <a href="#" class="dropdown-item logout" id="dropdown-logout" title="Log out of your account">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
            <button id="theme-toggle" title="Toggle Dark/Light Theme">
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </div>

    <!-- Top Promotional Banner -->
    <div class="top-banner">
        <div class="promo-image-container">
            <img src="aviator.jpg" onerror="this.onerror=null; this.src='https://placehold.co/120x80/2e7d32/ffffff?text=PROMO+IMG';" alt="Promotional Image" class="promo-image">
        </div>
        <div class="promo-text-content">
            <div class="promo-content">
                TOP CRASHER PROMO<br>HIGHEST CRASHER AWARDED KES 2,500 HOURLY
            </div>
            <button class="promo-button" id="promo-click-button">CLICK HERE</button>
        </div>
    </div>

    <div class="main-content-area">
        <div class="game-container">
            <!-- The duplicate h1 "Prince Alex Jet" has been removed as requested -->

            <!-- Crash History Container (moved here and made visible) -->
            <div id="crash-history-container">
                <h3>Crash History</h3>
                <div id="crash-history-display"></div>
            </div>

            <div class="game-screen" id="game-screen">
                <canvas id="game-canvas"></canvas>
                <canvas id="confetti-canvas"></canvas> <!-- Confetti Canvas -->
                <div id="multiplier-display-overlay">1.00x</div>
                <div id="countdown-timer-overlay">10</div>
                <div id="busted-text-overlay"></div>
            </div>

            <div id="message-display">Login to place your bet!</div>

            <div class="controls">
                <div class="control-panel">
                    <label for="bet-amount">Bet Amount</label>
                    <div class="bet-quick-buttons">
                        <button class="button quick-bet-button" data-bet="10" disabled>10</button>
                        <button class="button quick-bet-button" data-bet="50" disabled>50</button>
                        <button class="button quick-bet-button" data-bet="100" disabled>100</button>
                        <button class="button quick-bet-button" data-bet="200" disabled>200</button>
                        <button class="button quick-bet-button" data-bet="300" disabled>300</button>
                        <button class="button quick-bet-button" data-bet="500" disabled>500</button>
                        <button class="button quick-bet-button" data-bet="3000" disabled>3000</button>
                    </div>
                    <input type="number" id="bet-amount" value="10" min="1" disabled>
                    <button class="button" id="bet-button" disabled>Login to Bet</button>

                    <div class="auto-options">
                        <label for="auto-cashout-input">Auto Cashout</label>
                        <input type="number" id="auto-cashout-input" value="1.1" min="1.01" step="0.01" disabled>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-bet-toggle" disabled>
                            <span class="slider"></span>
                        </label>
                        <label for="auto-bet-toggle">Auto Bet</label>
                    </div>
                </div>
                <div class="control-panel">
                    <label>Cash Out</label>
                    <button class="button" id="cashout-button" disabled>Cash Out</button>
                    <!-- Display potential winnings here -->
                    <p id="potential-win-display" style="font-size:1.2rem; color: var(--accent-color); text-align: center; margin-top: 5px;">0.00</p>
                </div>
            </div>
            
            <!-- Removed Provably Fair Info section as requested -->
            
            <!-- New: Game Data Sections (Tabs) -->
            <div class="game-data-sections">
                <div class="online-users-info">
                    Online Users: <span id="online-users-count">90</span> | Playing: <span id="playing-users-count">31</span>
                </div>
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="players">Players</button>
                    <button class="tab-button" data-tab="my-bets">My Bets</button>
                    <button class="tab-button" data-tab="leaderboard">Leaderboard</button> <!-- New Leaderboard Tab -->
                </div>
                <div class="tab-content">
                    <!-- Players Tab Content -->
                    <div id="players-tab-pane" class="tab-pane active">
                        <table class="players-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th class="amount-cell">Amount</th>
                                    <th class="cashout-cell">Cashout</th>
                                    <th class="won-cell">Won (KES)</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body">
                                <!-- Player rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- My Bets Tab Content -->
                    <div id="my-bets-tab-pane" class="tab-pane">
                        <div id="player-history-container-tab">
                            <h3>Your Bet History</h3>
                            <div id="player-history-display-tab">
                                <div class="history-item header-row" style="font-weight: bold; border-bottom: 2px solid rgba(255,255,255,0.2);">
                                    <span class="ticket-id">Ticket ID</span>
                                    <span class="bet-amount">Bet</span>
                                    <span class="multiplier-info">Multiplier</span>
                                    <span class="status">Status</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard Tab Content -->
                    <div id="leaderboard-tab-pane" class="tab-pane">
                        <h3>Top Crashers (Highest Multiplier)</h3>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th class="rank-cell">Rank</th>
                                    <th>Player</th>
                                    <th class="multiplier-cell">Multiplier</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-multiplier-body">
                                <!-- Top Multiplier leaders will be dynamically inserted here -->
                            </tbody>
                        </table>

                        <h3 style="margin-top: 20px;">Top Earners (Total Winnings)</h3>
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th class="rank-cell">Rank</th>
                                    <th>Player</th>
                                    <th class="winnings-cell">Winnings (KES)</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-winnings-body">
                                <!-- Top Winnings leaders will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Sidebar (Chat/History) -->
        <div class="right-sidebar">
            <div class="sidebar-header">Chat <i class="fas fa-comments" title="Live Chat"></i></div>
            <div class="chat-messages" id="chat-messages">
                <p class="chat-message"><span>00:00</span> Senko Mtato: Welcome to Prince Alex Jet!</p>
                <p class="chat-message"><span>00:01</span> Nyalez: Good luck everyone!</p>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="Type a message and click Enter" id="chat-input-field">
                <button id="chat-send-button" title="Send Message">&gt;</button>
            </div>
        </div>
    </div>

    <!-- Deposit/Withdraw Modal -->
    <div id="depositWithdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="depositWithdrawModal">&times;</span>
            <div class="modal-header">Wallet | 254717384875</div>

            <div class="modal-balance-info">
                <div class="balance-box">
                    <span>Balance</span>
                    <p id="modal-balance">0.00</p>
                </div>
                <div class="balance-box">
                    <span>Withdrawable</span>
                    <p id="modal-withdrawable">0.00</p>
                </div>
                <div class="balance-box">
                    <span>Bonus</span>
                    <p id="modal-bonus">0.00</p>
                </div>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab-button active" data-modal-tab="deposit">Deposit</button>
                <button class="modal-tab-button" data-modal-tab="withdraw">Withdraw</button>
                <button class="modal-tab-button" data-modal-tab="verify-deposit">Verify Deposit</button>
            </div>

            <div class="modal-tab-content">
                <!-- Deposit Tab Pane -->
                <div id="deposit-tab-pane" class="modal-tab-pane active">
                    <div class="modal-input-group">
                        <label for="deposit-amount">Amount</label>
                        <input type="number" id="deposit-amount" value="100" min="10">
                    </div>
                    <button class="modal-button" id="top-up-now-button">TOP UP NOW</button>
                    <div class="modal-instructions">
                        <p><strong>Instructions:</strong></p>
                        <p>Manual Deposit: Paybill: <strong>710739</strong>, A/c: <strong>0717384875</strong></p>
                        <p>Minimum amount: 10/-</p>
                        <p>Maximum amount: 150,000/-</p>
                        <p>Daily Transaction Limit: 300,000/-</p>
                    </div>
                </div>

                <!-- Withdraw Tab Pane -->
                <div id="withdraw-tab-pane" class="modal-tab-pane">
                    <div class="modal-input-group">
                        <label for="withdraw-amount">Amount</label>
                        <input type="number" id="withdraw-amount" value="100" min="100">
                    </div>
                    <p style="font-size:0.85rem; color: rgba(255,255,255,0.7); text-align: center;">Transfer Fee: 5 | To Disburse: <span id="to-disburse">95.00</span></p>
                    <button class="modal-button" id="withdraw-now-button">WITHDRAW NOW</button>
                    <div class="modal-instructions">
                        <p><strong>Instructions:</strong></p>
                        <p>Minimum Withdrawal amount: 100/-</p>
                        <p>Maximum Withdrawal amount: 150,000/-</p>
                        <p>Daily Transaction Limit: 300,000/-</p>
                        <p><strong>Withholding Tax (WHT):</strong> As provided for by the Income Tax Act, Cap 472, all gaming companies are required to withhold winnings at a rate of 20%. This is the Withholding Tax. In compliance with the law, we will deduct and remit to KRA 20% of all winnings.</p>
                    </div>
                </div>

                <!-- Verify Deposit Tab Pane -->
                <div id="verify-deposit-tab-pane" class="modal-tab-pane">
                    <div class="modal-input-group">
                        <label for="mpesa-code">M-PESA CODE</label>
                        <input type="text" id="mpesa-code" placeholder="-- RD56FR9UGO --">
                    </div>
                    <button class="modal-button" id="verify-mpesa-button">VERIFY M-PESA</button>
                    <div class="modal-instructions">
                        <p>Copy or type the M-PESA code e.g RD56FR9UGO you received on SMS from M-PESA then click Verify M-PESA.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="loginModal">&times;</span>
            <div class="modal-header">Login to Prince Alex Jet</div>
            <div class="modal-message-display" id="login-message-display"></div> <!-- New message display -->
            <div class="modal-input-group">
                <label for="login-mobile">Mobile</label>
                <input type="text" id="login-mobile" placeholder="e.g. 0722000000">
            </div>
            <div class="modal-input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password">
            </div>
            <button class="modal-button" id="login-button">Login</button>
            <a href="#" class="modal-link" id="show-signup-link">Don't have an account? Sign Up</a>
            <a href="#" class="modal-link" id="show-password-reset-link">Forgot Password?</a>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="signupModal">&times;</span>
            <div class="modal-header">Create Your Account</div>
            <div class="modal-message-display" id="signup-message-display"></div>
            <div class="modal-input-group">
                <label for="signup-mobile">Mobile</label>
                <input type="text" id="signup-mobile" placeholder="e.g. 0722000000">
            </div>
            <div class="modal-input-group">
                <label for="signup-nickname">Nickname</label>
                <input type="text" id="signup-nickname" placeholder="e.g. Hot-Crash">
            </div>
            <div class="modal-input-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password">
            </div>
            <button class="modal-button" id="create-account-button">CREATE ACCOUNT</button>
            <a href="#" class="modal-link" id="show-login-link">Already have an account? Login</a>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="passwordResetModal">&times;</span>
            <div class="modal-header">Password Reset</div>
            <div class="modal-message-display" id="password-reset-message-display"></div>
            <div class="modal-input-group">
                <label for="reset-mobile">Enter your Mobile Number</label>
                <input type="text" id="reset-mobile" placeholder="e.g. 0722000000">
            </div>
            <button class="modal-button" id="reset-password-button">RESET PASSWORD</button>
            <a href="#" class="modal-link" id="back-to-login-link">Back to Login</a>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- New: Change Password Modal (for logged-in users) -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="changePasswordModal">&times;</span>
            <div class="modal-header">Change Password</div>
            <div class="modal-message-display" id="change-password-message-display"></div>
            <div class="modal-input-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password">
            </div>
            <div class="modal-input-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password">
            </div>
            <div class="modal-input-group">
                <label for="confirm-new-password">Confirm New Password</label>
                <input type="password" id="confirm-new-password">
            </div>
            <button class="modal-button" id="update-password-button">UPDATE PASSWORD</button>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>

    <!-- New: How To Play Modal -->
    <div id="howToPlayModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="howToPlayModal">&times;</span>
            <div class="modal-header">How To Play Prince Alex Jet</div>
            <div class="modal-instructions" style="text-align: left;">
                <p>Welcome to Prince Alex Jet, the thrilling crash game where you predict how high the jet will fly before it crashes!</p>
                <p><strong>How to Play:</strong></p>
                <ol>
                    <li><strong>Place Your Bet:</strong> Before each round starts (during the 10-second countdown), enter your desired bet amount in the "Bet Amount" field or use the quick bet buttons.</li>
                    <li><strong>Set Auto Cashout (Optional):</strong> You can set an "Auto Cashout" multiplier. If the jet reaches this multiplier, your bet will automatically cash out.</li>
                    <li><strong>Auto Bet (Optional):</strong> Enable "Auto Bet" to automatically place your bet in subsequent rounds.</li>
                    <li><strong>Watch the Jet Fly:</strong> Once the round begins, the jet takes off, and the multiplier starts increasing from 1.00x.</li>
                    <li><strong>Cash Out:</strong> Click the "Cash Out" button at any time before the jet crashes to secure your winnings. Your winnings are calculated as: <strong>Bet Amount x Multiplier at Cashout</strong>.</li>
                    <li><strong>The Crash:</strong> If the jet crashes before you cash out, you lose your bet for that round.</li>
                    <li><strong>Winning & Losing:</strong>
                        <ul>
                            <li><strong>Win:</strong> You cash out successfully before the crash.</li>
                            <li><strong>Loss:</strong> The jet crashes before you cash out.</li>
                        </ul>
                    </li>
                    <li><strong>History:</strong> Check the "Crash History" for past multipliers and "My Bets" for your personal game history.</li>
                    <li><strong>Chat:</strong> Interact with other players in the live chat.</li>
                </ol>
                <p>Good luck and have fun flying with Prince Alex Jet!</p>
            </div>
            <div class="modal-footer">
                For more, call: <a href="tel:0717384875">0717384875</a>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 Prince Alex Jet. All rights reserved.</p>
        <p>For support, contact us at <a href="tel:0717384875">0717384875</a> or email <a href="mailto:support@princealexjet.com">support@princealexjet.com</a></p>
        <p><a href="#">Terms & Conditions</a> | <a href="#">Privacy Policy</a></p>
    </div>

    <!-- Floating WhatsApp Button -->
    <a href="https://wa.me/254717384875" target="_blank" class="whatsapp-button" title="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script>
        const { createClient } = supabase
        // IMPORTANT: Replace 'YOUR_SUPABASE_URL' and 'YOUR_SUPABASE_ANON_KEY' with your actual Supabase project details.
        // You can find these in your Supabase project settings under "API".
        // If you continue to get "invalid API" errors, double-check your Supabase project's
        // Row Level Security (RLS) policies and ensure they allow sign-ups and data inserts.
        const supabaseClient = createClient(
          'https://yigtwtapnqbpmnoeitpa.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpZ3R3dGFwbnFicG1ub2VpdHBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA4MTEsImV4cCI6MjA2ODY3NjgxMX0.rKF2MwO94wPeT2V0rDsypNcwjOk2wN9rMwmiYo79T2g'
        );
    </script>
    <script defer>
        // --- Graphing constants ---
        const PADDING_X = 50;
        const PADDING_Y = 50;
        const MAX_GAME_TICKS_X_SCALE = 200; // Max game ticks to show on X-axis (20 seconds at 100ms/tick)
        const Y_AXIS_BREAKPOINTS = [1.0, 2.0, 5.0, 10.0, 20.0, 50.0, 100.0, 200.0, 500.0, 1000.0];
        let dynamicMaxMultiplierY = 10.0; // Initial max Y-axis value for graph display

        // --- Starfield constants ---
        const STARS_COUNT = 100;
        const stars = [];

        // --- DOM Elements ---
        const gameCanvas = document.getElementById('game-canvas');
        const ctx = gameCanvas.getContext('2d');
        const confettiCanvas = document.getElementById('confetti-canvas'); // Confetti canvas
        const confettiCtx = confettiCanvas.getContext('2d'); // Confetti context
        const multiplierDisplayOverlay = document.getElementById('multiplier-display-overlay');
        const countdownTimerOverlay = document.getElementById('countdown-timer-overlay');
        const bustedTextOverlay = document.getElementById('busted-text-overlay');

        const betButton = document.getElementById('bet-button');
        const cashoutButton = document.getElementById('cashout-button');
        const betAmountInput = document.getElementById('bet-amount');
        const messageDisplay = document.getElementById('message-display'); // Main game message display
        const quickBetButtons = document.querySelectorAll('.quick-bet-button');
        const autoBetToggle = document.getElementById('auto-bet-toggle');
        const autoCashoutInput = document.getElementById('auto-cashout-input');
        
        const potentialWinDisplay = document.getElementById('potential-win-display'); 
        
        // Top Bar Elements
        const authButton = document.getElementById('auth-button'); 
        const topBarBalance = document.getElementById('top-bar-balance');
        const promoClickButton = document.getElementById('promo-click-button'); 
        const themeToggle = document.getElementById('theme-toggle'); // Theme toggle button
        
        // New Account Dropdown Elements
        const accountDropdown = document.getElementById('account-dropdown');
        const dropdownUserInfo = document.getElementById('dropdown-user-info');
        const dropdownDepositWithdraw = document.getElementById('dropdown-deposit-withdraw');
        const dropdownChangePassword = document.getElementById('dropdown-change-password');
        const dropdownHowToPlay = document.getElementById('dropdown-how-to-play');
        const dropdownLogout = document.getElementById('dropdown-logout');

        // Chat Elements
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInputField = document.getElementById('chat-input-field');
        const chatSendButton = document.getElementById('chat-send-button'); 

        // New Tab Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const onlineUsersCount = document.getElementById('online-users-count');
        const playingUsersCount = document.getElementById('playing-users-count');
        const playersTableBody = document.getElementById('players-table-body');
        const playerHistoryDisplayTab = document.getElementById('player-history-display-tab'); 
        const crashHistoryDisplay = document.getElementById('crash-history-display'); 
        const leaderboardMultiplierBody = document.getElementById('leaderboard-multiplier-body'); // Leaderboard elements
        const leaderboardWinningsBody = document.getElementById('leaderboard-winnings-body');

        // Modals
        const depositWithdrawModal = document.getElementById('depositWithdrawModal');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const passwordResetModal = document.getElementById('passwordResetModal'); 
        const changePasswordModal = document.getElementById('changePasswordModal');
        const howToPlayModal = document.getElementById('howToPlayModal');
        const allCloseModalButtons = document.querySelectorAll('.close-button'); 
        const loadingOverlay = document.getElementById('loading-overlay'); // Loading spinner overlay

        // Deposit/Withdraw Modal Elements
        const modalTabButtons = depositWithdrawModal.querySelectorAll('.modal-tab-button');
        const modalTabPanes = depositWithdrawModal.querySelectorAll('.modal-tab-pane');
        const modalBalance = document.getElementById('modal-balance');
        const modalWithdrawable = document.getElementById('modal-withdrawable');
        const modalBonus = document.getElementById('modal-bonus');
        const depositAmountInput = document.getElementById('deposit-amount');
        const topUpNowButton = document.getElementById('top-up-now-button');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const toDisburseSpan = document.getElementById('to-disburse');
        const withdrawNowButton = document.getElementById('withdraw-now-button');
        const mpesaCodeInput = document.getElementById('mpesa-code');
        const verifyMpesaButton = document.getElementById('verify-mpesa-button');

        // Login Modal Elements
        const loginMobileInput = document.getElementById('login-mobile');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const showSignupLink = document.getElementById('show-signup-link');
        const showPasswordResetLink = document.getElementById('show-password-reset-link'); 
        const loginMessageDisplay = document.getElementById('login-message-display'); 

        // Sign Up Modal Elements
        const signupMobileInput = document.getElementById('signup-mobile');
        const signupNicknameInput = document.getElementById('signup-nickname');
        const signupPasswordInput = document.getElementById('signup-password');
        const createAccountButton = document.getElementById('create-account-button');
        const showLoginLink = document.getElementById('show-login-link');
        const signupMessageDisplay = document.getElementById('signup-message-display'); 

        // Password Reset Modal Elements
        const resetMobileInput = document.getElementById('reset-mobile'); 
        const resetPasswordButton = document.getElementById('reset-password-button'); 
        const backToLoginLink = document.getElementById('back-to-login-link'); 
        const passwordResetMessageDisplay = document.getElementById('password-reset-message-display'); 

        // Change Password Modal Elements
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');
        const updatePasswordButton = document.getElementById('update-password-button');
        const changePasswordMessageDisplay = document.getElementById('change-password-message-display');


        // --- Game State ---
        let balance = 0;
        let betAmount = 10; 
        let multiplier = 1.00;
        let crashMultiplier = 1.00;
        let isGameRunning = false; 
        let hasCashedOut = false; 
        let gameLogicInterval = null; // Renamed to avoid confusion with animation loop
        let isAutoBetEnabled = false;
        let currentBetPlaced = 0; 
        let currentBetId = null;
        let roundCountdownInterval = null; 
        let preRoundTimer = 0; 
        const MAX_HISTORY_ITEMS = 10; // Max items to display in crash history

        let curvePoints = [{ x: 0, y: 0 }]; 
        let gameTicks = 0; 

        // Authentication State
        let isLoggedIn = false;
        let currentUserId = null;
        let currentUserNickname = null;

        // Provably Fair Seeds and Nonce
        let serverSeed = generateRandomString(32);
        const clientSeed = "player-alex";
        let nonce = 0;

        // Simulated Player Names
        const allPlayerNames = [
            "JulianaH123", "Josemwai", "Josephwainaina", "FunnyDiudi", "Cheche", "BlackHawk", "EatPeople", "Amanda",
            "BraveHeart", "LuckyCharm", "QuickCash", "GameMaster", "CryptoKing", "JetSetter", "HighRoller", "BetBoss",
            "WinStreak", "FlyHigh", "CashFlow", "AcePilot", "SkyWalker", "GoldenWings", "TopGun", "FastCash",
            "MoneyMaker", "RiskTaker", "FortuneHunter"
        ];
        
        // Simulated Player Data for "Players" tab
        const simulatedPlayers = []; 
        const NUM_SIMULATED_PLAYERS = 15; 

        let baseOnlineUsers = 90;
        let onlineUsersFluctuationInterval = null;

        // Airplane SVG path
        const airplanePath = new Path2D("M20 0 L0 10 L0 12 L8 12 L8 20 L10 20 L10 12 L18 12 L18 10 L20 0 Z"); 

        // Sound Effects
        let gameStartSynth, cashoutSynth, crashSynth;
        let isSoundInitialized = false;

        function initializeAudio() {
            if (isSoundInitialized) return;
            Tone.start();
            gameStartSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.2, release: 0.5 } }).toDestination();
            cashoutSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
            crashSynth = new Tone.NoiseSynth({ envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.3 } }).toDestination();
            isSoundInitialized = true;
            console.log("Audio context initialized.");
        }

        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function getCrashMultiplier() {
            nonce++;
            const hmac = CryptoJS.HmacSHA256(`${nonce}:${clientSeed}`, serverSeed).toString();
            const hex = hmac.substring(0, 13);
            const intVal = parseInt(hex, 16);
            const max13Hex = 0xFFFFFFFFFFFFF;
            let normalized = intVal / (max13Hex + 1);
            if (normalized >= 1) {
                normalized = 0.9999999999999999;
            }
            const crash = 100 / (100 - (normalized * 99));
            const bustCheckHex = hmac.substring(13, 14);
            const bustCheckInt = parseInt(bustCheckHex, 16);
            if (bustCheckInt % 100 < 1) {
                return 1.00;
            }
            return Math.max(1.00, parseFloat(crash.toFixed(2)));
        }

        async function loadUserData() {
            const { data: { user }, error } = await supabaseClient.auth.getUser();

            if (error || !user) return console.error("Not logged in");
            isLoggedIn = true;
            currentUserId = user.id;

            // Load Profile
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('nickname, phone')
                .eq('id', user.id)
                .single();
            
            currentUserNickname = profile?.nickname || 'Player';

            // Load Wallet
            let { data: wallet } = await supabaseClient
                .from('wallets')
                .select('*')
                .eq('user_id', user.id)
                .single();
            
            if (!wallet) {
                 const { data: newWallet } = await supabaseClient.from('wallets').insert({ user_id: user.id, balance: 1000, bonus: 100, withdrawable: 900 }).select().single();
                 wallet = newWallet;
            }
            
            balance = wallet?.balance || 0;

            // Update UI
            dropdownUserInfo.innerHTML = `${profile?.nickname || 'Player'}<br>${profile?.phone || ''}`;
            modalBalance.textContent = (wallet?.balance || 0).toFixed(2);
            modalWithdrawable.textContent = (wallet?.withdrawable || 0).toFixed(2);
            modalBonus.textContent = (wallet?.bonus || 0).toFixed(2);
            topBarBalance.style.display = 'inline';
            topBarBalance.textContent = `${(wallet?.balance || 0).toFixed(2)} KES`;
            updateAuthUI();
        }

        async function updateWalletAmount(amountChange, bonusChange = 0) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const { data: wallet } = await supabaseClient
                .from('wallets')
                .select('*')
                .eq('user_id', user.id)
                .single();

            const newBalance = (wallet?.balance || 0) + amountChange;
            const newBonus = (wallet?.bonus || 0) + bonusChange;
            const newWithdrawable = newBalance - newBonus;

            await supabaseClient
                .from('wallets')
                .update({
                balance: newBalance,
                bonus: newBonus,
                withdrawable: newWithdrawable,
                updated_at: new Date()
                })
                .eq('user_id', user.id);
            
            balance = newBalance;
        }

        async function placeBet(betAmount, autoCashoutAt) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                showMessage("Please log in to place a bet.", "var(--danger-color)");
                return;
            }

            const { data, error } = await supabaseClient.from('bets').insert({
                user_id: user.id,
                bet_amount: betAmount,
                result_status: 'pending',
                cashout_at: autoCashoutAt
            }).select().single();

            if (!error && data) {
                currentBetId = data.id;
                await updateWalletAmount(-betAmount);
                console.log("Bet placed!");
                await loadUserData();
            } else {
                console.error(error?.message || "Error placing bet");
                showMessage(error?.message || "Error placing bet. Please try again.", "var(--danger-color)");
            }
        }
        
        async function resolveBet(betId, resultStatus, multiplier) {
            const { data: bet } = await supabaseClient.from('bets').select('*').eq('id', betId).single();
            if (!bet) return;
            const payout = resultStatus === 'won' ? bet.bet_amount * multiplier : 0;

            await supabaseClient
                .from('bets')
                .update({ result_status: resultStatus, multiplier, payout: payout })
                .eq('id', betId);

            if (payout > 0) {
                await updateWalletAmount(payout);
            }
            await loadUserData();
        }

        async function loadMyBetHistory() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const { data: bets } = await supabaseClient
                .from('bets')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .limit(10);

            const playerHistoryContainer = document.getElementById('player-history-display-tab');
            // Clear old rows, keeping the header
            while (playerHistoryContainer.children.length > 1) {
                playerHistoryContainer.removeChild(playerHistoryContainer.lastChild);
            }

            bets?.forEach((bet) => {
                const row = document.createElement('div');
                row.classList.add('history-item');
                row.innerHTML = `
                <span class="ticket-id">${bet.id.slice(0, 6)}</span>
                <span class="bet-amount">${bet.bet_amount.toFixed(2)}</span>
                <span class="multiplier-info">${bet.multiplier ? bet.multiplier.toFixed(2) + 'x' : '-'}</span>
                <span class="status ${bet.result_status === 'won' ? 'status-win' : 'status-loss'}">${bet.result_status}</span>
                `;
                playerHistoryContainer.appendChild(row);
            });
        }

        function updateAuthUI() {
            if (isLoggedIn) {
                authButton.textContent = 'Account';
                authButton.onclick = () => accountDropdown.classList.toggle('show');
                topBarBalance.style.display = 'inline-block';
                topBarBalance.textContent = `${balance.toFixed(2)} KES`;
                betButton.disabled = false;
                betButton.textContent = 'Bet [Next Game]';
                betButton.style.backgroundColor = 'var(--success-color)';
                betAmountInput.disabled = false;
                quickBetButtons.forEach(btn => btn.disabled = false);
                autoCashoutInput.disabled = false;
                autoBetToggle.disabled = false;
                if (isAutoBetEnabled) {
                    betButton.disabled = true;
                    betButton.textContent = 'Auto Bet Active';
                    betAmountInput.disabled = true;
                    quickBetButtons.forEach(btn => btn.disabled = true);
                }
                messageDisplay.textContent = 'Place your bet to start the round!';
            } else {
                authButton.textContent = 'Login / Sign Up';
                authButton.onclick = () => showModal(loginModal);
                topBarBalance.style.display = 'none';
                accountDropdown.classList.remove('show');
                betButton.disabled = true;
                betButton.textContent = 'Login to Bet';
                betAmountInput.disabled = true;
                quickBetButtons.forEach(btn => btn.disabled = true);
                cashoutButton.disabled = true;
                autoCashoutInput.disabled = true;
                autoBetToggle.disabled = true;
                messageDisplay.textContent = 'Login to place your bet!';
            }
        }

        function multToY(mult) {
            const graphHeight = gameCanvas.height - 2 * PADDING_Y;
            const scaledMult = Math.max(1, mult);
            // Ensure the denominator is not zero or negative for multipliers less than 1
            const effectiveMaxMultiplierY = dynamicMaxMultiplierY > 1 ? dynamicMaxMultiplierY : 1.01;
            return gameCanvas.height - PADDING_Y - ((scaledMult - 1) / (effectiveMaxMultiplierY - 1)) * graphHeight;
        }

        function ticksToX(ticks) {
            const graphWidth = gameCanvas.width - 2 * PADDING_X;
            return PADDING_X + (ticks / MAX_GAME_TICKS_X_SCALE) * graphWidth;
        }

        function initStars() {
            stars.length = 0;
            for (let i = 0; i < STARS_COUNT; i++) {
                stars.push({
                    x: Math.random() * gameCanvas.width,
                    y: Math.random() * gameCanvas.height,
                    radius: Math.random() * 1.5 + 0.5,
                    alpha: Math.random() * 0.5 + 0.5
                });
            }
        }

        function drawGraph() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
            });

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.font = '14px var(--font-family-body)';
            ctx.fillStyle = 'var(--text-color)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Draw X-axis (time)
            ctx.beginPath();
            ctx.moveTo(PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.lineTo(gameCanvas.width - PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.stroke();

            // Draw Y-axis (multiplier)
            ctx.beginPath();
            ctx.moveTo(PADDING_X, PADDING_Y);
            ctx.lineTo(PADDING_X, gameCanvas.height - PADDING_Y);
            ctx.stroke();

            // Draw X-axis labels and grid lines
            for (let i = 0; i <= 8; i += 2) {
                const x = ticksToX(i * (MAX_GAME_TICKS_X_SCALE / 8));
                ctx.fillText(i + 's', x, gameCanvas.height - PADDING_Y / 2); // Label in seconds
                ctx.beginPath();
                ctx.moveTo(x, gameCanvas.height - PADDING_Y);
                ctx.lineTo(x, PADDING_Y);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.stroke();
            }

            // Draw Y-axis labels and grid lines
            let labelStep = 1;
            if (dynamicMaxMultiplierY >= 100) labelStep = 100;
            else if (dynamicMaxMultiplierY >= 50) labelStep = 10;
            else if (dynamicMaxMultiplierY >= 20) labelStep = 5;
            else if (dynamicMaxMultiplierY >= 5) labelStep = 1;
            else labelStep = 0.5;

            for (let i = 1; i <= dynamicMaxMultiplierY; i += labelStep) {
                const mult = parseFloat(i.toFixed(1));
                const y = multToY(mult);
                if (y >= PADDING_Y && y <= gameCanvas.height - PADDING_Y) {
                    ctx.fillText(`${mult.toFixed(1)}x`, PADDING_X / 2, y);
                    ctx.beginPath();
                    ctx.moveTo(PADDING_X, y);
                    ctx.lineTo(gameCanvas.width - PADDING_X, y);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.stroke();
                }
            }

            // Draw graph fill (area under the curve)
            if (curvePoints.length > 1) {
                ctx.beginPath();
                ctx.moveTo(PADDING_X, gameCanvas.height - PADDING_Y); // Start at bottom-left of graph area
                curvePoints.forEach(point => ctx.lineTo(point.x, point.y));
                const lastPoint = curvePoints[curvePoints.length - 1];
                ctx.lineTo(lastPoint.x, gameCanvas.height - PADDING_Y); // Go down to X-axis
                ctx.closePath();
                const gradient = ctx.createLinearGradient(0, PADDING_Y, 0, gameCanvas.height - PADDING_Y);
                gradient.addColorStop(0, varToRgba('--graph-fill-color-top'));
                gradient.addColorStop(1, varToRgba('--graph-fill-color-bottom'));
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            // Draw graph line (re-added)
            if (curvePoints.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = varToRgba('--graph-line-color'); // Use the red color for the line
                ctx.lineWidth = 3;
                ctx.moveTo(curvePoints[0].x, curvePoints[0].y);
                for (let i = 1; i < curvePoints.length; i++) {
                    ctx.lineTo(curvePoints[i].x, curvePoints[i].y);
                }
                ctx.stroke();
            }

            // Draw airplane at the end of the line
            if (isGameRunning && curvePoints.length > 1) {
                const lastPoint = curvePoints[curvePoints.length - 1];
                const prevPoint = curvePoints[curvePoints.length - 2] || curvePoints[0];
                const angle = Math.atan2(lastPoint.y - prevPoint.y, lastPoint.x - prevPoint.x);
                ctx.save();
                ctx.translate(lastPoint.x, lastPoint.y);
                ctx.rotate(angle);
                ctx.fillStyle = 'white';
                ctx.scale(0.8, 0.8);
                ctx.fill(airplanePath);
                ctx.restore();
            }
            ctx.font = '12px var(--font-family-body)';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Connection: ON', PADDING_X, gameCanvas.height - 10);
        }

        function varToRgba(cssVar) {
            const style = getComputedStyle(document.documentElement);
            return style.getPropertyValue(cssVar).trim();
        }

        function initializeUIForPreRound() {
            topBarBalance.textContent = `${balance.toFixed(2)} KES`; 
            betAmountInput.value = betAmount;
            cashoutButton.disabled = true;
            potentialWinDisplay.textContent = '0.00';
            
            if (isLoggedIn) {
                betButton.disabled = false;
                betButton.textContent = 'Bet [Next Game]';
                betButton.style.backgroundColor = 'var(--success-color)';
                betAmountInput.disabled = false;
                quickBetButtons.forEach(btn => btn.disabled = false);
                autoCashoutInput.disabled = false;
                autoBetToggle.disabled = false;
                if (isAutoBetEnabled) {
                    betButton.disabled = true;
                    betButton.textContent = 'Auto Bet Active';
                    betAmountInput.disabled = true;
                    quickBetButtons.forEach(btn => btn.disabled = true);
                }
                messageDisplay.textContent = 'Place your bet to start the round!';
            } else {
                betButton.disabled = true;
                betButton.textContent = 'Login to Bet';
                betAmountInput.disabled = true;
                quickBetButtons.forEach(btn => btn.disabled = true);
                autoCashoutInput.disabled = true;
                autoBetToggle.disabled = true;
                messageDisplay.textContent = 'Login to place your bet!';
            }

            resetAnimation();
            currentBetPlaced = 0;
            currentBetId = null;
            countdownTimerOverlay.style.display = 'block';
            multiplierDisplayOverlay.style.display = 'none';
            bustedTextOverlay.style.display = 'none';

            simulatedPlayers.length = 0;
            const usedNames = new Set();
            while (simulatedPlayers.length < NUM_SIMULATED_PLAYERS) {
                const randomName = allPlayerNames[Math.floor(Math.random() * allPlayerNames.length)];
                if (!usedNames.has(randomName)) {
                    usedNames.add(randomName);
                    const randomBet = Math.floor(Math.random() * (3000 - 50 + 1)) + 50; 
                    simulatedPlayers.push({
                        id: crypto.randomUUID(),
                        name: randomName,
                        bet: randomBet,
                        cashout: null,
                        won: null,
                        status: 'playing',
                        cashoutTarget: null
                    });
                }
            }
            updatePlayersTable();
            updateOnlineAndPlayingCounts();
        }

        function startPreRoundCountdown() {
            initializeUIForPreRound();
            isGameRunning = false;

            preRoundTimer = 10;
            countdownTimerOverlay.textContent = preRoundTimer;
            showMessage(`Next round starts in ${preRoundTimer} seconds. Place your bets!`);

            if (roundCountdownInterval) clearInterval(roundCountdownInterval);

            roundCountdownInterval = setInterval(() => {
                preRoundTimer--;
                countdownTimerOverlay.textContent = preRoundTimer;
                if (preRoundTimer > 0) {
                    showMessage(`Next round starts in ${preRoundTimer} seconds. Place your bets!`);
                } else {
                    clearInterval(roundCountdownInterval);
                    lockBetsAndStartRound();
                }
            }, 1000);

            if (isAutoBetEnabled && isLoggedIn) {
                setTimeout(async () => {
                    if (currentBetPlaced === 0) {
                        const autoBet = parseFloat(betAmountInput.value);
                        if (autoBet > 0 && autoBet <= balance) {
                            await placeBet(autoBet, parseFloat(autoCashoutInput.value));
                            betButton.disabled = true;
                            betButton.textContent = 'Bet Placed';
                            betAmountInput.disabled = true;
                            quickBetButtons.forEach(btn => btn.disabled = true);
                        } else {
                            showMessage("Auto-bet: Insufficient balance or invalid bet. Auto-bet paused.", "var(--danger-color)");
                            isAutoBetEnabled = false;
                            autoBetToggle.checked = false;
                        }
                    }
                }, 1000);
            }
        }

        function lockBetsAndStartRound() {
            countdownTimerOverlay.style.display = 'none';
            multiplierDisplayOverlay.style.display = 'block';
            if (isSoundInitialized) gameStartSynth.triggerAttackRelease("C4", "8n");

            betButton.disabled = true;
            betButton.textContent = 'Bets Locked';
            betAmountInput.disabled = true;
            quickBetButtons.forEach(btn => btn.disabled = true);
            autoCashoutInput.disabled = true;
            autoBetToggle.disabled = true;

            crashMultiplier = getCrashMultiplier();
            console.log("Calculated Crash Multiplier:", crashMultiplier);

            isGameRunning = true;
            if (currentBetId) {
                hasCashedOut = false;
                cashoutButton.disabled = false;
            } else {
                hasCashedOut = true;
                cashoutButton.disabled = true;
            }
            
            showMessage(`Round started! Jet is flying...`, 'var(--secondary-color)');
            gameLogicInterval = setInterval(gameLoop, 100); // Changed to gameLogicInterval
        }

        function gameLoop() {
            if (!isGameRunning) return;

            multiplier += 0.01 + (multiplier * 0.01);
            multiplierDisplayOverlay.textContent = `${multiplier.toFixed(2)}x`;

            if (currentBetId && !hasCashedOut) {
                potentialWinDisplay.textContent = (currentBetPlaced * multiplier).toFixed(2);
            }

            const autoCashoutValue = parseFloat(autoCashoutInput.value);
            if (isAutoBetEnabled && currentBetId && multiplier >= autoCashoutValue && !hasCashedOut) {
                cashOut();
            }

            simulatedPlayers.forEach(player => {
                if (player.status === 'playing') {
                    player.status = 'busted'; // Default to busted if not cashed out
                    if (player.cashoutTarget && multiplier >= player.cashoutTarget && player.cashout === null) {
                        player.cashout = multiplier;
                        player.won = player.bet * player.cashout;
                        player.status = 'cashed out';
                    }
                }
            });
            updatePlayersTable();

            if (multiplier > dynamicMaxMultiplierY * 0.8) { 
                let nextMax = Y_AXIS_BREAKPOINTS.find(bp => bp > dynamicMaxMultiplierY);
                dynamicMaxMultiplierY = nextMax || dynamicMaxMultiplierY * 2;
            }

            gameTicks++;
            // Only add point if it's within the visible X range
            const currentX = ticksToX(gameTicks);
            if (currentX <= gameCanvas.width - PADDING_X) {
                curvePoints.push({ x: currentX, y: multToY(multiplier) });
            } else {
                // If we go beyond the X-axis, shift the graph
                const shiftAmount = currentX - (gameCanvas.width - PADDING_X);
                curvePoints = curvePoints.map(p => ({ x: p.x - shiftAmount, y: p.y }));
                // Also update the starting point to maintain relative position
                curvePoints[0].x = PADDING_X; // Reset the origin if it shifts too far
            }

            if (multiplier >= crashMultiplier) {
                crash();
            }
        }

        // Main animation loop for drawing
        function animate() {
            drawGraph();
            requestAnimationFrame(animate);
        }

        async function cashOut() {
            if (!isGameRunning || hasCashedOut || !currentBetId) return; 

            hasCashedOut = true;
            await resolveBet(currentBetId, 'won', multiplier);
            
            cashoutButton.disabled = true; 
            potentialWinDisplay.textContent = '0.00'; 

            const winAmount = currentBetPlaced * multiplier;
            showMessage(`Cashed out at ${multiplier.toFixed(2)}x! You won ${winAmount.toFixed(2)}`, 'var(--success-color)');
            if (isSoundInitialized) cashoutSynth.triggerAttackRelease("E5", "8n");

            if (multiplier >= 10) {
                startConfetti();
            }
        }

        async function crash() {
            clearInterval(gameLogicInterval); // Clear game logic interval
            isGameRunning = false;
            
            bustedTextOverlay.textContent = `Busted @ ${multiplier.toFixed(2)}x`;
            bustedTextOverlay.style.display = 'block';
            multiplierDisplayOverlay.style.display = 'none'; 
            potentialWinDisplay.textContent = '0.00'; 
            if (isSoundInitialized) crashSynth.triggerAttackRelease("8n");
            
            if (currentBetId && !hasCashedOut) {
                await resolveBet(currentBetId, 'lost', multiplier);
                showMessage(`Crashed at ${multiplier.toFixed(2)}x! You lost your bet.`, 'var(--danger-color)');
            } else if (currentBetId && hasCashedOut) {
                 showMessage(`The jet flew to ${multiplier.toFixed(2)}x.`, 'var(--secondary-color)');
            } else {
                 showMessage(`The jet flew to ${multiplier.toFixed(2)}x.`, 'var(--secondary-color)');
            }

            // Save crash multiplier to Supabase
            const { error: insertError } = await supabaseClient.from('game_rounds').insert({ crash_multiplier: multiplier });
            if (insertError) {
                console.error("Error saving crash multiplier to Supabase:", insertError.message);
            }
            
            await updateCrashHistoryDisplay(); // Fetch and display from Supabase

            cashoutButton.disabled = true; 

            simulatedPlayers.forEach(player => {
                if (player.status === 'playing') {
                    player.status = 'busted';
                }
            });
            updatePlayersTable();

            const delay = 3000 + Math.random() * 2000; 
            showMessage(`Next round in ${Math.round(delay/1000)} seconds...`, 'white');
            setTimeout(startPreRoundCountdown, delay);
        }

        function resetAnimation() {
            multiplier = 1.00;
            gameTicks = 0;
            curvePoints = [{ x: ticksToX(0), y: multToY(1.00) }]; 
            dynamicMaxMultiplierY = 10.0; 
            drawGraph(); 
            multiplierDisplayOverlay.textContent = '1.00x';
            bustedTextOverlay.style.display = 'none'; 
        }

        function showMessage(text, color = 'white', targetElement = messageDisplay) {
            targetElement.innerHTML = text;
            targetElement.style.color = color;
        }

        // Modified to fetch from Supabase
        async function updateCrashHistoryDisplay() {
            const { data, error } = await supabaseClient
                .from('game_rounds')
                .select('crash_multiplier')
                .order('created_at', { ascending: false })
                .limit(MAX_HISTORY_ITEMS);

            if (error) {
                console.error("Error fetching crash history from Supabase:", error.message);
                return;
            }

            crashHistoryDisplay.innerHTML = ''; 
            data.forEach(item => {
                const span = document.createElement('span');
                span.textContent = `${item.crash_multiplier.toFixed(2)}x`;
                if (item.crash_multiplier < 2) span.className = 'crash-red';
                else if (item.crash_multiplier < 10) span.className = 'crash-green';
                else span.className = 'crash-purple';
                crashHistoryDisplay.appendChild(span);
            });
        }

        function updatePlayersTable() {
            playersTableBody.innerHTML = ''; 
            simulatedPlayers.forEach(player => {
                const row = document.createElement('tr');
                if (isLoggedIn && player.id === currentUserId) {
                    row.classList.add('highlighted-player');
                }
                row.innerHTML = `
                    <td><span class="player-avatar">${player.name.substring(0, 2).toUpperCase()}</span> ${player.name}</td>
                    <td class="amount-cell">${player.bet.toFixed(2)}</td>
                    <td class="cashout-cell ${player.status === 'cashed out' ? 'cashed-out' : player.status === 'busted' ? 'busted' : ''}">${player.cashout ? player.cashout.toFixed(2) + 'x' : '-'}</td>
                    <td class="won-cell">${player.won ? player.won.toFixed(2) : '-'}</td>
                `;
                playersTableBody.appendChild(row);
            });
        }

        function updateLeaderboardDisplay() {
            // This can be further enhanced with Supabase data
        }

        function addChatMessage(username, message) {
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const p = document.createElement('p');
            p.classList.add('chat-message');
            p.innerHTML = `<span>${time}</span> ${username}: ${message}`;
            chatMessagesDiv.appendChild(p);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function showModal(modalElement) {
            modalElement.style.display = 'flex';
            setTimeout(() => modalElement.classList.add('show'), 10);
            document.body.classList.add('modal-open');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('show');
            setTimeout(() => {
                modalElement.style.display = 'none';
                document.body.classList.remove('modal-open');
            }, 300);
        }

        function showSpinner() { loadingOverlay.style.display = 'flex'; }
        function hideSpinner() { loadingOverlay.style.display = 'none'; }

        // --- Event Listeners ---
        betButton.addEventListener('click', async () => {
            const betAmount = parseFloat(betAmountInput.value);
            const autoCashout = parseFloat(autoCashoutInput.value);

            if (isNaN(betAmount) || betAmount <= 0) return showMessage("Invalid bet amount. Please enter a positive number.", "var(--danger-color)");
            if (isNaN(autoCashout) || autoCashout < 1.01) return showMessage("Invalid auto cashout. Must be 1.01 or higher.", "var(--danger-color)");
            if (betAmount > balance) return showMessage("Insufficient balance to place this bet.", "var(--danger-color)");

            currentBetPlaced = betAmount;
            await placeBet(betAmount, autoCashout);
        });

        loginButton.addEventListener('click', async () => {
            const phone = loginMobileInput.value.trim();
            const password = loginPasswordInput.value.trim();
            showSpinner();
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: phone + '@princealexjet.com',
                password: password
            });
            hideSpinner();

            if (error) {
                loginMessageDisplay.textContent = error.message;
                loginMobileInput.classList.add('input-error');
                loginPasswordInput.classList.add('input-error');
            } else {
                loginMessageDisplay.textContent = 'Login successful!';
                loginMobileInput.classList.remove('input-error');
                loginPasswordInput.classList.remove('input-error');
                hideModal(loginModal);
            }
        });

        createAccountButton.addEventListener('click', async () => {
            const phone = signupMobileInput.value.trim();
            const password = signupPasswordInput.value.trim();
            const nickname = signupNicknameInput.value.trim();

            // Basic validation
            if (phone.length < 8 || !/^\d+$/.test(phone)) {
                signupMessageDisplay.textContent = "Please enter a valid mobile number (digits only, at least 8 digits).";
                signupMobileInput.classList.add('input-error');
                return;
            }
            if (password.length < 6) { // Supabase default minimum password length
                signupMessageDisplay.textContent = "Password must be at least 6 characters long.";
                signupPasswordInput.classList.add('input-error');
                return;
            }
            if (nickname.length < 3) {
                signupMessageDisplay.textContent = "Nickname must be at least 3 characters long.";
                signupNicknameInput.classList.add('input-error');
                return;
            }

            signupMobileInput.classList.remove('input-error');
            signupPasswordInput.classList.remove('input-error');
            signupNicknameInput.classList.remove('input-error');

            showSpinner();
            const { data, error } = await supabaseClient.auth.signUp({
                email: phone + '@princealexjet.com',
                password: password,
                options: { data: { nickname: nickname } }
            });
            hideSpinner();

            if (error) {
                signupMessageDisplay.textContent = error.message;
                // Add error class to relevant input based on error type if possible
                if (error.message.includes('User already registered')) {
                    signupMobileInput.classList.add('input-error');
                }
            } else if (data.user) {
                await supabaseClient.from('wallets').insert({ user_id: data.user.id, balance: 0, bonus: 0, withdrawable: 0 });
                await supabaseClient.from('profiles').insert({ id: data.user.id, phone: phone, nickname: nickname });
                signupMessageDisplay.textContent = 'Account created successfully! Please log in.';
                hideModal(signupModal);
                showModal(loginModal);
            }
        });

        topUpNowButton.addEventListener('click', async () => {
            const amount = parseFloat(depositAmountInput.value);
            if (isNaN(amount) || amount < 10) {
                showMessage("Minimum deposit is 10 KES.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
                depositAmountInput.classList.add('input-error');
                return;
            }
            depositAmountInput.classList.remove('input-error');
            showSpinner();
            await updateWalletAmount(amount);
            await loadUserData();
            hideSpinner();
            showMessage(`Successfully deposited ${amount.toFixed(2)} KES.`, "var(--success-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
        });

        withdrawNowButton.addEventListener('click', async () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const fee = 5;
            const total = amount + fee;
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { data: wallet } = await supabaseClient.from('wallets').select('*').eq('user_id', user.id).single();

            if (isNaN(amount) || amount < 100) {
                showMessage("Minimum withdrawal is 100 KES.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
                withdrawAmountInput.classList.add('input-error');
                return;
            }
            withdrawAmountInput.classList.remove('input-error');

            if ((wallet?.withdrawable || 0) >= total) {
                showSpinner();
                await updateWalletAmount(-total);
                await supabaseClient.from('transactions').insert({ user_id: user.id, type: 'withdraw', amount: amount, status: 'pending' });
                await loadUserData();
                hideSpinner();
                showMessage("Withdrawal requested! Please allow time for processing.", "var(--success-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
            } else {
                showMessage("Insufficient withdrawable balance.", "var(--danger-color)", depositWithdrawModal.querySelector('.modal-message-display') || messageDisplay);
            }
        });
        
        // Update toDisburseSpan on withdraw amount input change
        withdrawAmountInput.addEventListener('input', () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const fee = 5;
            if (!isNaN(amount) && amount >= 0) {
                toDisburseSpan.textContent = (amount - fee).toFixed(2);
            } else {
                toDisburseSpan.textContent = '0.00';
            }
        });

        document.querySelector('[data-tab="my-bets"]').addEventListener('click', loadMyBetHistory);
        dropdownLogout.addEventListener('click', async () => { 
            showSpinner();
            await supabaseClient.auth.signOut(); 
            hideSpinner();
        });

        allCloseModalButtons.forEach(button => button.addEventListener('click', (e) => hideModal(document.getElementById(e.target.dataset.modalClose))));
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(loginModal); showModal(signupModal); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(signupModal); showModal(loginModal); });
        dropdownDepositWithdraw.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(depositWithdrawModal); });
        dropdownHowToPlay.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(howToPlayModal); });
        dropdownChangePassword.addEventListener('click', (e) => { e.preventDefault(); accountDropdown.classList.remove('show'); showModal(changePasswordModal); });
        showPasswordResetLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(loginModal); showModal(passwordResetModal); });
        backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); hideModal(passwordResetModal); showModal(loginModal); });

        // Password Reset Logic
        resetPasswordButton.addEventListener('click', async () => {
            const mobile = resetMobileInput.value.trim();
            if (!mobile) {
                passwordResetMessageDisplay.textContent = "Please enter your mobile number.";
                resetMobileInput.classList.add('input-error');
                return;
            }
            resetMobileInput.classList.remove('input-error');
            showSpinner();
            const { error } = await supabaseClient.auth.resetPasswordForEmail(mobile + '@princealexjet.com');
            hideSpinner();
            if (error) {
                passwordResetMessageDisplay.textContent = error.message;
            } else {
                passwordResetMessageDisplay.textContent = "Password reset link sent to your mobile number (via email). Please check your email.";
            }
        });

        // Change Password Logic
        updatePasswordButton.addEventListener('click', async () => {
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (newPassword.length < 6) {
                changePasswordMessageDisplay.textContent = "New password must be at least 6 characters long.";
                newPasswordInput.classList.add('input-error');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                changePasswordMessageDisplay.textContent = "New passwords do not match.";
                newPasswordInput.classList.add('input-error');
                confirmNewPasswordInput.classList.add('input-error');
                return;
            }
            
            newPasswordInput.classList.remove('input-error');
            confirmNewPasswordInput.classList.remove('input-error');

            showSpinner();
            // Supabase doesn't directly support changing password with current password in client-side auth
            // The standard flow is to send a reset email. For this simulation, we'll simplify.
            // In a real app, you'd typically verify current password on your backend or use a reset flow.
            // For now, we'll just update the user's password directly assuming the user is logged in.
            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            hideSpinner();

            if (error) {
                changePasswordMessageDisplay.textContent = error.message;
            } else {
                changePasswordMessageDisplay.textContent = "Password updated successfully!";
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                // Optionally hide modal after success
                setTimeout(() => hideModal(changePasswordModal), 2000);
            }
        });


        // --- Initial Load ---
        window.onload = () => {
            gameCanvas.width = gameCanvas.clientWidth;
            gameCanvas.height = gameCanvas.clientHeight;
            confettiCanvas.width = confettiCanvas.clientWidth;
            confettiCanvas.height = confettiCanvas.clientHeight;
            
            initStars(); 
            updateAuthUI();
            startOnlineUsersFluctuation();
            startPreRoundCountdown();
            document.body.addEventListener('click', initializeAudio, { once: true });

            // Start the continuous animation loop
            animate();
        };

        window.addEventListener('resize', () => {
            gameCanvas.width = gameCanvas.clientWidth;
            gameCanvas.height = gameCanvas.clientHeight;
            confettiCanvas.width = confettiCanvas.clientWidth;
            confettiCanvas.height = confettiCanvas.clientHeight;
            initStars();
            // No need to call drawGraph directly here, animate() will handle it
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                loadUserData();
            } else if (event === 'SIGNED_OUT') {
                window.location.reload();
            }
        });

        // Online Users Fluctuation
        function startOnlineUsersFluctuation() {
            onlineUsersFluctuationInterval = setInterval(() => {
                const fluctuation = Math.floor(Math.random() * 11) - 5; // -5 to +5
                let newOnlineUsers = baseOnlineUsers + fluctuation;
                if (newOnlineUsers < 50) newOnlineUsers = 50; // Minimum online users
                onlineUsersCount.textContent = newOnlineUsers;

                // Simulate playing users as a percentage of online users
                const playingPercentage = Math.random() * (0.4 - 0.2) + 0.2; // 20% to 40%
                playingUsersCount.textContent = Math.floor(newOnlineUsers * playingPercentage);
            }, 5000); // Update every 5 seconds
        }

        function updateOnlineAndPlayingCounts() {
            // Initial update
            onlineUsersCount.textContent = baseOnlineUsers;
            playingUsersCount.textContent = Math.floor(baseOnlineUsers * (Math.random() * (0.4 - 0.2) + 0.2));
        }

        // Confetti effect (simple example)
        let confetti = [];
        const MAX_CONFETTI = 100;

        function randomColor() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function createConfettiPiece(x, y) {
            return {
                x: x,
                y: y,
                size: Math.random() * 8 + 5,
                color: randomColor(),
                velX: (Math.random() - 0.5) * 10,
                velY: (Math.random() - 1) * 10,
                alpha: 1,
                gravity: 0.5,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5
            };
        }

        function updateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            for (let i = confetti.length - 1; i >= 0; i--) {
                let p = confetti[i];
                p.velY += p.gravity;
                p.x += p.velX;
                p.y += p.velY;
                p.alpha -= 0.01;
                p.rotation += p.rotationSpeed;

                if (p.alpha <= 0 || p.y > confettiCanvas.height) {
                    confetti.splice(i, 1);
                }

                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.rotation * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.globalAlpha = p.alpha;
                confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                confettiCtx.restore();
            }
            if (confetti.length > 0) {
                requestAnimationFrame(updateConfetti);
            }
        }

        function startConfetti() {
            confetti = []; // Clear existing confetti
            const centerX = confettiCanvas.width / 2;
            const centerY = confettiCanvas.height / 2;
            for (let i = 0; i < MAX_CONFETTI; i++) {
                confetti.push(createConfettiPiece(centerX, centerY));
            }
            updateConfetti(); // Start the confetti animation loop
        }

    </script>
</body>
</html>
